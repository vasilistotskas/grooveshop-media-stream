{"version":3,"sources":["../../../../../src/MediaStream/Correlation/middleware/timing.middleware.ts"],"sourcesContent":["import type { NestMiddleware } from '@nestjs/common'\r\nimport type { NextFunction, Request, Response } from 'express'\r\nimport * as process from 'node:process'\r\nimport { Injectable } from '@nestjs/common'\r\nimport { CorrelationService } from '../services/correlation.service'\r\nimport { CorrelatedLogger } from '../utils/logger.util'\r\nimport { PerformanceTracker } from '../utils/performance-tracker.util'\r\n\r\n@Injectable()\r\nexport class TimingMiddleware implements NestMiddleware {\r\n\tconstructor(private readonly _correlationService: CorrelationService) {}\r\n\r\n\tuse(req: Request, res: Response, next: NextFunction): void {\r\n\t\tconst startTime = process.hrtime.bigint()\r\n\t\tconst startTimestamp = Date.now()\r\n\r\n\t\tres.setHeader('x-request-start', startTimestamp.toString())\r\n\r\n\t\tconst originalEnd = res.end.bind(res)\r\n\t\tconst correlationService = this._correlationService\r\n\t\tres.end = function (chunk?: any, encoding?: any, cb?: any): Response {\r\n\t\t\tconst endTime = process.hrtime.bigint()\r\n\t\t\tconst endTimestamp = Date.now()\r\n\t\t\tconst duration = Number(endTime - startTime) / 1_000_000\r\n\r\n\t\t\tif (!res.headersSent) {\r\n\t\t\t\tres.setHeader('x-response-time', `${duration.toFixed(2)}ms`)\r\n\t\t\t\tres.setHeader('x-request-end', endTimestamp.toString())\r\n\t\t\t}\r\n\r\n\t\t\tcorrelationService.updateContext({\r\n\t\t\t\tstartTime,\r\n\t\t\t\tendTime,\r\n\t\t\t\tduration,\r\n\t\t\t\tstartTimestamp,\r\n\t\t\t\tendTimestamp,\r\n\t\t\t})\r\n\r\n\t\t\tconst context = correlationService.getContext()\r\n\t\t\tif (context) {\r\n\t\t\t\tconst logLevel = TimingMiddleware.prototype.getLogLevel(duration, res.statusCode)\r\n\t\t\t\tconst message = `${req.method} ${req.url} - ${res.statusCode} - ${duration.toFixed(2)}ms`\r\n\r\n\t\t\t\tif (logLevel === 'warn') {\r\n\t\t\t\t\tCorrelatedLogger.warn(`SLOW REQUEST: ${message}`, TimingMiddleware.name)\r\n\t\t\t\t}\r\n\t\t\t\telse if (logLevel === 'error') {\r\n\t\t\t\t\tCorrelatedLogger.error(`FAILED REQUEST: ${message}`, '', TimingMiddleware.name)\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tCorrelatedLogger.debug(message, TimingMiddleware.name)\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (duration > 1000) {\r\n\t\t\t\t\tCorrelatedLogger.warn(\r\n\t\t\t\t\t\t`Performance Alert: Request took ${duration.toFixed(2)}ms - consider optimization`,\r\n\t\t\t\t\t\tTimingMiddleware.name,\r\n\t\t\t\t\t)\r\n\t\t\t\t}\r\n\r\n\t\t\t\tPerformanceTracker.logSummary()\r\n\t\t\t}\r\n\r\n\t\t\treturn originalEnd(chunk, encoding, cb)\r\n\t\t} as any\r\n\r\n\t\tnext()\r\n\t}\r\n\r\n\t/**\r\n\t * Determine appropriate log level based on response time and status code\r\n\t */\r\n\tprivate getLogLevel(duration: number, statusCode: number): 'debug' | 'warn' | 'error' {\r\n\t\tif (statusCode >= 500) {\r\n\t\t\treturn 'error'\r\n\t\t}\r\n\t\tif (statusCode >= 400 || duration > 2000) {\r\n\t\t\treturn 'warn'\r\n\t\t}\r\n\t\treturn 'debug'\r\n\t}\r\n}\r\n"],"names":["process","Injectable","CorrelationService","CorrelatedLogger","PerformanceTracker","TimingMiddleware","use","req","res","next","startTime","hrtime","bigint","startTimestamp","Date","now","setHeader","toString","originalEnd","end","bind","correlationService","_correlationService","chunk","encoding","cb","endTime","endTimestamp","duration","Number","headersSent","toFixed","updateContext","context","getContext","logLevel","prototype","getLogLevel","statusCode","message","method","url","warn","name","error","debug","logSummary"],"mappings":";;;;;;;;;AAEA,YAAYA,aAAa,eAAc;AACvC,SAASC,UAAU,QAAQ,iBAAgB;AAC3C,SAASC,kBAAkB,QAAQ,qCAAiC;AACpE,SAASC,gBAAgB,QAAQ,0BAAsB;AACvD,SAASC,kBAAkB,QAAQ,uCAAmC;AAGtE,OAAO,MAAMC;IAGZC,IAAIC,GAAY,EAAEC,GAAa,EAAEC,IAAkB,EAAQ;QAC1D,MAAMC,YAAYV,QAAQW,MAAM,CAACC,MAAM;QACvC,MAAMC,iBAAiBC,KAAKC,GAAG;QAE/BP,IAAIQ,SAAS,CAAC,mBAAmBH,eAAeI,QAAQ;QAExD,MAAMC,cAAcV,IAAIW,GAAG,CAACC,IAAI,CAACZ;QACjC,MAAMa,qBAAqB,IAAI,CAACC,mBAAmB;QACnDd,IAAIW,GAAG,GAAG,SAAUI,KAAW,EAAEC,QAAc,EAAEC,EAAQ;YACxD,MAAMC,UAAU1B,QAAQW,MAAM,CAACC,MAAM;YACrC,MAAMe,eAAeb,KAAKC,GAAG;YAC7B,MAAMa,WAAWC,OAAOH,UAAUhB,aAAa;YAE/C,IAAI,CAACF,IAAIsB,WAAW,EAAE;gBACrBtB,IAAIQ,SAAS,CAAC,mBAAmB,GAAGY,SAASG,OAAO,CAAC,GAAG,EAAE,CAAC;gBAC3DvB,IAAIQ,SAAS,CAAC,iBAAiBW,aAAaV,QAAQ;YACrD;YAEAI,mBAAmBW,aAAa,CAAC;gBAChCtB;gBACAgB;gBACAE;gBACAf;gBACAc;YACD;YAEA,MAAMM,UAAUZ,mBAAmBa,UAAU;YAC7C,IAAID,SAAS;gBACZ,MAAME,WAAW9B,iBAAiB+B,SAAS,CAACC,WAAW,CAACT,UAAUpB,IAAI8B,UAAU;gBAChF,MAAMC,UAAU,GAAGhC,IAAIiC,MAAM,CAAC,CAAC,EAAEjC,IAAIkC,GAAG,CAAC,GAAG,EAAEjC,IAAI8B,UAAU,CAAC,GAAG,EAAEV,SAASG,OAAO,CAAC,GAAG,EAAE,CAAC;gBAEzF,IAAII,aAAa,QAAQ;oBACxBhC,iBAAiBuC,IAAI,CAAC,CAAC,cAAc,EAAEH,SAAS,EAAElC,iBAAiBsC,IAAI;gBACxE,OACK,IAAIR,aAAa,SAAS;oBAC9BhC,iBAAiByC,KAAK,CAAC,CAAC,gBAAgB,EAAEL,SAAS,EAAE,IAAIlC,iBAAiBsC,IAAI;gBAC/E,OACK;oBACJxC,iBAAiB0C,KAAK,CAACN,SAASlC,iBAAiBsC,IAAI;gBACtD;gBAEA,IAAIf,WAAW,MAAM;oBACpBzB,iBAAiBuC,IAAI,CACpB,CAAC,gCAAgC,EAAEd,SAASG,OAAO,CAAC,GAAG,0BAA0B,CAAC,EAClF1B,iBAAiBsC,IAAI;gBAEvB;gBAEAvC,mBAAmB0C,UAAU;YAC9B;YAEA,OAAO5B,YAAYK,OAAOC,UAAUC;QACrC;QAEAhB;IACD;IAEA;;EAEC,GACD,AAAQ4B,YAAYT,QAAgB,EAAEU,UAAkB,EAA8B;QACrF,IAAIA,cAAc,KAAK;YACtB,OAAO;QACR;QACA,IAAIA,cAAc,OAAOV,WAAW,MAAM;YACzC,OAAO;QACR;QACA,OAAO;IACR;IAtEA,YAAY,AAAiBN,mBAAuC,CAAE;aAAzCA,sBAAAA;IAA0C;AAuExE"}