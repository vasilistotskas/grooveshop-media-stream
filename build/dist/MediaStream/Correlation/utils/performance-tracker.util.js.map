{"version":3,"sources":["../../../../../src/MediaStream/Correlation/utils/performance-tracker.util.ts"],"sourcesContent":["import * as process from 'node:process'\r\nimport { CorrelationService } from '@microservice/Correlation/services/correlation.service'\r\nimport { CorrelatedLogger } from '@microservice/Correlation/utils/logger.util'\r\n\r\nexport interface PerformancePhase {\r\n\tname: string\r\n\tstartTime: bigint\r\n\tendTime?: bigint\r\n\tduration?: number\r\n\tmetadata?: Record<string, any>\r\n}\r\n\r\nexport class PerformanceTracker {\r\n\tprivate static phases = new Map<string, PerformancePhase[]>()\r\n\r\n\tprivate static getCorrelationService(): CorrelationService {\r\n\t\treturn new CorrelationService()\r\n\t}\r\n\r\n\t/**\r\n\t * Start tracking a performance phase\r\n\t */\r\n\tstatic startPhase(phaseName: string, metadata?: Record<string, any>): void {\r\n\t\tconst correlationId = this.getCorrelationService().getCorrelationId()\r\n\t\tif (!correlationId)\r\n\t\t\treturn\r\n\r\n\t\tconst phase: PerformancePhase = {\r\n\t\t\tname: phaseName,\r\n\t\t\tstartTime: process.hrtime.bigint(),\r\n\t\t\tmetadata,\r\n\t\t}\r\n\r\n\t\tif (!this.phases.has(correlationId)) {\r\n\t\t\tthis.phases.set(correlationId, [])\r\n\t\t}\r\n\r\n\t\tthis.phases.get(correlationId)!.push(phase)\r\n\r\n\t\tCorrelatedLogger.debug(\r\n\t\t\t`Performance phase started: ${phaseName}${metadata ? ` (${JSON.stringify(metadata)})` : ''}`,\r\n\t\t\t'PerformanceTracker',\r\n\t\t)\r\n\t}\r\n\r\n\t/**\r\n\t * End tracking a performance phase\r\n\t */\r\n\tstatic endPhase(phaseName: string, metadata?: Record<string, any>): number | null {\r\n\t\tconst correlationId = this.getCorrelationService().getCorrelationId()\r\n\t\tif (!correlationId)\r\n\t\t\treturn null\r\n\r\n\t\tconst phases = this.phases.get(correlationId)\r\n\t\tif (!phases)\r\n\t\t\treturn null\r\n\r\n\t\tconst phase = phases\r\n\t\t\t.slice()\r\n\t\t\t.reverse()\r\n\t\t\t.find(p => p.name === phaseName && !p.endTime)\r\n\r\n\t\tif (!phase) {\r\n\t\t\tCorrelatedLogger.warn(\r\n\t\t\t\t`Performance phase not found or already ended: ${phaseName}`,\r\n\t\t\t\t'PerformanceTracker',\r\n\t\t\t)\r\n\t\t\treturn null\r\n\t\t}\r\n\r\n\t\tphase.endTime = process.hrtime.bigint()\r\n\t\tphase.duration = Number(phase.endTime - phase.startTime) / 1_000_000\r\n\r\n\t\tif (metadata) {\r\n\t\t\tphase.metadata = { ...phase.metadata, ...metadata }\r\n\t\t}\r\n\r\n\t\tconst logLevel = phase.duration > 1000 ? 'warn' : 'debug'\r\n\t\tconst logger = logLevel === 'warn' ? CorrelatedLogger.warn : CorrelatedLogger.debug\r\n\r\n\t\tlogger(\r\n\t\t\t`Performance phase completed: ${phaseName} - ${phase.duration.toFixed(2)}ms${\r\n\t\t\t\tphase.metadata ? ` (${JSON.stringify(phase.metadata)})` : ''\r\n\t\t\t}`,\r\n\t\t\t'PerformanceTracker',\r\n\t\t)\r\n\r\n\t\treturn phase.duration\r\n\t}\r\n\r\n\t/**\r\n\t * Get all performance phases for the current request\r\n\t */\r\n\tstatic getPhases(): PerformancePhase[] {\r\n\t\tconst correlationId = this.getCorrelationService().getCorrelationId()\r\n\t\tif (!correlationId)\r\n\t\t\treturn []\r\n\r\n\t\treturn this.phases.get(correlationId) || []\r\n\t}\r\n\r\n\t/**\r\n\t * Get performance summary for the current request\r\n\t */\r\n\tstatic getSummary(): {\r\n\t\ttotalPhases: number\r\n\t\tcompletedPhases: number\r\n\t\ttotalDuration: number\r\n\t\tslowestPhase?: PerformancePhase\r\n\t\tphases: PerformancePhase[]\r\n\t} {\r\n\t\tconst phases = this.getPhases()\r\n\t\tconst completedPhases = phases.filter(p => p.duration !== undefined)\r\n\t\tconst totalDuration = completedPhases.reduce((sum: any, p: any) => sum + (p.duration || 0), 0)\r\n\t\tconst slowestPhase = completedPhases.reduce((slowest: any, current: any) =>\r\n\t\t\t!slowest || (current.duration || 0) > (slowest.duration || 0) ? current : slowest, undefined as PerformancePhase | undefined)\r\n\r\n\t\treturn {\r\n\t\t\ttotalPhases: phases.length,\r\n\t\t\tcompletedPhases: completedPhases.length,\r\n\t\t\ttotalDuration,\r\n\t\t\tslowestPhase,\r\n\t\t\tphases,\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Clear performance data for the current request\r\n\t */\r\n\tstatic clearPhases(): void {\r\n\t\tconst correlationId = this.getCorrelationService().getCorrelationId()\r\n\t\tif (correlationId) {\r\n\t\t\tthis.phases.delete(correlationId)\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Measure the execution time of a function\r\n\t */\r\n\tstatic async measure<T>(\r\n\t\tphaseName: string,\r\n\t\tfn: () => Promise<T> | T,\r\n\t\tmetadata?: Record<string, any>,\r\n\t): Promise<T> {\r\n\t\tthis.startPhase(phaseName, metadata)\r\n\t\ttry {\r\n\t\t\tconst result = await fn()\r\n\t\t\tthis.endPhase(phaseName, { success: true })\r\n\t\t\treturn result\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.endPhase(phaseName, {\r\n\t\t\t\tsuccess: false,\r\n\t\t\t\terror: error instanceof Error ? (error as Error).message : 'Unknown error',\r\n\t\t\t})\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Create a decorator for measuring method execution time\r\n\t */\r\n\tstatic measureMethod(phaseName?: string, metadata?: Record<string, any>) {\r\n\t\treturn function (target: any, propertyName: string, descriptor: PropertyDescriptor) {\r\n\t\t\tconst method = descriptor.value\r\n\t\t\tconst actualPhaseName = phaseName || `${target.constructor.name}.${propertyName}`\r\n\r\n\t\t\tdescriptor.value = async function (...args: any[]) {\r\n\t\t\t\treturn PerformanceTracker.measure(\r\n\t\t\t\t\tactualPhaseName,\r\n\t\t\t\t\t() => method.apply(this, args),\r\n\t\t\t\t\tmetadata,\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Log performance summary at the end of a request\r\n\t */\r\n\tstatic logSummary(): void {\r\n\t\tconst summary = this.getSummary()\r\n\t\tif (summary.totalPhases === 0)\r\n\t\t\treturn\r\n\r\n\t\tconst context = this.getCorrelationService().getContext()\r\n\t\tconst requestDuration = context?.duration\r\n\r\n\t\tCorrelatedLogger.log(\r\n\t\t\t`Performance Summary: ${summary.completedPhases}/${summary.totalPhases} phases completed, `\r\n\t\t\t+ `total phase time: ${summary.totalDuration.toFixed(2)}ms${\r\n\t\t\t\trequestDuration ? `, request time: ${requestDuration.toFixed(2)}ms` : ''\r\n\t\t\t}${summary.slowestPhase ? `, slowest: ${summary.slowestPhase.name} (${summary.slowestPhase.duration?.toFixed(2)}ms)` : ''}`,\r\n\t\t\t'PerformanceTracker',\r\n\t\t)\r\n\r\n\t\tthis.clearPhases()\r\n\t}\r\n}\r\n"],"names":["process","CorrelationService","CorrelatedLogger","PerformanceTracker","phases","Map","getCorrelationService","startPhase","phaseName","metadata","correlationId","getCorrelationId","phase","name","startTime","hrtime","bigint","has","set","get","push","debug","JSON","stringify","endPhase","slice","reverse","find","p","endTime","warn","duration","Number","logLevel","logger","toFixed","getPhases","getSummary","completedPhases","filter","undefined","totalDuration","reduce","sum","slowestPhase","slowest","current","totalPhases","length","clearPhases","delete","measure","fn","result","success","error","Error","message","measureMethod","target","propertyName","descriptor","method","value","actualPhaseName","args","apply","logSummary","summary","context","getContext","requestDuration","log"],"mappings":"AAAA,YAAYA,aAAa,eAAc;AACvC,SAASC,kBAAkB,QAAQ,qCAAwD;AAC3F,SAASC,gBAAgB,QAAQ,mBAA6C;AAU9E,OAAO,MAAMC;;aACGC,SAAS,IAAIC;;IAE5B,OAAeC,wBAA4C;QAC1D,OAAO,IAAIL;IACZ;IAEA;;EAEC,GACD,OAAOM,WAAWC,SAAiB,EAAEC,QAA8B,EAAQ;QAC1E,MAAMC,gBAAgB,IAAI,CAACJ,qBAAqB,GAAGK,gBAAgB;QACnE,IAAI,CAACD,eACJ;QAED,MAAME,QAA0B;YAC/BC,MAAML;YACNM,WAAWd,QAAQe,MAAM,CAACC,MAAM;YAChCP;QACD;QAEA,IAAI,CAAC,IAAI,CAACL,MAAM,CAACa,GAAG,CAACP,gBAAgB;YACpC,IAAI,CAACN,MAAM,CAACc,GAAG,CAACR,eAAe,EAAE;QAClC;QAEA,IAAI,CAACN,MAAM,CAACe,GAAG,CAACT,eAAgBU,IAAI,CAACR;QAErCV,iBAAiBmB,KAAK,CACrB,CAAC,2BAA2B,EAAEb,YAAYC,WAAW,CAAC,EAAE,EAAEa,KAAKC,SAAS,CAACd,UAAU,CAAC,CAAC,GAAG,IAAI,EAC5F;IAEF;IAEA;;EAEC,GACD,OAAOe,SAAShB,SAAiB,EAAEC,QAA8B,EAAiB;QACjF,MAAMC,gBAAgB,IAAI,CAACJ,qBAAqB,GAAGK,gBAAgB;QACnE,IAAI,CAACD,eACJ,OAAO;QAER,MAAMN,SAAS,IAAI,CAACA,MAAM,CAACe,GAAG,CAACT;QAC/B,IAAI,CAACN,QACJ,OAAO;QAER,MAAMQ,QAAQR,OACZqB,KAAK,GACLC,OAAO,GACPC,IAAI,CAACC,CAAAA,IAAKA,EAAEf,IAAI,KAAKL,aAAa,CAACoB,EAAEC,OAAO;QAE9C,IAAI,CAACjB,OAAO;YACXV,iBAAiB4B,IAAI,CACpB,CAAC,8CAA8C,EAAEtB,WAAW,EAC5D;YAED,OAAO;QACR;QAEAI,MAAMiB,OAAO,GAAG7B,QAAQe,MAAM,CAACC,MAAM;QACrCJ,MAAMmB,QAAQ,GAAGC,OAAOpB,MAAMiB,OAAO,GAAGjB,MAAME,SAAS,IAAI;QAE3D,IAAIL,UAAU;YACbG,MAAMH,QAAQ,GAAG;gBAAE,GAAGG,MAAMH,QAAQ;gBAAE,GAAGA,QAAQ;YAAC;QACnD;QAEA,MAAMwB,WAAWrB,MAAMmB,QAAQ,GAAG,OAAO,SAAS;QAClD,MAAMG,SAASD,aAAa,SAAS/B,iBAAiB4B,IAAI,GAAG5B,iBAAiBmB,KAAK;QAEnFa,OACC,CAAC,6BAA6B,EAAE1B,UAAU,GAAG,EAAEI,MAAMmB,QAAQ,CAACI,OAAO,CAAC,GAAG,EAAE,EAC1EvB,MAAMH,QAAQ,GAAG,CAAC,EAAE,EAAEa,KAAKC,SAAS,CAACX,MAAMH,QAAQ,EAAE,CAAC,CAAC,GAAG,IACzD,EACF;QAGD,OAAOG,MAAMmB,QAAQ;IACtB;IAEA;;EAEC,GACD,OAAOK,YAAgC;QACtC,MAAM1B,gBAAgB,IAAI,CAACJ,qBAAqB,GAAGK,gBAAgB;QACnE,IAAI,CAACD,eACJ,OAAO,EAAE;QAEV,OAAO,IAAI,CAACN,MAAM,CAACe,GAAG,CAACT,kBAAkB,EAAE;IAC5C;IAEA;;EAEC,GACD,OAAO2B,aAML;QACD,MAAMjC,SAAS,IAAI,CAACgC,SAAS;QAC7B,MAAME,kBAAkBlC,OAAOmC,MAAM,CAACX,CAAAA,IAAKA,EAAEG,QAAQ,KAAKS;QAC1D,MAAMC,gBAAgBH,gBAAgBI,MAAM,CAAC,CAACC,KAAUf,IAAWe,MAAOf,CAAAA,EAAEG,QAAQ,IAAI,CAAA,GAAI;QAC5F,MAAMa,eAAeN,gBAAgBI,MAAM,CAAC,CAACG,SAAcC,UAC1D,CAACD,WAAW,AAACC,CAAAA,QAAQf,QAAQ,IAAI,CAAA,IAAMc,CAAAA,QAAQd,QAAQ,IAAI,CAAA,IAAKe,UAAUD,SAASL;QAEpF,OAAO;YACNO,aAAa3C,OAAO4C,MAAM;YAC1BV,iBAAiBA,gBAAgBU,MAAM;YACvCP;YACAG;YACAxC;QACD;IACD;IAEA;;EAEC,GACD,OAAO6C,cAAoB;QAC1B,MAAMvC,gBAAgB,IAAI,CAACJ,qBAAqB,GAAGK,gBAAgB;QACnE,IAAID,eAAe;YAClB,IAAI,CAACN,MAAM,CAAC8C,MAAM,CAACxC;QACpB;IACD;IAEA;;EAEC,GACD,aAAayC,QACZ3C,SAAiB,EACjB4C,EAAwB,EACxB3C,QAA8B,EACjB;QACb,IAAI,CAACF,UAAU,CAACC,WAAWC;QAC3B,IAAI;YACH,MAAM4C,SAAS,MAAMD;YACrB,IAAI,CAAC5B,QAAQ,CAAChB,WAAW;gBAAE8C,SAAS;YAAK;YACzC,OAAOD;QACR,EACA,OAAOE,OAAgB;YACtB,IAAI,CAAC/B,QAAQ,CAAChB,WAAW;gBACxB8C,SAAS;gBACTC,OAAOA,iBAAiBC,QAAQ,AAACD,MAAgBE,OAAO,GAAG;YAC5D;YACA,MAAMF;QACP;IACD;IAEA;;EAEC,GACD,OAAOG,cAAclD,SAAkB,EAAEC,QAA8B,EAAE;QACxE,OAAO,SAAUkD,MAAW,EAAEC,YAAoB,EAAEC,UAA8B;YACjF,MAAMC,SAASD,WAAWE,KAAK;YAC/B,MAAMC,kBAAkBxD,aAAa,GAAGmD,OAAO,WAAW,CAAC9C,IAAI,CAAC,CAAC,EAAE+C,cAAc;YAEjFC,WAAWE,KAAK,GAAG,eAAgB,GAAGE,IAAW;gBAChD,OAAO9D,mBAAmBgD,OAAO,CAChCa,iBACA,IAAMF,OAAOI,KAAK,CAAC,IAAI,EAAED,OACzBxD;YAEF;QACD;IACD;IAEA;;EAEC,GACD,OAAO0D,aAAmB;QACzB,MAAMC,UAAU,IAAI,CAAC/B,UAAU;QAC/B,IAAI+B,QAAQrB,WAAW,KAAK,GAC3B;QAED,MAAMsB,UAAU,IAAI,CAAC/D,qBAAqB,GAAGgE,UAAU;QACvD,MAAMC,kBAAkBF,SAAStC;QAEjC7B,iBAAiBsE,GAAG,CACnB,CAAC,qBAAqB,EAAEJ,QAAQ9B,eAAe,CAAC,CAAC,EAAE8B,QAAQrB,WAAW,CAAC,mBAAmB,CAAC,GACzF,CAAC,kBAAkB,EAAEqB,QAAQ3B,aAAa,CAACN,OAAO,CAAC,GAAG,EAAE,EACzDoC,kBAAkB,CAAC,gBAAgB,EAAEA,gBAAgBpC,OAAO,CAAC,GAAG,EAAE,CAAC,GAAG,KACpEiC,QAAQxB,YAAY,GAAG,CAAC,WAAW,EAAEwB,QAAQxB,YAAY,CAAC/B,IAAI,CAAC,EAAE,EAAEuD,QAAQxB,YAAY,CAACb,QAAQ,EAAEI,QAAQ,GAAG,GAAG,CAAC,GAAG,IAAI,EAC3H;QAGD,IAAI,CAACc,WAAW;IACjB;AACD"}