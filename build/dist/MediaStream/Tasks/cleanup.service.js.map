{"version":3,"sources":["../../../../src/MediaStream/Tasks/cleanup.service.ts"],"sourcesContent":["import * as fs from 'node:fs/promises'\r\nimport * as path from 'node:path'\r\nimport { cwd } from 'node:process'\r\nimport { Injectable, Logger } from '@nestjs/common'\r\nimport { Cron, CronExpression } from '@nestjs/schedule'\r\n\r\n@Injectable()\r\nexport class CleanupService {\r\n\tconstructor(private readonly logger: Logger) {}\r\n\r\n\t@Cron(CronExpression.EVERY_WEEK, {\r\n\t\tname: 'cleanup',\r\n\t})\r\n\tasync handleCleanup(): Promise<void> {\r\n\t\tconst projectRoot = cwd()\r\n\t\tconst directoryPath = path.join(projectRoot, 'storage')\r\n\t\tlet deletedFilesCount = 0\r\n\r\n\t\ttry {\r\n\t\t\tconst files = await fs.readdir(directoryPath)\r\n\t\t\tfor (const file of files) {\r\n\t\t\t\tif (file.endsWith('.rst') || file.endsWith('.rsc') || file.endsWith('.rsm') || file.endsWith('.webp')) {\r\n\t\t\t\t\tawait fs.unlink(path.join(directoryPath, file))\r\n\t\t\t\t\tdeletedFilesCount++\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.logger.debug(`${deletedFilesCount} files deleted.`)\r\n\t\t}\r\n\t\tcatch (err: unknown) {\r\n\t\t\tthis.logger.error(`Error during cleanup: ${err}`)\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["fs","path","cwd","Injectable","Logger","Cron","CronExpression","CleanupService","handleCleanup","projectRoot","directoryPath","join","deletedFilesCount","files","readdir","file","endsWith","unlink","logger","debug","err","error","EVERY_WEEK","name"],"mappings":";;;;;;;;;AAAA,YAAYA,QAAQ,mBAAkB;AACtC,YAAYC,UAAU,YAAW;AACjC,SAASC,GAAG,QAAQ,eAAc;AAClC,SAASC,UAAU,EAAEC,MAAM,QAAQ,iBAAgB;AACnD,SAASC,IAAI,EAAEC,cAAc,QAAQ,mBAAkB;AAGvD,OAAO,MAAMC;IAGZ,MAGMC,gBAA+B;QACpC,MAAMC,cAAcP;QACpB,MAAMQ,gBAAgBT,KAAKU,IAAI,CAACF,aAAa;QAC7C,IAAIG,oBAAoB;QAExB,IAAI;YACH,MAAMC,QAAQ,MAAMb,GAAGc,OAAO,CAACJ;YAC/B,KAAK,MAAMK,QAAQF,MAAO;gBACzB,IAAIE,KAAKC,QAAQ,CAAC,WAAWD,KAAKC,QAAQ,CAAC,WAAWD,KAAKC,QAAQ,CAAC,WAAWD,KAAKC,QAAQ,CAAC,UAAU;oBACtG,MAAMhB,GAAGiB,MAAM,CAAChB,KAAKU,IAAI,CAACD,eAAeK;oBACzCH;gBACD;YACD;YACA,IAAI,CAACM,MAAM,CAACC,KAAK,CAAC,GAAGP,kBAAkB,eAAe,CAAC;QACxD,EACA,OAAOQ,KAAc;YACpB,IAAI,CAACF,MAAM,CAACG,KAAK,CAAC,CAAC,sBAAsB,EAAED,KAAK;QACjD;IACD;IAvBA,YAAY,AAAiBF,MAAc,CAAE;aAAhBA,SAAAA;IAAiB;AAwB/C;;wBAtBsBI;QACpBC,MAAM"}