{"version":3,"sources":["../../../../../src/MediaStream/Monitoring/services/alert.service.ts"],"sourcesContent":["import type {\r\n\tAlert,\r\n\tAlertRule,\r\n\tMonitoringConfig,\r\n} from '../interfaces/monitoring.interface'\r\nimport * as process from 'node:process'\r\nimport { CorrelationService } from '@microservice/Correlation/services/correlation.service'\r\nimport { Injectable, Logger } from '@nestjs/common'\r\nimport { ConfigService } from '@nestjs/config'\r\nimport { AlertCondition, AlertSeverity } from '../interfaces/monitoring.interface'\r\nimport { MonitoringService } from './monitoring.service'\r\n\r\n@Injectable()\r\nexport class AlertService {\r\n\tprivate readonly _logger = new Logger(AlertService.name)\r\n\tprivate readonly alertRules = new Map<string, AlertRule>()\r\n\tprivate readonly activeAlerts = new Map<string, Alert>()\r\n\tprivate readonly alertHistory: Alert[] = []\r\n\tprivate readonly config: MonitoringConfig\r\n\tprivate readonly alertCooldowns = new Map<string, number>()\r\n\r\n\tconstructor(\r\n\t\tprivate readonly _configService: ConfigService,\r\n\t\tprivate readonly _correlationService: CorrelationService,\r\n\t\tprivate readonly monitoringService: MonitoringService,\r\n\t) {\r\n\t\tthis.config = this._configService.get<MonitoringConfig>('monitoring', {\r\n\t\t\tenabled: true,\r\n\t\t\tmetricsRetentionMs: 24 * 60 * 60 * 1000,\r\n\t\t\talertsRetentionMs: 7 * 24 * 60 * 60 * 1000,\r\n\t\t\tperformanceRetentionMs: 24 * 60 * 60 * 1000,\r\n\t\t\thealthCheckIntervalMs: 30 * 1000,\r\n\t\t\talertCooldownMs: 5 * 60 * 1000,\r\n\t\t\texternalIntegrations: {\r\n\t\t\t\tenabled: false,\r\n\t\t\t\tendpoints: [],\r\n\t\t\t},\r\n\t\t})\r\n\r\n\t\tif (this.config.enabled) {\r\n\t\t\tthis.initializeDefaultRules()\r\n\t\t\tif (process.env.NODE_ENV !== 'test') {\r\n\t\t\t\tthis.startAlertEvaluation()\r\n\t\t\t}\r\n\t\t\tthis.startAlertCleanup()\r\n\t\t\tthis._logger.log('Alert service initialized')\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Add or update an alert rule\r\n\t */\r\n\taddAlertRule(rule: AlertRule): void {\r\n\t\tthis.alertRules.set(rule.id, rule)\r\n\t\tthis._logger.log(`Alert rule added: ${rule.name}`, {\r\n\t\t\tcorrelationId: this._correlationService.getCorrelationId(),\r\n\t\t\truleId: rule.id,\r\n\t\t})\r\n\t}\r\n\r\n\t/**\r\n\t * Remove an alert rule\r\n\t */\r\n\tremoveAlertRule(ruleId: string): boolean {\r\n\t\tconst removed = this.alertRules.delete(ruleId)\r\n\t\tif (removed) {\r\n\t\t\tthis._logger.log(`Alert rule removed: ${ruleId}`)\r\n\t\t}\r\n\t\treturn removed\r\n\t}\r\n\r\n\t/**\r\n\t * Get all alert rules\r\n\t */\r\n\tgetAlertRules(): AlertRule[] {\r\n\t\treturn Array.from(this.alertRules.values())\r\n\t}\r\n\r\n\t/**\r\n\t * Get active alerts\r\n\t */\r\n\tgetActiveAlerts(): Alert[] {\r\n\t\treturn Array.from(this.activeAlerts.values())\r\n\t}\r\n\r\n\t/**\r\n\t * Get alert history\r\n\t */\r\n\tgetAlertHistory(since?: number): Alert[] {\r\n\t\tif (since) {\r\n\t\t\treturn this.alertHistory.filter(alert => alert.timestamp >= since)\r\n\t\t}\r\n\t\treturn [...this.alertHistory]\r\n\t}\r\n\r\n\t/**\r\n\t * Manually trigger an alert\r\n\t */\r\n\ttriggerAlert(\r\n\t\truleName: string,\r\n\t\tmessage: string,\r\n\t\tseverity: AlertSeverity,\r\n\t\tmetadata?: Record<string, any>,\r\n\t): void {\r\n\t\tconst alert: Alert = {\r\n\t\t\tid: `manual-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n\t\t\truleId: 'manual',\r\n\t\t\truleName,\r\n\t\t\tmessage,\r\n\t\t\tseverity,\r\n\t\t\ttimestamp: Date.now(),\r\n\t\t\tresolved: false,\r\n\t\t\tmetadata,\r\n\t\t}\r\n\r\n\t\tthis.processAlert(alert)\r\n\t}\r\n\r\n\t/**\r\n\t * Resolve an alert\r\n\t */\r\n\tresolveAlert(alertId: string): boolean {\r\n\t\tconst alert = this.activeAlerts.get(alertId)\r\n\t\tif (alert && !alert.resolved) {\r\n\t\t\talert.resolved = true\r\n\t\t\talert.resolvedAt = Date.now()\r\n\t\t\tthis.activeAlerts.delete(alertId)\r\n\r\n\t\t\tconst historyAlert = this.alertHistory.find(a => a.id === alertId)\r\n\t\t\tif (historyAlert) {\r\n\t\t\t\thistoryAlert.resolved = true\r\n\t\t\t\thistoryAlert.resolvedAt = alert.resolvedAt\r\n\t\t\t}\r\n\r\n\t\t\tthis._logger.log(`Alert resolved: ${alert.ruleName}`, {\r\n\t\t\t\tcorrelationId: this._correlationService.getCorrelationId(),\r\n\t\t\t\talertId,\r\n\t\t\t\tduration: alert.resolvedAt - alert.timestamp,\r\n\t\t\t})\r\n\t\t\treturn true\r\n\t\t}\r\n\t\treturn false\r\n\t}\r\n\r\n\t/**\r\n\t * Manually evaluate alerts (for testing)\r\n\t */\r\n\tevaluateAlertsNow(): void {\r\n\t\tthis.evaluateAlerts()\r\n\t}\r\n\r\n\t/**\r\n\t * Get alert statistics\r\n\t */\r\n\tgetAlertStats(): {\r\n\t\ttotalRules: number\r\n\t\tactiveAlerts: number\r\n\t\talertsBySeverity: Record<AlertSeverity, number>\r\n\t\talertsLast24h: number\r\n\t\taverageResolutionTime: number\r\n\t} {\r\n\t\tconst activeAlerts = this.getActiveAlerts()\r\n\t\tconst last24h = Date.now() - 24 * 60 * 60 * 1000\r\n\t\tconst recentAlerts = this.getAlertHistory(last24h)\r\n\r\n\t\tconst alertsBySeverity: Record<AlertSeverity, number> = {\r\n\t\t\t[AlertSeverity.LOW]: 0,\r\n\t\t\t[AlertSeverity.MEDIUM]: 0,\r\n\t\t\t[AlertSeverity.HIGH]: 0,\r\n\t\t\t[AlertSeverity.CRITICAL]: 0,\r\n\t\t}\r\n\r\n\t\tactiveAlerts.forEach((alert) => {\r\n\t\t\talertsBySeverity[alert.severity]++\r\n\t\t})\r\n\r\n\t\tconst resolvedAlerts = this.alertHistory.filter(a => a.resolved && a.resolvedAt)\r\n\t\tconst totalResolutionTime = resolvedAlerts.reduce((sum: any, alert: any) => {\r\n\t\t\treturn sum + (alert.resolvedAt! - alert.timestamp)\r\n\t\t}, 0)\r\n\t\tconst averageResolutionTime = resolvedAlerts.length > 0\r\n\t\t\t? totalResolutionTime / resolvedAlerts.length\r\n\t\t\t: 0\r\n\r\n\t\treturn {\r\n\t\t\ttotalRules: this.alertRules.size,\r\n\t\t\tactiveAlerts: activeAlerts.length,\r\n\t\t\talertsBySeverity,\r\n\t\t\talertsLast24h: recentAlerts.length,\r\n\t\t\taverageResolutionTime,\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Initialize default alert rules\r\n\t */\r\n\tprivate initializeDefaultRules(): void {\r\n\t\tconst defaultRules: AlertRule[] = [\r\n\t\t\t{\r\n\t\t\t\tid: 'high-memory-usage',\r\n\t\t\t\tname: 'High Memory Usage',\r\n\t\t\t\tdescription: 'Memory usage is above 85%',\r\n\t\t\t\tmetric: 'system.memory.usage_percent',\r\n\t\t\t\tcondition: AlertCondition.GREATER_THAN,\r\n\t\t\t\tthreshold: 85,\r\n\t\t\t\tseverity: AlertSeverity.HIGH,\r\n\t\t\t\tenabled: true,\r\n\t\t\t\tcooldownMs: this.config.alertCooldownMs,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tid: 'critical-memory-usage',\r\n\t\t\t\tname: 'Critical Memory Usage',\r\n\t\t\t\tdescription: 'Memory usage is above 95%',\r\n\t\t\t\tmetric: 'system.memory.usage_percent',\r\n\t\t\t\tcondition: AlertCondition.GREATER_THAN,\r\n\t\t\t\tthreshold: 95,\r\n\t\t\t\tseverity: AlertSeverity.CRITICAL,\r\n\t\t\t\tenabled: true,\r\n\t\t\t\tcooldownMs: this.config.alertCooldownMs,\r\n\t\t\t},\r\n\t\t]\r\n\r\n\t\tdefaultRules.forEach(rule => this.addAlertRule(rule))\r\n\t}\r\n\r\n\t/**\r\n\t * Start periodic alert evaluation\r\n\t */\r\n\tprivate startAlertEvaluation(): void {\r\n\t\tconst evaluationInterval = 30 * 1000\r\n\t\tsetInterval(() => {\r\n\t\t\tthis.evaluateAlerts()\r\n\t\t}, evaluationInterval)\r\n\t}\r\n\r\n\t/**\r\n\t * Evaluate all alert rules\r\n\t */\r\n\tprivate evaluateAlerts(): void {\r\n\t\tconst now = Date.now()\r\n\t\tconst evaluationWindow = 5 * 60 * 1000\r\n\r\n\t\tfor (const rule of this.alertRules.values()) {\r\n\t\t\tif (!rule.enabled)\r\n\t\t\t\tcontinue\r\n\r\n\t\t\tconst lastAlert = this.alertCooldowns.get(rule.id)\r\n\t\t\tif (lastAlert && (now - lastAlert) < rule.cooldownMs) {\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconst shouldAlert = this.evaluateRule(rule, evaluationWindow)\r\n\t\t\t\tif (shouldAlert) {\r\n\t\t\t\t\tthis.createAlert(rule)\r\n\t\t\t\t\tthis.alertCooldowns.set(rule.id, now)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tcatch (error: unknown) {\r\n\t\t\t\tthis._logger.error(`Error evaluating alert rule ${rule.name}:`, error)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Evaluate a single alert rule\r\n\t */\r\n\tprivate evaluateRule(rule: AlertRule, windowMs: number): boolean {\r\n\t\tconst since = Date.now() - windowMs\r\n\t\tconst aggregatedMetrics = this.monitoringService.getAggregatedMetrics(rule.metric, since)\r\n\r\n\t\tif (aggregatedMetrics.count === 0) {\r\n\t\t\treturn false\r\n\t\t}\r\n\r\n\t\tconst value = aggregatedMetrics.latest\r\n\r\n\t\tswitch (rule.condition) {\r\n\t\t\tcase AlertCondition.GREATER_THAN:\r\n\t\t\t\treturn value > rule.threshold\r\n\t\t\tcase AlertCondition.LESS_THAN:\r\n\t\t\t\treturn value < rule.threshold\r\n\t\t\tcase AlertCondition.EQUALS:\r\n\t\t\t\treturn value === rule.threshold\r\n\t\t\tcase AlertCondition.NOT_EQUALS:\r\n\t\t\t\treturn value !== rule.threshold\r\n\t\t\tcase AlertCondition.GREATER_THAN_OR_EQUAL:\r\n\t\t\t\treturn value >= rule.threshold\r\n\t\t\tcase AlertCondition.LESS_THAN_OR_EQUAL:\r\n\t\t\t\treturn value <= rule.threshold\r\n\t\t\tdefault:\r\n\t\t\t\treturn false\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Create an alert from a rule\r\n\t */\r\n\tprivate createAlert(rule: AlertRule): void {\r\n\t\tconst alert: Alert = {\r\n\t\t\tid: `${rule.id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n\t\t\truleId: rule.id,\r\n\t\t\truleName: rule.name,\r\n\t\t\tmessage: rule.description,\r\n\t\t\tseverity: rule.severity,\r\n\t\t\ttimestamp: Date.now(),\r\n\t\t\tresolved: false,\r\n\t\t\tmetadata: {\r\n\t\t\t\tmetric: rule.metric,\r\n\t\t\t\tthreshold: rule.threshold,\r\n\t\t\t\tcondition: rule.condition,\r\n\t\t\t\ttags: rule.tags,\r\n\t\t\t},\r\n\t\t}\r\n\r\n\t\tthis.processAlert(alert)\r\n\t}\r\n\r\n\t/**\r\n\t * Process an alert (add to active alerts and history)\r\n\t */\r\n\tprivate processAlert(alert: Alert): void {\r\n\t\tthis.activeAlerts.set(alert.id, alert)\r\n\t\tthis.alertHistory.push(alert)\r\n\r\n\t\tthis._logger.warn(`Alert triggered: ${alert.ruleName}`, {\r\n\t\t\tcorrelationId: this._correlationService.getCorrelationId(),\r\n\t\t\talert,\r\n\t\t})\r\n\t}\r\n\r\n\t/**\r\n\t * Start alert cleanup process\r\n\t */\r\n\tprivate startAlertCleanup(): void {\r\n\t\tconst cleanupInterval = 60 * 60 * 1000\r\n\t\tsetInterval(() => {\r\n\t\t\tthis.cleanupOldAlerts()\r\n\t\t}, cleanupInterval)\r\n\t}\r\n\r\n\t/**\r\n\t * Clean up old alerts based on retention policy\r\n\t */\r\n\tprivate cleanupOldAlerts(): void {\r\n\t\tconst cutoffTime = Date.now() - this.config.alertsRetentionMs\r\n\t\tconst originalLength = this.alertHistory.length\r\n\r\n\t\tconst filteredHistory = this.alertHistory.filter(alert => alert.timestamp >= cutoffTime)\r\n\t\tthis.alertHistory.splice(0, this.alertHistory.length, ...filteredHistory)\r\n\r\n\t\tconst removedCount = originalLength - this.alertHistory.length\r\n\t\tif (removedCount > 0) {\r\n\t\t\tthis._logger.debug(`Cleaned up ${removedCount} old alerts`)\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["process","CorrelationService","Injectable","Logger","ConfigService","AlertCondition","AlertSeverity","MonitoringService","AlertService","addAlertRule","rule","alertRules","set","id","_logger","log","name","correlationId","_correlationService","getCorrelationId","ruleId","removeAlertRule","removed","delete","getAlertRules","Array","from","values","getActiveAlerts","activeAlerts","getAlertHistory","since","alertHistory","filter","alert","timestamp","triggerAlert","ruleName","message","severity","metadata","Date","now","Math","random","toString","substr","resolved","processAlert","resolveAlert","alertId","get","resolvedAt","historyAlert","find","a","duration","evaluateAlertsNow","evaluateAlerts","getAlertStats","last24h","recentAlerts","alertsBySeverity","LOW","MEDIUM","HIGH","CRITICAL","forEach","resolvedAlerts","totalResolutionTime","reduce","sum","averageResolutionTime","length","totalRules","size","alertsLast24h","initializeDefaultRules","defaultRules","description","metric","condition","GREATER_THAN","threshold","enabled","cooldownMs","config","alertCooldownMs","startAlertEvaluation","evaluationInterval","setInterval","evaluationWindow","lastAlert","alertCooldowns","shouldAlert","evaluateRule","createAlert","error","windowMs","aggregatedMetrics","monitoringService","getAggregatedMetrics","count","value","latest","LESS_THAN","EQUALS","NOT_EQUALS","GREATER_THAN_OR_EQUAL","LESS_THAN_OR_EQUAL","tags","push","warn","startAlertCleanup","cleanupInterval","cleanupOldAlerts","cutoffTime","alertsRetentionMs","originalLength","filteredHistory","splice","removedCount","debug","_configService","Map","metricsRetentionMs","performanceRetentionMs","healthCheckIntervalMs","externalIntegrations","endpoints","env","NODE_ENV"],"mappings":"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"}