{"version":3,"sources":["../../../../../src/MediaStream/Queue/jobs/store-resource-response-to-file.job.ts"],"sourcesContent":["import type { AxiosResponse } from 'axios'\r\nimport { open } from 'node:fs/promises'\r\nimport UnableToStoreFetchedResourceException from '@microservice/API/exceptions/unable-to-store-fetched-resource.exception'\r\nimport { Injectable, Logger, Scope } from '@nestjs/common'\r\n\r\n@Injectable({ scope: Scope.REQUEST })\r\nexport default class StoreResourceResponseToFileJob {\r\n\tprivate readonly _logger = new Logger(StoreResourceResponseToFileJob.name)\r\n\r\n\tasync handle(resourceName: string, path: string, response: AxiosResponse): Promise<void> {\r\n\t\tif (!response.data || typeof response.data.pipe !== 'function') {\r\n\t\t\tthis._logger.error('No data found in response or data is not streamable')\r\n\t\t\tthrow new UnableToStoreFetchedResourceException(resourceName)\r\n\t\t}\r\n\r\n\t\tconst fd = await open(path, 'w')\r\n\t\tconst fileStream = fd.createWriteStream()\r\n\r\n\t\ttry {\r\n\t\t\tresponse.data.pipe(fileStream)\r\n\t\t\tawait new Promise<void>((resolve, reject) => {\r\n\t\t\t\tfileStream\r\n\t\t\t\t\t.on('finish', () => resolve())\r\n\t\t\t\t\t.on('error', error => reject(error))\r\n\t\t\t})\r\n\t\t}\r\n\t\tcatch (e) {\r\n\t\t\tthis._logger.error(e)\r\n\t\t\tthrow new UnableToStoreFetchedResourceException(resourceName)\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["open","UnableToStoreFetchedResourceException","Injectable","Logger","Scope","StoreResourceResponseToFileJob","handle","resourceName","path","response","data","pipe","_logger","error","fd","fileStream","createWriteStream","Promise","resolve","reject","on","e","name","scope","REQUEST"],"mappings":";;;;;;AACA,SAASA,IAAI,QAAQ,mBAAkB;AACvC,OAAOC,2CAA2C,qEAAyE;AAC3H,SAASC,UAAU,EAAEC,MAAM,EAAEC,KAAK,QAAQ,iBAAgB;AAG3C,IAAA,AAAMC,iCAAN,MAAMA;IAGpB,MAAMC,OAAOC,YAAoB,EAAEC,IAAY,EAAEC,QAAuB,EAAiB;QACxF,IAAI,CAACA,SAASC,IAAI,IAAI,OAAOD,SAASC,IAAI,CAACC,IAAI,KAAK,YAAY;YAC/D,IAAI,CAACC,OAAO,CAACC,KAAK,CAAC;YACnB,MAAM,IAAIZ,sCAAsCM;QACjD;QAEA,MAAMO,KAAK,MAAMd,KAAKQ,MAAM;QAC5B,MAAMO,aAAaD,GAAGE,iBAAiB;QAEvC,IAAI;YACHP,SAASC,IAAI,CAACC,IAAI,CAACI;YACnB,MAAM,IAAIE,QAAc,CAACC,SAASC;gBACjCJ,WACEK,EAAE,CAAC,UAAU,IAAMF,WACnBE,EAAE,CAAC,SAASP,CAAAA,QAASM,OAAON;YAC/B;QACD,EACA,OAAOQ,GAAG;YACT,IAAI,CAACT,OAAO,CAACC,KAAK,CAACQ;YACnB,MAAM,IAAIpB,sCAAsCM;QACjD;IACD;;aAvBiBK,UAAU,IAAIT,OAAOE,+BAA+BiB,IAAI;;AAwB1E;AAzBA,SAAqBjB,4CAyBpB;;;QA1BakB,OAAOnB,MAAMoB,OAAO"}