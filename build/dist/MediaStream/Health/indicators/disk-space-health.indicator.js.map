{"version":3,"sources":["../../../../../src/MediaStream/Health/indicators/disk-space-health.indicator.ts"],"sourcesContent":["import type { HealthIndicatorResult } from '@nestjs/terminus'\r\nimport type { HealthCheckOptions } from '../interfaces/health-indicator.interface'\r\nimport { promises as fs } from 'node:fs'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { Injectable } from '@nestjs/common'\r\nimport { BaseHealthIndicator } from '../base/base-health-indicator'\r\n\r\nexport interface DiskSpaceInfo {\r\n\ttotal: number\r\n\tfree: number\r\n\tused: number\r\n\tusedPercentage: number\r\n\tpath: string\r\n}\r\n\r\n@Injectable()\r\nexport class DiskSpaceHealthIndicator extends BaseHealthIndicator {\r\n\tprivate readonly storagePath: string\r\n\tprivate readonly _warningThreshold: number\r\n\tprivate readonly _criticalThreshold: number\r\n\r\n\tconstructor(private readonly _configService: ConfigService) {\r\n\t\tconst options: HealthCheckOptions = {\r\n\t\t\ttimeout: 3000,\r\n\t\t\tthreshold: 0.9,\r\n\t\t}\r\n\r\n\t\tsuper('disk_space', options)\r\n\r\n\t\tthis.storagePath = this._configService.get('cache.file.directory')\r\n\t\tthis._warningThreshold = 0.8\r\n\t\tthis._criticalThreshold = 0.9\r\n\t}\r\n\r\n\tprotected async performHealthCheck(): Promise<HealthIndicatorResult> {\r\n\t\treturn this.executeWithTimeout(async () => {\r\n\t\t\tconst diskInfo = await this.getDiskSpaceInfo()\r\n\r\n\t\t\tif (diskInfo.usedPercentage >= this._criticalThreshold) {\r\n\t\t\t\treturn this.createUnhealthyResult(\r\n\t\t\t\t\t`Disk space critically low: ${(diskInfo.usedPercentage * 100).toFixed(1)}% used`,\r\n\t\t\t\t\tdiskInfo,\r\n\t\t\t\t)\r\n\t\t\t}\r\n\r\n\t\t\tconst detailStatus = diskInfo.usedPercentage >= this._warningThreshold ? 'warning' : 'healthy'\r\n\r\n\t\t\treturn this.createHealthyResult({\r\n\t\t\t\t...diskInfo,\r\n\t\t\t\tdetailStatus,\r\n\t\t\t\twarningThreshold: this._warningThreshold,\r\n\t\t\t\tcriticalThreshold: this._criticalThreshold,\r\n\t\t\t})\r\n\t\t})\r\n\t}\r\n\r\n\tprotected getDescription(): string {\r\n\t\treturn `Monitors disk space usage for storage directory: ${this.storagePath}`\r\n\t}\r\n\r\n\tprivate async getDiskSpaceInfo(): Promise<DiskSpaceInfo> {\r\n\t\ttry {\r\n\t\t\tawait fs.mkdir(this.storagePath, { recursive: true })\r\n\r\n\t\t\tconst stats = await fs.statfs(this.storagePath)\r\n\r\n\t\t\tconst total = stats.blocks * stats.bsize\r\n\t\t\tconst free = stats.bavail * stats.bsize\r\n\t\t\tconst used = total - free\r\n\t\t\tconst usedPercentage = used / total\r\n\r\n\t\t\treturn {\r\n\t\t\t\ttotal: this.formatBytes(total),\r\n\t\t\t\tfree: this.formatBytes(free),\r\n\t\t\t\tused: this.formatBytes(used),\r\n\t\t\t\tusedPercentage,\r\n\t\t\t\tpath: this.storagePath,\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\t// Fallback for systems that don't support statvfs\r\n\t\t\tconsole.error(error)\r\n\t\t\treturn this.getFallbackDiskInfo()\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async getFallbackDiskInfo(): Promise<DiskSpaceInfo> {\r\n\t\ttry {\r\n\t\t\treturn {\r\n\t\t\t\ttotal: 0,\r\n\t\t\t\tfree: 0,\r\n\t\t\t\tused: 0,\r\n\t\t\t\tusedPercentage: 0,\r\n\t\t\t\tpath: this.storagePath,\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconsole.error(error)\r\n\t\t\tthrow new Error(`Unable to access storage directory: ${this.storagePath}`)\r\n\t\t}\r\n\t}\r\n\r\n\tprivate formatBytes(bytes: number): number {\r\n\t\treturn Math.round(bytes / (1024 * 1024))\r\n\t}\r\n\r\n\t/**\r\n\t * Get current disk space information without health check wrapper\r\n\t */\r\n\tasync getCurrentDiskInfo(): Promise<DiskSpaceInfo> {\r\n\t\treturn this.getDiskSpaceInfo()\r\n\t}\r\n}\r\n"],"names":["promises","fs","ConfigService","Injectable","BaseHealthIndicator","DiskSpaceHealthIndicator","_configService","options","timeout","threshold","storagePath","get","_warningThreshold","_criticalThreshold","performHealthCheck","executeWithTimeout","diskInfo","getDiskSpaceInfo","usedPercentage","createUnhealthyResult","toFixed","detailStatus","createHealthyResult","warningThreshold","criticalThreshold","getDescription","mkdir","recursive","stats","statfs","total","blocks","bsize","free","bavail","used","formatBytes","path","error","console","getFallbackDiskInfo","Error","bytes","Math","round","getCurrentDiskInfo"],"mappings":";;;;;;;;;AAEA,SAASA,YAAYC,EAAE,QAAQ,UAAS;AACxC,SAASC,aAAa,QAAQ,iCAAqC;AACnE,SAASC,UAAU,QAAQ,iBAAgB;AAC3C,SAASC,mBAAmB,QAAQ,mCAA+B;AAWnE,OAAO,MAAMC,iCAAiCD;IAK7C,YAAY,AAAiBE,cAA6B,CAAE;QAC3D,MAAMC,UAA8B;YACnCC,SAAS;YACTC,WAAW;QACZ;QAEA,KAAK,CAAC,cAAcF,eANQD,iBAAAA;QAQ5B,IAAI,CAACI,WAAW,GAAG,IAAI,CAACJ,cAAc,CAACK,GAAG,CAAC;QAC3C,IAAI,CAACC,iBAAiB,GAAG;QACzB,IAAI,CAACC,kBAAkB,GAAG;IAC3B;IAEA,MAAgBC,qBAAqD;QACpE,OAAO,IAAI,CAACC,kBAAkB,CAAC;YAC9B,MAAMC,WAAW,MAAM,IAAI,CAACC,gBAAgB;YAE5C,IAAID,SAASE,cAAc,IAAI,IAAI,CAACL,kBAAkB,EAAE;gBACvD,OAAO,IAAI,CAACM,qBAAqB,CAChC,CAAC,2BAA2B,EAAE,AAACH,CAAAA,SAASE,cAAc,GAAG,GAAE,EAAGE,OAAO,CAAC,GAAG,MAAM,CAAC,EAChFJ;YAEF;YAEA,MAAMK,eAAeL,SAASE,cAAc,IAAI,IAAI,CAACN,iBAAiB,GAAG,YAAY;YAErF,OAAO,IAAI,CAACU,mBAAmB,CAAC;gBAC/B,GAAGN,QAAQ;gBACXK;gBACAE,kBAAkB,IAAI,CAACX,iBAAiB;gBACxCY,mBAAmB,IAAI,CAACX,kBAAkB;YAC3C;QACD;IACD;IAEUY,iBAAyB;QAClC,OAAO,CAAC,iDAAiD,EAAE,IAAI,CAACf,WAAW,EAAE;IAC9E;IAEA,MAAcO,mBAA2C;QACxD,IAAI;YACH,MAAMhB,GAAGyB,KAAK,CAAC,IAAI,CAAChB,WAAW,EAAE;gBAAEiB,WAAW;YAAK;YAEnD,MAAMC,QAAQ,MAAM3B,GAAG4B,MAAM,CAAC,IAAI,CAACnB,WAAW;YAE9C,MAAMoB,QAAQF,MAAMG,MAAM,GAAGH,MAAMI,KAAK;YACxC,MAAMC,OAAOL,MAAMM,MAAM,GAAGN,MAAMI,KAAK;YACvC,MAAMG,OAAOL,QAAQG;YACrB,MAAMf,iBAAiBiB,OAAOL;YAE9B,OAAO;gBACNA,OAAO,IAAI,CAACM,WAAW,CAACN;gBACxBG,MAAM,IAAI,CAACG,WAAW,CAACH;gBACvBE,MAAM,IAAI,CAACC,WAAW,CAACD;gBACvBjB;gBACAmB,MAAM,IAAI,CAAC3B,WAAW;YACvB;QACD,EACA,OAAO4B,OAAgB;YACtB,kDAAkD;YAClDC,QAAQD,KAAK,CAACA;YACd,OAAO,IAAI,CAACE,mBAAmB;QAChC;IACD;IAEA,MAAcA,sBAA8C;QAC3D,IAAI;YACH,OAAO;gBACNV,OAAO;gBACPG,MAAM;gBACNE,MAAM;gBACNjB,gBAAgB;gBAChBmB,MAAM,IAAI,CAAC3B,WAAW;YACvB;QACD,EACA,OAAO4B,OAAgB;YACtBC,QAAQD,KAAK,CAACA;YACd,MAAM,IAAIG,MAAM,CAAC,oCAAoC,EAAE,IAAI,CAAC/B,WAAW,EAAE;QAC1E;IACD;IAEQ0B,YAAYM,KAAa,EAAU;QAC1C,OAAOC,KAAKC,KAAK,CAACF,QAAS,CAAA,OAAO,IAAG;IACtC;IAEA;;EAEC,GACD,MAAMG,qBAA6C;QAClD,OAAO,IAAI,CAAC5B,gBAAgB;IAC7B;AACD"}