{"version":3,"sources":["../../../../../src/MediaStream/Health/base/base-health-indicator.ts"],"sourcesContent":["import type { HealthIndicatorResult } from '@nestjs/terminus'\r\nimport type { HealthCheckOptions, HealthMetrics, IHealthIndicator } from '../interfaces/health-indicator.interface'\r\nimport { Injectable, Logger } from '@nestjs/common'\r\n\r\n@Injectable()\r\nexport abstract class BaseHealthIndicator implements IHealthIndicator {\r\n\tprotected readonly logger: Logger\r\n\tprotected readonly options: HealthCheckOptions\r\n\tprivate lastCheck?: HealthMetrics\r\n\r\n\tconstructor(\r\n\t\tpublic readonly key: string,\r\n\t\toptions: HealthCheckOptions = {},\r\n\t) {\r\n\t\tthis.logger = new Logger(`${this.constructor.name}`)\r\n\t\tthis.options = {\r\n\t\t\ttimeout: 5000,\r\n\t\t\tretries: 3,\r\n\t\t\tthreshold: 0.8,\r\n\t\t\t...options,\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Public method to check health with error handling and metrics\r\n\t */\r\n\tasync isHealthy(): Promise<HealthIndicatorResult> {\r\n\t\tconst startTime = Date.now()\r\n\r\n\t\ttry {\r\n\t\t\tconst result = await this.performHealthCheck()\r\n\t\t\tconst responseTime = Date.now() - startTime\r\n\r\n\t\t\tthis.lastCheck = {\r\n\t\t\t\ttimestamp: Date.now(),\r\n\t\t\t\tstatus: 'healthy',\r\n\t\t\t\tresponseTime,\r\n\t\t\t\tdetails: result[this.key] || {},\r\n\t\t\t}\r\n\r\n\t\t\tthis.logger.debug(`Health check passed for ${this.key} in ${responseTime}ms`)\r\n\t\t\treturn result\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconst responseTime = Date.now() - startTime\r\n\r\n\t\t\tthis.lastCheck = {\r\n\t\t\t\ttimestamp: Date.now(),\r\n\t\t\t\tstatus: 'unhealthy',\r\n\t\t\t\tresponseTime,\r\n\t\t\t\tdetails: { error: error instanceof Error ? (error as Error).message : 'Unknown error' },\r\n\t\t\t}\r\n\r\n\t\t\tthis.logger.warn(`Health check failed for ${this.key}: ${error instanceof Error ? (error as Error).message : 'Unknown error'}`)\r\n\r\n\t\t\treturn {\r\n\t\t\t\t[this.key]: {\r\n\t\t\t\t\tstatus: 'down',\r\n\t\t\t\t\tmessage: error instanceof Error ? (error as Error).message : 'Health check failed',\r\n\t\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t\t\tresponseTime,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Get details about this health indicator including last check results\r\n\t */\r\n\tgetDetails(): Record<string, any> {\r\n\t\treturn {\r\n\t\t\tkey: this.key,\r\n\t\t\toptions: this.options,\r\n\t\t\tlastCheck: this.lastCheck,\r\n\t\t\tdescription: this.getDescription(),\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Get the last health check metrics\r\n\t */\r\n\tgetLastCheck(): HealthMetrics | undefined {\r\n\t\treturn this.lastCheck\r\n\t}\r\n\r\n\t/**\r\n\t * Abstract method that subclasses must implement to perform the actual health check\r\n\t */\r\n\tprotected abstract performHealthCheck(): Promise<HealthIndicatorResult>\r\n\r\n\t/**\r\n\t * Abstract method that subclasses should implement to provide a description\r\n\t */\r\n\tprotected abstract getDescription(): string\r\n\r\n\t/**\r\n\t * Helper method to create a healthy result\r\n\t */\r\n\tprotected createHealthyResult(details: Record<string, any> = {}): HealthIndicatorResult {\r\n\t\treturn {\r\n\t\t\t[this.key]: {\r\n\t\t\t\tstatus: 'up',\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t\t...details,\r\n\t\t\t},\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Helper method to create an unhealthy result\r\n\t */\r\n\tprotected createUnhealthyResult(message: string, _details: Record<string, any> = {}): HealthIndicatorResult {\r\n\t\tthrow new Error(`${this.key} health check failed: ${message}`)\r\n\t}\r\n\r\n\t/**\r\n\t * Helper method to execute with timeout\r\n\t */\r\n\tprotected async executeWithTimeout<T>(\r\n\t\toperation: () => Promise<T>,\r\n\t\ttimeoutMs: number = this.options.timeout || 5000,\r\n\t): Promise<T> {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst timer = setTimeout(() => {\r\n\t\t\t\treject(new Error(`Health check timeout after ${timeoutMs}ms`))\r\n\t\t\t}, timeoutMs)\r\n\r\n\t\t\toperation()\r\n\t\t\t\t.then(resolve)\r\n\t\t\t\t.catch(reject)\r\n\t\t\t\t.finally(() => clearTimeout(timer))\r\n\t\t})\r\n\t}\r\n}\r\n"],"names":["Injectable","Logger","BaseHealthIndicator","isHealthy","startTime","Date","now","result","performHealthCheck","responseTime","lastCheck","timestamp","status","details","key","logger","debug","error","Error","message","warn","toISOString","getDetails","options","description","getDescription","getLastCheck","createHealthyResult","createUnhealthyResult","_details","executeWithTimeout","operation","timeoutMs","timeout","Promise","resolve","reject","timer","setTimeout","then","catch","finally","clearTimeout","name","retries","threshold"],"mappings":";;;;;;;;;AAEA,SAASA,UAAU,EAAEC,MAAM,QAAQ,iBAAgB;AAGnD,OAAO,MAAeC;IAkBrB;;EAEC,GACD,MAAMC,YAA4C;QACjD,MAAMC,YAAYC,KAAKC,GAAG;QAE1B,IAAI;YACH,MAAMC,SAAS,MAAM,IAAI,CAACC,kBAAkB;YAC5C,MAAMC,eAAeJ,KAAKC,GAAG,KAAKF;YAElC,IAAI,CAACM,SAAS,GAAG;gBAChBC,WAAWN,KAAKC,GAAG;gBACnBM,QAAQ;gBACRH;gBACAI,SAASN,MAAM,CAAC,IAAI,CAACO,GAAG,CAAC,IAAI,CAAC;YAC/B;YAEA,IAAI,CAACC,MAAM,CAACC,KAAK,CAAC,CAAC,wBAAwB,EAAE,IAAI,CAACF,GAAG,CAAC,IAAI,EAAEL,aAAa,EAAE,CAAC;YAC5E,OAAOF;QACR,EACA,OAAOU,OAAgB;YACtB,MAAMR,eAAeJ,KAAKC,GAAG,KAAKF;YAElC,IAAI,CAACM,SAAS,GAAG;gBAChBC,WAAWN,KAAKC,GAAG;gBACnBM,QAAQ;gBACRH;gBACAI,SAAS;oBAAEI,OAAOA,iBAAiBC,QAAQ,AAACD,MAAgBE,OAAO,GAAG;gBAAgB;YACvF;YAEA,IAAI,CAACJ,MAAM,CAACK,IAAI,CAAC,CAAC,wBAAwB,EAAE,IAAI,CAACN,GAAG,CAAC,EAAE,EAAEG,iBAAiBC,QAAQ,AAACD,MAAgBE,OAAO,GAAG,iBAAiB;YAE9H,OAAO;gBACN,CAAC,IAAI,CAACL,GAAG,CAAC,EAAE;oBACXF,QAAQ;oBACRO,SAASF,iBAAiBC,QAAQ,AAACD,MAAgBE,OAAO,GAAG;oBAC7DR,WAAW,IAAIN,OAAOgB,WAAW;oBACjCZ;gBACD;YACD;QACD;IACD;IAEA;;EAEC,GACDa,aAAkC;QACjC,OAAO;YACNR,KAAK,IAAI,CAACA,GAAG;YACbS,SAAS,IAAI,CAACA,OAAO;YACrBb,WAAW,IAAI,CAACA,SAAS;YACzBc,aAAa,IAAI,CAACC,cAAc;QACjC;IACD;IAEA;;EAEC,GACDC,eAA0C;QACzC,OAAO,IAAI,CAAChB,SAAS;IACtB;IAYA;;EAEC,GACD,AAAUiB,oBAAoBd,UAA+B,CAAC,CAAC,EAAyB;QACvF,OAAO;YACN,CAAC,IAAI,CAACC,GAAG,CAAC,EAAE;gBACXF,QAAQ;gBACRD,WAAW,IAAIN,OAAOgB,WAAW;gBACjC,GAAGR,OAAO;YACX;QACD;IACD;IAEA;;EAEC,GACD,AAAUe,sBAAsBT,OAAe,EAAEU,WAAgC,CAAC,CAAC,EAAyB;QAC3G,MAAM,IAAIX,MAAM,GAAG,IAAI,CAACJ,GAAG,CAAC,sBAAsB,EAAEK,SAAS;IAC9D;IAEA;;EAEC,GACD,MAAgBW,mBACfC,SAA2B,EAC3BC,YAAoB,IAAI,CAACT,OAAO,CAACU,OAAO,IAAI,IAAI,EACnC;QACb,OAAO,IAAIC,QAAQ,CAACC,SAASC;YAC5B,MAAMC,QAAQC,WAAW;gBACxBF,OAAO,IAAIlB,MAAM,CAAC,2BAA2B,EAAEc,UAAU,EAAE,CAAC;YAC7D,GAAGA;YAEHD,YACEQ,IAAI,CAACJ,SACLK,KAAK,CAACJ,QACNK,OAAO,CAAC,IAAMC,aAAaL;QAC9B;IACD;IA1HA,YACC,AAAgBvB,GAAW,EAC3BS,UAA8B,CAAC,CAAC,CAC/B;aAFeT,MAAAA;QAGhB,IAAI,CAACC,MAAM,GAAG,IAAId,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC0C,IAAI,EAAE;QACnD,IAAI,CAACpB,OAAO,GAAG;YACdU,SAAS;YACTW,SAAS;YACTC,WAAW;YACX,GAAGtB,OAAO;QACX;IACD;AAgHD"}