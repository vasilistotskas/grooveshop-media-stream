{"version":3,"sources":["../../../../../src/MediaStream/HTTP/services/http-client.service.ts"],"sourcesContent":["import type { OnModuleDestroy, OnModuleInit } from '@nestjs/common'\r\nimport type { AxiosRequestConfig, AxiosResponse } from 'axios'\r\nimport type { HttpClientStats, IHttpClient } from '../interfaces/http-client.interface'\r\nimport * as http from 'node:http'\r\nimport { Agent as HttpAgent } from 'node:http'\r\nimport * as https from 'node:https'\r\nimport { Agent as HttpsAgent } from 'node:https'\r\nimport { performance } from 'node:perf_hooks'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { CorrelatedLogger } from '@microservice/Correlation/utils/logger.util'\r\nimport { HttpService } from '@nestjs/axios'\r\nimport { Injectable } from '@nestjs/common'\r\nimport { lastValueFrom, throwError, timer } from 'rxjs'\r\nimport { retry, tap } from 'rxjs/operators'\r\nimport { CircuitBreaker } from '../utils/circuit-breaker'\r\n\r\n@Injectable()\r\nexport class HttpClientService implements IHttpClient, OnModuleInit, OnModuleDestroy {\r\n\tprivate readonly circuitBreaker: CircuitBreaker\r\n\tprivate readonly httpAgent: HttpAgent\r\n\tprivate readonly httpsAgent: HttpsAgent\r\n\tprivate readonly stats: HttpClientStats = {\r\n\t\ttotalRequests: 0,\r\n\t\tsuccessfulRequests: 0,\r\n\t\tfailedRequests: 0,\r\n\t\tretriedRequests: 0,\r\n\t\taverageResponseTime: 0,\r\n\t\tcircuitBreakerState: 'closed',\r\n\t\tactiveRequests: 0,\r\n\t\tqueueSize: 0,\r\n\t}\r\n\r\n\tprivate totalResponseTime = 0\r\n\tprivate readonly maxRetries: number\r\n\tprivate readonly retryDelay: number\r\n\tprivate readonly maxRetryDelay: number\r\n\tprivate readonly timeout: number\r\n\r\n\tconstructor(\r\n\t\tprivate readonly _httpService: HttpService,\r\n\t\tprivate readonly _configService: ConfigService,\r\n\t) {\r\n\t\tthis.maxRetries = this._configService.getOptional('http.retry.retries', 3)\r\n\t\tthis.retryDelay = this._configService.getOptional('http.retry.retryDelay', 1000)\r\n\t\tthis.maxRetryDelay = this._configService.getOptional('http.retry.maxRetryDelay', 10000)\r\n\t\tthis.timeout = this._configService.getOptional('http.connectionPool.timeout', 30000)\r\n\r\n\t\tthis.circuitBreaker = new CircuitBreaker({\r\n\t\t\tfailureThreshold: this._configService.getOptional('http.circuitBreaker.failureThreshold', 50),\r\n\t\t\tresetTimeout: this._configService.getOptional('http.circuitBreaker.resetTimeout', 30000),\r\n\t\t\trollingWindow: this._configService.getOptional('http.circuitBreaker.monitoringPeriod', 60000),\r\n\t\t\tminimumRequests: this._configService.getOptional('http.circuitBreaker.minimumRequests', 10),\r\n\t\t})\r\n\r\n\t\tconst maxSockets = this._configService.getOptional('http.connectionPool.maxSockets', 50)\r\n\t\tconst keepAliveMsecs = this._configService.getOptional('http.connectionPool.keepAliveMsecs', 1000)\r\n\r\n\t\tthis.httpAgent = new http.Agent({\r\n\t\t\tkeepAlive: true,\r\n\t\t\tkeepAliveMsecs,\r\n\t\t\tmaxSockets,\r\n\t\t})\r\n\r\n\t\tthis.httpsAgent = new https.Agent({\r\n\t\t\tkeepAlive: true,\r\n\t\t\tkeepAliveMsecs,\r\n\t\t\tmaxSockets,\r\n\t\t})\r\n\r\n\t\tthis.configureAxios()\r\n\t}\r\n\r\n\tasync onModuleInit(): Promise<void> {\r\n\t\tCorrelatedLogger.log('HTTP client service initialized', HttpClientService.name)\r\n\t}\r\n\r\n\tasync onModuleDestroy(): Promise<void> {\r\n\t\tthis.httpAgent.destroy()\r\n\t\tthis.httpsAgent.destroy()\r\n\t\tCorrelatedLogger.log('HTTP client service destroyed', HttpClientService.name)\r\n\t}\r\n\r\n\t/**\r\n\t * Send a GET request\r\n\t */\r\n\tasync get<T = any>(url: string, config?: AxiosRequestConfig): Promise<AxiosResponse<T>> {\r\n\t\tconst encodedUrl = this.encodeUrl(url)\r\n\t\treturn this.executeRequest(() => this._httpService.get<T>(encodedUrl, this.prepareConfig(config)))\r\n\t}\r\n\r\n\t/**\r\n\t * Send a POST request\r\n\t */\r\n\tasync post<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<AxiosResponse<T>> {\r\n\t\treturn this.executeRequest(() => this._httpService.post<T>(url, data, this.prepareConfig(config)))\r\n\t}\r\n\r\n\t/**\r\n\t * Send a PUT request\r\n\t */\r\n\tasync put<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<AxiosResponse<T>> {\r\n\t\treturn this.executeRequest(() => this._httpService.put<T>(url, data, this.prepareConfig(config)))\r\n\t}\r\n\r\n\t/**\r\n\t * Send a DELETE request\r\n\t */\r\n\tasync delete<T = any>(url: string, config?: AxiosRequestConfig): Promise<AxiosResponse<T>> {\r\n\t\treturn this.executeRequest(() => this._httpService.delete<T>(url, this.prepareConfig(config)))\r\n\t}\r\n\r\n\t/**\r\n\t * Send a HEAD request\r\n\t */\r\n\tasync head<T = any>(url: string, config?: AxiosRequestConfig): Promise<AxiosResponse<T>> {\r\n\t\treturn this.executeRequest(() => this._httpService.head<T>(url, this.prepareConfig(config)))\r\n\t}\r\n\r\n\t/**\r\n\t * Send a PATCH request\r\n\t */\r\n\tasync patch<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<AxiosResponse<T>> {\r\n\t\treturn this.executeRequest(() => this._httpService.patch<T>(url, data, this.prepareConfig(config)))\r\n\t}\r\n\r\n\t/**\r\n\t * Send a request with custom config\r\n\t */\r\n\tasync request<T = any>(config: AxiosRequestConfig): Promise<AxiosResponse<T>> {\r\n\t\treturn this.executeRequest(() => this._httpService.request<T>(this.prepareConfig(config)))\r\n\t}\r\n\r\n\t/**\r\n\t * Get client statistics\r\n\t */\r\n\tgetStats(): HttpClientStats {\r\n\t\treturn {\r\n\t\t\t...this.stats,\r\n\t\t\tcircuitBreakerState: this.circuitBreaker.getState(),\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Reset client statistics\r\n\t */\r\n\tresetStats(): void {\r\n\t\tthis.stats.totalRequests = 0\r\n\t\tthis.stats.successfulRequests = 0\r\n\t\tthis.stats.failedRequests = 0\r\n\t\tthis.stats.retriedRequests = 0\r\n\t\tthis.stats.averageResponseTime = 0\r\n\t\tthis.totalResponseTime = 0\r\n\t\tCorrelatedLogger.debug('HTTP client statistics reset', HttpClientService.name)\r\n\t}\r\n\r\n\t/**\r\n\t * Check if the circuit breaker is open\r\n\t */\r\n\tisCircuitOpen(): boolean {\r\n\t\treturn this.circuitBreaker.isOpen()\r\n\t}\r\n\r\n\t/**\r\n\t * Reset the circuit breaker\r\n\t */\r\n\tresetCircuitBreaker(): void {\r\n\t\tthis.circuitBreaker.reset()\r\n\t}\r\n\r\n\t/**\r\n\t * Execute a request with circuit breaker and retry logic\r\n\t */\r\n\tprivate async executeRequest<T>(requestFn: () => any): Promise<AxiosResponse<T>> {\r\n\t\tif (this.circuitBreaker.isOpen()) {\r\n\t\t\tthrow new Error('Circuit breaker is open')\r\n\t\t}\r\n\r\n\t\tconst startTime = performance.now()\r\n\t\tthis.stats.activeRequests++\r\n\t\tthis.stats.totalRequests++\r\n\r\n\t\ttry {\r\n\t\t\tconst response: AxiosResponse<T> = await lastValueFrom(\r\n\t\t\t\trequestFn().pipe(\r\n\t\t\t\t\tretry({\r\n\t\t\t\t\t\tcount: this.maxRetries,\r\n\t\t\t\t\t\tdelay: (error, retryCount) => {\r\n\t\t\t\t\t\t\tif (!this.isRetryableError(error)) {\r\n\t\t\t\t\t\t\t\treturn throwError(() => error)\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tthis.stats.retriedRequests++\r\n\r\n\t\t\t\t\t\t\tconst delayMs = Math.min(\r\n\t\t\t\t\t\t\t\tthis.retryDelay * 2 ** (retryCount - 1),\r\n\t\t\t\t\t\t\t\tthis.maxRetryDelay,\r\n\t\t\t\t\t\t\t)\r\n\r\n\t\t\t\t\t\t\tCorrelatedLogger.warn(\r\n\t\t\t\t\t\t\t\t`Retrying request (attempt ${retryCount}/${this.maxRetries}) after ${delayMs}ms: ${(error as Error).message}`,\r\n\t\t\t\t\t\t\t\tHttpClientService.name,\r\n\t\t\t\t\t\t\t)\r\n\r\n\t\t\t\t\t\t\treturn timer(delayMs)\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t}),\r\n\t\t\t\t\ttap({\r\n\t\t\t\t\t\terror: (error: unknown) => {\r\n\t\t\t\t\t\t\tthis.stats.failedRequests++\r\n\t\t\t\t\t\t\tthis.circuitBreaker.recordFailure()\r\n\t\t\t\t\t\t\tCorrelatedLogger.error(\r\n\t\t\t\t\t\t\t\t`HTTP request failed: ${(error as Error).message}`,\r\n\t\t\t\t\t\t\t\t(error as Error).stack,\r\n\t\t\t\t\t\t\t\tHttpClientService.name,\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tnext: (response: AxiosResponse<T>) => {\r\n\t\t\t\t\t\t\tthis.stats.successfulRequests++\r\n\t\t\t\t\t\t\tthis.circuitBreaker.recordSuccess()\r\n\t\t\t\t\t\t\tCorrelatedLogger.debug(\r\n\t\t\t\t\t\t\t\t`HTTP request succeeded: ${response.config?.method?.toUpperCase()} ${response.config?.url} ${response.status}`,\r\n\t\t\t\t\t\t\t\tHttpClientService.name,\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t}),\r\n\t\t\t\t),\r\n\t\t\t)\r\n\r\n\t\t\tconst responseTime = performance.now() - startTime\r\n\t\t\tthis.totalResponseTime += responseTime\r\n\t\t\tthis.stats.averageResponseTime = this.totalResponseTime / this.stats.successfulRequests\r\n\r\n\t\t\treturn response\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconst responseTime = performance.now() - startTime\r\n\t\t\tthis.totalResponseTime += responseTime\r\n\r\n\t\t\tthrow error\r\n\t\t}\r\n\t\tfinally {\r\n\t\t\tthis.stats.activeRequests--\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Check if an error is retryable\r\n\t */\r\n\tprivate isRetryableError(error: any): boolean {\r\n\t\tif ((error as any).code && ['ECONNRESET', 'ETIMEDOUT', 'ECONNREFUSED', 'ENOTFOUND'].includes((error as any).code)) {\r\n\t\t\treturn true\r\n\t\t}\r\n\r\n\t\tif (error.response && [408, 429, 500, 502, 503, 504].includes(error.response.status)) {\r\n\t\t\treturn true\r\n\t\t}\r\n\r\n\t\treturn false\r\n\t}\r\n\r\n\t/**\r\n\t * Prepare request configuration\r\n\t */\r\n\tprivate prepareConfig(config: AxiosRequestConfig = {}): AxiosRequestConfig {\r\n\t\treturn {\r\n\t\t\t...config,\r\n\t\t\ttimeout: config.timeout || this.timeout,\r\n\t\t\thttpAgent: this.httpAgent,\r\n\t\t\thttpsAgent: this.httpsAgent,\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Configure axios defaults\r\n\t */\r\n\tprivate configureAxios(): void {\r\n\t\tthis._httpService.axiosRef.defaults.timeout = this.timeout\r\n\t}\r\n\r\n\t/**\r\n\t * Encode URL to handle non-ASCII characters properly\r\n\t */\r\n\tprivate encodeUrl(url: string): string {\r\n\t\ttry {\r\n\t\t\tconst urlObj = new URL(url)\r\n\r\n\t\t\tconst pathSegments = urlObj.pathname.split('/').map((segment) => {\r\n\t\t\t// eslint-disable-next-line no-control-regex\r\n\t\t\t\tif (/[^\\u0000-\\u007F]/.test(segment)) {\r\n\t\t\t\t\treturn encodeURIComponent(segment)\r\n\t\t\t\t}\r\n\t\t\t\treturn segment\r\n\t\t\t})\r\n\r\n\t\t\turlObj.pathname = pathSegments.join('/')\r\n\r\n\t\t\treturn urlObj.toString()\r\n\t\t}\r\n\t\tcatch (error) {\r\n\t\t\tCorrelatedLogger.warn(`Failed to encode URL: ${url} - ${(error as Error).message}`, HttpClientService.name)\r\n\t\t\treturn url\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["http","https","performance","ConfigService","CorrelatedLogger","HttpService","Injectable","lastValueFrom","throwError","timer","retry","tap","CircuitBreaker","HttpClientService","_httpService","_configService","stats","totalRequests","successfulRequests","failedRequests","retriedRequests","averageResponseTime","circuitBreakerState","activeRequests","queueSize","totalResponseTime","maxRetries","getOptional","retryDelay","maxRetryDelay","timeout","circuitBreaker","failureThreshold","resetTimeout","rollingWindow","minimumRequests","maxSockets","keepAliveMsecs","httpAgent","Agent","keepAlive","httpsAgent","configureAxios","onModuleInit","log","name","onModuleDestroy","destroy","get","url","config","encodedUrl","encodeUrl","executeRequest","prepareConfig","post","data","put","delete","head","patch","request","getStats","getState","resetStats","debug","isCircuitOpen","isOpen","resetCircuitBreaker","reset","requestFn","Error","startTime","now","response","pipe","count","delay","error","retryCount","isRetryableError","delayMs","Math","min","warn","message","recordFailure","stack","next","recordSuccess","method","toUpperCase","status","responseTime","code","includes","axiosRef","defaults","urlObj","URL","pathSegments","pathname","split","map","segment","test","encodeURIComponent","join","toString"],"mappings":"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"}