{"version":3,"sources":["../../../../../src/MediaStream/API/controllers/media-stream-image-rest.controller.ts"],"sourcesContent":["import type ResourceMetaData from '@microservice/HTTP/dto/resource-meta-data.dto'\r\nimport type { Response } from 'express'\r\nimport { Buffer } from 'node:buffer'\r\nimport { createHash } from 'node:crypto'\r\nimport { open } from 'node:fs/promises'\r\nimport * as process from 'node:process'\r\nimport CacheImageRequest, {\r\n\tBackgroundOptions,\r\n\tFitOptions,\r\n\tPositionOptions,\r\n\tResizeOptions,\r\n\tSupportedResizeFormats,\r\n} from '@microservice/API/dto/cache-image-request.dto'\r\nimport CacheImageResourceOperation from '@microservice/Cache/operations/cache-image-resource.operation'\r\nimport { IMAGE, VERSION } from '@microservice/common/constants/route-prefixes.constant'\r\nimport {\r\n\tDefaultImageFallbackError,\r\n\tInvalidRequestError,\r\n\tResourceStreamingError,\r\n} from '@microservice/common/errors/media-stream.errors'\r\nimport { CorrelationService } from '@microservice/Correlation/services/correlation.service'\r\nimport { PerformanceTracker } from '@microservice/Correlation/utils/performance-tracker.util'\r\nimport { MetricsService } from '@microservice/Metrics/services/metrics.service'\r\nimport { AdaptiveRateLimitGuard } from '@microservice/RateLimit/guards/adaptive-rate-limit.guard'\r\nimport { InputSanitizationService } from '@microservice/Validation/services/input-sanitization.service'\r\nimport { SecurityCheckerService } from '@microservice/Validation/services/security-checker.service'\r\nimport { Controller, Get, Logger, Param, Res, Scope, UseGuards } from '@nestjs/common'\r\n\r\n@Controller({\r\n\tpath: IMAGE,\r\n\tversion: VERSION,\r\n\tscope: Scope.REQUEST,\r\n})\r\n@UseGuards(AdaptiveRateLimitGuard)\r\nexport default class MediaStreamImageRESTController {\r\n\tprivate readonly _logger = new Logger(MediaStreamImageRESTController.name)\r\n\r\n\tconstructor(\r\n\t\tprivate readonly cacheImageResourceOperation: CacheImageResourceOperation,\r\n\t\tprivate readonly inputSanitizationService: InputSanitizationService,\r\n\t\tprivate readonly securityCheckerService: SecurityCheckerService,\r\n\t\tprivate readonly _correlationService: CorrelationService,\r\n\t\tprivate readonly metricsService: MetricsService,\r\n\t) {}\r\n\r\n\t/**\r\n\t * Validates request parameters using the new validation infrastructure\r\n\t */\r\n\tprivate async validateRequestParameters(params: any): Promise<void> {\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\r\n\t\tif (params.imageType) {\r\n\t\t\tconst isMalicious = await this.securityCheckerService.checkForMaliciousContent(params.imageType)\r\n\t\t\tif (isMalicious) {\r\n\t\t\t\tthrow new InvalidRequestError('Invalid imageType parameter', {\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\timageType: params.imageType,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (params.image) {\r\n\t\t\tconst isMalicious = await this.securityCheckerService.checkForMaliciousContent(params.image)\r\n\t\t\tif (isMalicious) {\r\n\t\t\t\tthrow new InvalidRequestError('Invalid image parameter', {\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\timage: params.image,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (params.width !== null && params.width !== undefined) {\r\n\t\t\tconst width = Number(params.width)\r\n\t\t\tif (Number.isNaN(width) || width < 1 || width > 5000) {\r\n\t\t\t\tthrow new InvalidRequestError('Invalid width parameter', {\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\twidth: params.width,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (params.height !== null && params.height !== undefined) {\r\n\t\t\tconst height = Number(params.height)\r\n\t\t\tif (Number.isNaN(height) || height < 1 || height > 5000) {\r\n\t\t\t\tthrow new InvalidRequestError('Invalid height parameter', {\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\theight: params.height,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (params.quality !== undefined) {\r\n\t\t\tconst quality = Number(params.quality)\r\n\t\t\tif (Number.isNaN(quality) || quality < 1 || quality > 100) {\r\n\t\t\t\tthrow new InvalidRequestError('Invalid quality parameter', {\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\tquality: params.quality,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (params.trimThreshold !== undefined) {\r\n\t\t\tconst trimThreshold = Number(params.trimThreshold)\r\n\t\t\tif (Number.isNaN(trimThreshold) || trimThreshold < 0 || trimThreshold > 100) {\r\n\t\t\t\tthrow new InvalidRequestError('Invalid trimThreshold parameter', {\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\ttrimThreshold: params.trimThreshold,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Generates an ETag for cache validation\r\n\t */\r\n\tprivate generateETag(input: Buffer | string): string {\r\n\t\tconst hash = createHash('md5')\r\n\t\thash.update(Buffer.isBuffer(input) ? input : Buffer.from(input))\r\n\t\treturn `\"${hash.digest('hex')}\"`\r\n\t}\r\n\r\n\t/**\r\n\t * Adds required headers to the response with correlation ID\r\n\t *\r\n\t * @param res\r\n\t * @param headers\r\n\t * @param etag Optional ETag for cache validation\r\n\t * @protected\r\n\t */\r\n\tprotected addHeadersToRequest(res: Response, headers: ResourceMetaData, etag?: string): Response {\r\n\t\tif (!headers) {\r\n\t\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\t\t\tthrow new InvalidRequestError('Headers object is undefined', {\r\n\t\t\t\theaders,\r\n\t\t\t\tcorrelationId,\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tconst size = headers.size !== undefined ? headers.size.toString() : '0'\r\n\t\tconst format = headers.format || 'png'\r\n\t\tconst publicTTL = headers.publicTTL || 0\r\n\t\tconst expiresAt = Date.now() + publicTTL\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\r\n\t\tres\r\n\t\t\t.header('Content-Length', size)\r\n\t\t\t.header('Cache-Control', `max-age=${publicTTL / 1000}, public, immutable`)\r\n\t\t\t.header('Expires', new Date(expiresAt).toUTCString())\r\n\t\t\t.header('X-Correlation-ID', correlationId || 'unknown')\r\n\t\t\t.header('Vary', 'Accept-Encoding')\r\n\r\n\t\tif (etag) {\r\n\t\t\tres.header('ETag', etag)\r\n\t\t}\r\n\r\n\t\tif (format === 'svg') {\r\n\t\t\tres.header('Content-Type', 'image/svg+xml')\r\n\t\t}\r\n\t\telse {\r\n\t\t\tres.header('Content-Type', `image/${format}`)\r\n\t\t}\r\n\r\n\t\treturn res\r\n\t}\r\n\r\n\t/**\r\n\t * Handles streaming the resource or falling back to the default image.\r\n\t *\r\n\t * @param request\r\n\t * @param res\r\n\t * @protected\r\n\t */\r\n\tprivate async handleStreamOrFallback(request: CacheImageRequest, res: Response): Promise<void> {\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\t\tPerformanceTracker.startPhase('image_request_processing')\r\n\r\n\t\ttry {\r\n\t\t\tthis.metricsService.recordError('image_requests', 'total')\r\n\r\n\t\t\tawait this.cacheImageResourceOperation.setup(request)\r\n\r\n\t\t\tif (await this.cacheImageResourceOperation.resourceExists) {\r\n\t\t\t\tthis._logger.debug('Resource exists, attempting to stream.', {\r\n\t\t\t\t\trequest,\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t})\r\n\t\t\t\tawait this.streamResource(request, res)\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis._logger.debug('Resource does not exist, attempting to fetch or fallback to default.', {\r\n\t\t\t\t\trequest,\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t})\r\n\r\n\t\t\t\tconst shouldUseQueue = this.cacheImageResourceOperation.shouldUseBackgroundProcessing\r\n\t\t\t\t\t&& this.cacheImageResourceOperation.shouldUseBackgroundProcessing()\r\n\r\n\t\t\t\tawait this.cacheImageResourceOperation.execute()\r\n\r\n\t\t\t\tconst maxWaitTime = shouldUseQueue ? 15000 : 10000\r\n\t\t\t\tconst pollInterval = 150\r\n\t\t\t\tlet waitTime = 0\r\n\r\n\t\t\t\twhile (waitTime < maxWaitTime) {\r\n\t\t\t\t\tif (await this.cacheImageResourceOperation.resourceExists) {\r\n\t\t\t\t\t\tthis._logger.debug('Resource became available after waiting', {\r\n\t\t\t\t\t\t\twaitTime,\r\n\t\t\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\tawait this.streamResource(request, res)\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\t\t\t\t\tawait new Promise(resolve => setTimeout(resolve, pollInterval))\r\n\t\t\t\t\twaitTime += pollInterval\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (waitTime >= maxWaitTime) {\r\n\t\t\t\t\tthis._logger.warn('Timeout waiting for resource to be processed', {\r\n\t\t\t\t\t\twaitTime,\r\n\t\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\t\twasQueued: shouldUseQueue,\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\r\n\t\t\t\tawait this.defaultImageFallback(request, res)\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconst context = { request, error, correlationId }\r\n\r\n\t\t\tconst errorMessage = (error as Error).message || ''\r\n\t\t\tif (errorMessage.includes('Circuit breaker is open')) {\r\n\t\t\t\tthis._logger.warn(\r\n\t\t\t\t\t'Circuit breaker is open, serving fallback immediately',\r\n\t\t\t\t\tcontext,\r\n\t\t\t\t)\r\n\t\t\t\tthis.metricsService.recordError('image_request', 'circuit_breaker_open')\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis._logger.error(\r\n\t\t\t\t\t`Error while processing the image request: ${errorMessage}`,\r\n\t\t\t\t\terror,\r\n\t\t\t\t\tcontext,\r\n\t\t\t\t)\r\n\t\t\t\tconst errorName = error instanceof Error ? error.constructor.name : 'UnknownError'\r\n\t\t\t\tthis.metricsService.recordError('image_request', errorName)\r\n\t\t\t}\r\n\r\n\t\t\tawait this.defaultImageFallback(request, res)\r\n\t\t}\r\n\t\tfinally {\r\n\t\t\tPerformanceTracker.endPhase('image_request_processing')\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Streams the requested resource if it exists.\r\n\t *\r\n\t * @param request\r\n\t * @param res\r\n\t * @protected\r\n\t */\r\n\t/**\r\n\t * Streams a file to the response.\r\n\t *\r\n\t * @param filePath The path to the file to stream\r\n\t * @param headers The headers to add to the response\r\n\t * @param res The response object\r\n\t * @returns A promise that resolves when the file has been streamed\r\n\t * @private\r\n\t */\r\n\tprivate async streamFileToResponse(filePath: string, headers: ResourceMetaData, res: Response): Promise<void> {\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\t\tPerformanceTracker.startPhase('file_streaming')\r\n\t\tlet fd = null as any\r\n\r\n\t\ttry {\r\n\t\t\tthis._logger.debug(`Streaming file: ${filePath}`, {\r\n\t\t\t\tfilePath,\r\n\t\t\t\theaders,\r\n\t\t\t\tcorrelationId,\r\n\t\t\t})\r\n\r\n\t\t\tfd = await open(filePath, 'r')\r\n\t\t\tres = this.addHeadersToRequest(res, headers)\r\n\r\n\t\t\tconst fileStream = fd.createReadStream()\r\n\r\n\t\t\tif (typeof res.on === 'function') {\r\n\t\t\t\tfileStream.pipe(res)\r\n\r\n\t\t\t\tawait new Promise<void>((resolve, reject) => {\r\n\t\t\t\t\tfileStream.on('end', () => {\r\n\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t})\r\n\t\t\t\t\tfileStream.on('error', (error: unknown) => {\r\n\t\t\t\t\t\tconst context = { filePath, headers, error, correlationId }\r\n\t\t\t\t\t\tthis._logger.error(`Stream error: ${(error as Error).message || error}`, error, context)\r\n\t\t\t\t\t\tthis.metricsService.recordError('file_stream', 'stream_error')\r\n\t\t\t\t\t\treject(new ResourceStreamingError('Error streaming file', context))\r\n\t\t\t\t\t})\r\n\t\t\t\t\tres.on('close', () => {\r\n\t\t\t\t\t\tfileStream.destroy()\r\n\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthrow new InvalidRequestError('Response object is not a writable stream', {\r\n\t\t\t\t\tfilePath,\r\n\t\t\t\t\theaders,\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tif ((error as any).name !== 'ResourceStreamingError') {\r\n\t\t\t\tthrow new ResourceStreamingError('Failed to stream file', {\r\n\t\t\t\t\tfilePath,\r\n\t\t\t\t\terror: (error as Error).message || error,\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tthrow error\r\n\t\t}\r\n\t\tfinally {\r\n\t\t\tPerformanceTracker.endPhase('file_streaming')\r\n\r\n\t\t\tif (fd) {\r\n\t\t\t\tawait fd.close().catch((err: unknown) => {\r\n\t\t\t\t\tthis._logger.error(`Error closing file descriptor: ${(err as Error).message || err}`, err, {\r\n\t\t\t\t\t\tfilePath,\r\n\t\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async streamResource(request: CacheImageRequest, res: Response): Promise<void> {\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\t\tconst headers = await this.cacheImageResourceOperation.getHeaders\r\n\r\n\t\tif (!headers) {\r\n\t\t\tthis._logger.warn('Resource metadata is missing or invalid.', {\r\n\t\t\t\trequest,\r\n\t\t\t\tcorrelationId,\r\n\t\t\t})\r\n\t\t\tawait this.defaultImageFallback(request, res)\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconst cachedResource = await this.cacheImageResourceOperation.getCachedResource()\r\n\t\t\tif (cachedResource && cachedResource.data) {\r\n\t\t\t\tres = this.addHeadersToRequest(res, headers)\r\n\r\n\t\t\t\tlet imageData: Buffer\r\n\t\t\t\tif (typeof cachedResource.data === 'string') {\r\n\t\t\t\t\timageData = Buffer.from(cachedResource.data, 'base64')\r\n\t\t\t\t}\r\n\t\t\t\telse if (Buffer.isBuffer(cachedResource.data)) {\r\n\t\t\t\t\timageData = cachedResource.data\r\n\t\t\t\t}\r\n\t\t\t\telse if (cachedResource.data && typeof cachedResource.data === 'object' && 'data' in cachedResource.data) {\r\n\t\t\t\t\timageData = Buffer.from((cachedResource.data as any).data)\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis._logger.warn('Unexpected data type in cached resource, falling back to file streaming', {\r\n\t\t\t\t\t\tdataType: typeof cachedResource.data,\r\n\t\t\t\t\t\tcorrelationId: this._correlationService.getCorrelationId(),\r\n\t\t\t\t\t})\r\n\t\t\t\t\tawait this.streamFileToResponse(\r\n\t\t\t\t\t\tthis.cacheImageResourceOperation.getResourcePath,\r\n\t\t\t\t\t\theaders,\r\n\t\t\t\t\t\tres,\r\n\t\t\t\t\t)\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\r\n\t\t\t\tres.end(imageData)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\tawait this.streamFileToResponse(\r\n\t\t\t\tthis.cacheImageResourceOperation.getResourcePath,\r\n\t\t\t\theaders,\r\n\t\t\t\tres,\r\n\t\t\t)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconst context = {\r\n\t\t\t\trequest,\r\n\t\t\t\tresourcePath: this.cacheImageResourceOperation.getResourcePath,\r\n\t\t\t\terror: (error as Error).message || error,\r\n\t\t\t\tcorrelationId,\r\n\t\t\t}\r\n\t\t\tthis._logger.error(`Error while streaming resource: ${(error as Error).message || error}`, error, context)\r\n\t\t\tawait this.defaultImageFallback(request, res)\r\n\t\t}\r\n\t\tfinally {\r\n\t\t\tawait this.cacheImageResourceOperation.execute()\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Fetches the resource, processes it, and streams it.\r\n\t *\r\n\t * @param request\r\n\t * @param res\r\n\t * @protected\r\n\t */\r\n\tprivate async fetchAndStreamResource(request: CacheImageRequest, res: Response): Promise<void> {\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\r\n\t\ttry {\r\n\t\t\tawait this.cacheImageResourceOperation.execute()\r\n\r\n\t\t\tif (this.cacheImageResourceOperation.shouldUseBackgroundProcessing && this.cacheImageResourceOperation.shouldUseBackgroundProcessing()) {\r\n\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 100))\r\n\t\t\t}\r\n\r\n\t\t\tconst headers = await this.cacheImageResourceOperation.getHeaders\r\n\r\n\t\t\tif (!headers) {\r\n\t\t\t\tthis._logger.warn('Failed to fetch resource or generate headers.', {\r\n\t\t\t\t\trequest,\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t})\r\n\t\t\t\tawait this.defaultImageFallback(request, res)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\tconst cachedResource = await this.cacheImageResourceOperation.getCachedResource()\r\n\t\t\tif (cachedResource && cachedResource.data) {\r\n\t\t\t\tres = this.addHeadersToRequest(res, headers)\r\n\t\t\t\tconst imageData = typeof cachedResource.data === 'string'\r\n\t\t\t\t\t? Buffer.from(cachedResource.data, 'base64')\r\n\t\t\t\t\t: cachedResource.data\r\n\t\t\t\tres.end(imageData)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\tawait this.streamFileToResponse(\r\n\t\t\t\tthis.cacheImageResourceOperation.getResourcePath,\r\n\t\t\t\theaders,\r\n\t\t\t\tres,\r\n\t\t\t)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconst context = {\r\n\t\t\t\trequest,\r\n\t\t\t\tresourcePath: this.cacheImageResourceOperation.getResourcePath,\r\n\t\t\t\terror: (error as Error).message || error,\r\n\t\t\t\tcorrelationId,\r\n\t\t\t}\r\n\t\t\tthis._logger.error(`Error during resource fetch and stream: ${(error as Error).message || error}`, error, context)\r\n\t\t\tawait this.defaultImageFallback(request, res)\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Provides a fallback to serve a default image in case of errors or missing resources.\r\n\t *\r\n\t * @param request\r\n\t * @param res\r\n\t * @protected\r\n\t */\r\n\tprivate async defaultImageFallback(request: CacheImageRequest, res: Response): Promise<void> {\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\r\n\t\ttry {\r\n\t\t\tconst optimizedDefaultImagePath = await this.cacheImageResourceOperation.optimizeAndServeDefaultImage(\r\n\t\t\t\trequest.resizeOptions,\r\n\t\t\t)\r\n\r\n\t\t\tres.header('X-Correlation-ID', correlationId || 'unknown')\r\n\t\t\tres.sendFile(optimizedDefaultImagePath)\r\n\t\t}\r\n\t\tcatch (defaultImageError: unknown) {\r\n\t\t\tconst errorMessage = defaultImageError instanceof Error ? defaultImageError.message : String(defaultImageError)\r\n\t\t\tconst context = {\r\n\t\t\t\trequest,\r\n\t\t\t\tresizeOptions: request.resizeOptions,\r\n\t\t\t\terror: errorMessage,\r\n\t\t\t\tcorrelationId,\r\n\t\t\t}\r\n\t\t\tthis._logger.error(`Failed to serve default image: ${errorMessage}`, defaultImageError, context)\r\n\t\t\tthis.metricsService.recordError('default_image_fallback', 'fallback_error')\r\n\t\t\tthrow new DefaultImageFallbackError('Failed to process the image request', context)\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Prepares the resource target URL by ensuring proper decoding of URL-encoded characters.\r\n\t * This is critical for handling Greek and other non-ASCII characters in filenames.\r\n\t *\r\n\t * @param resourceTarget The raw resource target URL\r\n\t * @returns The properly decoded resource target URL\r\n\t */\r\n\tprivate static resourceTargetPrepare(resourceTarget: string): string {\r\n\t\ttry {\r\n\t\t\tif (resourceTarget.includes('%')) {\r\n\t\t\t\treturn decodeURIComponent(resourceTarget)\r\n\t\t\t}\r\n\t\t\treturn resourceTarget\r\n\t\t}\r\n\t\tcatch {\r\n\t\t\treturn resourceTarget\r\n\t\t}\r\n\t}\r\n\r\n\t@Get(\r\n\t\t'media/uploads/:imageType/:image/:width/:height/:fit/:position/:background/:trimThreshold/:format/:quality',\r\n\t)\r\n\tpublic async uploadedImage(\r\n\t\t@Param('imageType') imageType: string,\r\n\t\t@Param('image') image: string,\r\n\t\t@Param('width') width: number | null = null,\r\n\t\t@Param('height') height: number | null = null,\r\n\t\t@Param('fit') fit: FitOptions = FitOptions.contain,\r\n\t\t@Param('position') position = PositionOptions.entropy,\r\n\t\t@Param('background') background = BackgroundOptions.transparent,\r\n\t\t@Param('trimThreshold') trimThreshold = 5,\r\n\t\t@Param('format') format: SupportedResizeFormats = SupportedResizeFormats.webp,\r\n\t\t@Param('quality') quality = 80,\r\n\r\n\t\t@Res() res: Response,\r\n\t): Promise<void> {\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\t\tPerformanceTracker.startPhase('uploaded_image_request')\r\n\r\n\t\ttry {\r\n\t\t\tconst decodedImageType = decodeURIComponent(imageType)\r\n\t\t\tconst decodedImage = decodeURIComponent(image)\r\n\r\n\t\t\tawait this.validateRequestParameters({\r\n\t\t\t\timageType: decodedImageType,\r\n\t\t\t\timage: decodedImage,\r\n\t\t\t\twidth,\r\n\t\t\t\theight,\r\n\t\t\t\tquality,\r\n\t\t\t\ttrimThreshold,\r\n\t\t\t})\r\n\r\n\t\t\tconst resizeOptions = new ResizeOptions({\r\n\t\t\t\twidth: width ? Number(width) : null,\r\n\t\t\t\theight: height ? Number(height) : null,\r\n\t\t\t\tposition,\r\n\t\t\t\tbackground,\r\n\t\t\t\tfit,\r\n\t\t\t\ttrimThreshold: Number(trimThreshold),\r\n\t\t\t\tformat,\r\n\t\t\t\tquality: Number(quality),\r\n\t\t\t})\r\n\r\n\t\t\tthis._logger.debug(`Created ResizeOptions:`, {\r\n\t\t\t\tresizeOptions: JSON.stringify(resizeOptions, null, 2),\r\n\t\t\t\tcorrelationId,\r\n\t\t\t})\r\n\r\n\t\t\tconst djangoApiUrl = process.env.NEST_PUBLIC_DJANGO_URL || 'http://localhost:8000'\r\n\t\t\tconst resourceUrl = `${djangoApiUrl}/media/uploads/${decodedImageType}/${decodedImage}`\r\n\r\n\t\t\tconst isValidUrl = this.inputSanitizationService.validateUrl(resourceUrl)\r\n\t\t\tif (!isValidUrl) {\r\n\t\t\t\tthrow new InvalidRequestError('Invalid resource URL', {\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\tresourceUrl,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\r\n\t\t\tconst request = new CacheImageRequest({\r\n\t\t\t\tresourceTarget: MediaStreamImageRESTController.resourceTargetPrepare(resourceUrl),\r\n\t\t\t\tresizeOptions,\r\n\t\t\t})\r\n\r\n\t\t\tthis._logger.debug(`Uploaded image request`, {\r\n\t\t\t\trequest: {\r\n\t\t\t\t\timageType: decodedImageType,\r\n\t\t\t\t\timage: decodedImage,\r\n\t\t\t\t\twidth,\r\n\t\t\t\t\theight,\r\n\t\t\t\t\tformat,\r\n\t\t\t\t\tquality,\r\n\t\t\t\t},\r\n\t\t\t\tcorrelationId,\r\n\t\t\t})\r\n\r\n\t\t\tres.locals.requestedFormat = format\r\n\t\t\tres.locals.originalUrl = resourceUrl\r\n\r\n\t\t\tawait this.handleStreamOrFallback(request, res)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconst context = {\r\n\t\t\t\timageType,\r\n\t\t\t\timage,\r\n\t\t\t\twidth,\r\n\t\t\t\theight,\r\n\t\t\t\tformat,\r\n\t\t\t\tquality,\r\n\t\t\t\tcorrelationId,\r\n\t\t\t\terror: (error as Error).message || error,\r\n\t\t\t}\r\n\t\t\tthis._logger.error(`Error in uploadedImage: ${(error as Error).message || error}`, error, context)\r\n\t\t\tconst errorName = error instanceof Error ? error.constructor.name : 'UnknownError'\r\n\t\t\tthis.metricsService.recordError('uploaded_image_request', errorName)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t\tfinally {\r\n\t\t\tPerformanceTracker.endPhase('uploaded_image_request')\r\n\t\t}\r\n\t}\r\n\r\n\t@Get('static/images/:image/:width/:height/:fit/:position/:background/:trimThreshold/:format/:quality')\r\n\tpublic async staticImage(\r\n\t\t@Param('image') image: string,\r\n\t\t@Param('width') width: number | null = null,\r\n\t\t@Param('height') height: number | null = null,\r\n\t\t@Param('fit') fit: FitOptions = FitOptions.contain,\r\n\t\t@Param('position') position = PositionOptions.entropy,\r\n\t\t@Param('background') background = BackgroundOptions.transparent,\r\n\t\t@Param('trimThreshold') trimThreshold = 5,\r\n\t\t@Param('format') format: SupportedResizeFormats = SupportedResizeFormats.webp,\r\n\t\t@Param('quality') quality = 80,\r\n\r\n\t\t@Res() res: Response,\r\n\t): Promise<void> {\r\n\t\tconst correlationId = this._correlationService.getCorrelationId()\r\n\t\tPerformanceTracker.startPhase('static_image_request')\r\n\r\n\t\ttry {\r\n\t\t\tconst decodedImage = decodeURIComponent(image)\r\n\r\n\t\t\tawait this.validateRequestParameters({\r\n\t\t\t\timage: decodedImage,\r\n\t\t\t\twidth,\r\n\t\t\t\theight,\r\n\t\t\t\tquality,\r\n\t\t\t\ttrimThreshold,\r\n\t\t\t})\r\n\r\n\t\t\tconst djangoApiUrl = process.env.NEST_PUBLIC_DJANGO_URL || 'http://localhost:8000'\r\n\t\t\tconst resourceUrl = `${djangoApiUrl}/static/images/${decodedImage}`\r\n\r\n\t\t\tconst isValidUrl = this.inputSanitizationService.validateUrl(resourceUrl)\r\n\t\t\tif (!isValidUrl) {\r\n\t\t\t\tthrow new InvalidRequestError('Invalid resource URL', {\r\n\t\t\t\t\tcorrelationId,\r\n\t\t\t\t\tresourceUrl,\r\n\t\t\t\t})\r\n\t\t\t}\r\n\r\n\t\t\tconst request = new CacheImageRequest({\r\n\t\t\t\tresourceTarget: MediaStreamImageRESTController.resourceTargetPrepare(resourceUrl),\r\n\t\t\t\tresizeOptions: new ResizeOptions({\r\n\t\t\t\t\twidth: width ? Number(width) : null,\r\n\t\t\t\t\theight: height ? Number(height) : null,\r\n\t\t\t\t\tposition,\r\n\t\t\t\t\tbackground,\r\n\t\t\t\t\tfit,\r\n\t\t\t\t\ttrimThreshold: Number(trimThreshold),\r\n\t\t\t\t\tformat,\r\n\t\t\t\t\tquality: Number(quality),\r\n\t\t\t\t}),\r\n\t\t\t})\r\n\r\n\t\t\tthis._logger.debug(`Static image request`, {\r\n\t\t\t\trequest: {\r\n\t\t\t\t\timage: decodedImage,\r\n\t\t\t\t\twidth,\r\n\t\t\t\t\theight,\r\n\t\t\t\t\tformat,\r\n\t\t\t\t\tquality,\r\n\t\t\t\t},\r\n\t\t\t\tcorrelationId,\r\n\t\t\t})\r\n\r\n\t\t\tres.locals.requestedFormat = format\r\n\t\t\tres.locals.originalUrl = resourceUrl\r\n\r\n\t\t\tawait this.handleStreamOrFallback(request, res)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconst context = {\r\n\t\t\t\timage,\r\n\t\t\t\twidth,\r\n\t\t\t\theight,\r\n\t\t\t\tformat,\r\n\t\t\t\tquality,\r\n\t\t\t\tcorrelationId,\r\n\t\t\t\terror: (error as Error).message || error,\r\n\t\t\t}\r\n\t\t\tthis._logger.error(`Error in staticImage: ${(error as Error).message || error}`, error, context)\r\n\t\t\tconst errorName = error instanceof Error ? error.constructor.name : 'UnknownError'\r\n\t\t\tthis.metricsService.recordError('static_image_request', errorName)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t\tfinally {\r\n\t\t\tPerformanceTracker.endPhase('static_image_request')\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["Buffer","createHash","open","process","CacheImageRequest","BackgroundOptions","FitOptions","PositionOptions","ResizeOptions","SupportedResizeFormats","CacheImageResourceOperation","IMAGE","VERSION","DefaultImageFallbackError","InvalidRequestError","ResourceStreamingError","CorrelationService","PerformanceTracker","MetricsService","AdaptiveRateLimitGuard","InputSanitizationService","SecurityCheckerService","Controller","Get","Logger","Param","Res","Scope","UseGuards","MediaStreamImageRESTController","cacheImageResourceOperation","inputSanitizationService","securityCheckerService","_correlationService","metricsService","_logger","name","validateRequestParameters","params","correlationId","getCorrelationId","imageType","isMalicious","checkForMaliciousContent","image","width","undefined","Number","isNaN","height","quality","trimThreshold","generateETag","input","hash","update","isBuffer","from","digest","addHeadersToRequest","res","headers","etag","size","toString","format","publicTTL","expiresAt","Date","now","header","toUTCString","handleStreamOrFallback","request","startPhase","recordError","setup","resourceExists","debug","streamResource","shouldUseQueue","shouldUseBackgroundProcessing","execute","maxWaitTime","pollInterval","waitTime","Promise","resolve","setTimeout","warn","wasQueued","defaultImageFallback","error","context","errorMessage","message","includes","errorName","Error","endPhase","streamFileToResponse","filePath","fd","fileStream","createReadStream","on","pipe","reject","destroy","close","catch","err","getHeaders","cachedResource","getCachedResource","data","imageData","dataType","getResourcePath","end","resourcePath","fetchAndStreamResource","optimizedDefaultImagePath","optimizeAndServeDefaultImage","resizeOptions","sendFile","defaultImageError","String","resourceTargetPrepare","resourceTarget","decodeURIComponent","uploadedImage","fit","contain","position","entropy","background","transparent","webp","decodedImageType","decodedImage","JSON","stringify","djangoApiUrl","env","NEST_PUBLIC_DJANGO_URL","resourceUrl","isValidUrl","validateUrl","locals","requestedFormat","originalUrl","staticImage","path","version","scope","REQUEST"],"mappings":"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"}