{"version":3,"sources":["../../../../../src/MediaStream/Storage/services/storage-optimization.service.ts"],"sourcesContent":["import type { OnModuleInit } from '@nestjs/common'\r\nimport type { AccessPattern } from './storage-monitoring.service'\r\nimport { Buffer } from 'node:buffer'\r\nimport { promises as fs } from 'node:fs'\r\nimport { join } from 'node:path'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { CorrelatedLogger } from '@microservice/Correlation/utils/logger.util'\r\nimport { Injectable, Logger } from '@nestjs/common'\r\nimport { Cron, CronExpression } from '@nestjs/schedule'\r\nimport { StorageMonitoringService } from './storage-monitoring.service'\r\n\r\nexport interface OptimizationStrategy {\r\n\tname: string\r\n\tdescription: string\r\n\texecute: (files: AccessPattern[]) => Promise<OptimizationResult>\r\n}\r\n\r\nexport interface OptimizationResult {\r\n\tfilesOptimized: number\r\n\tsizeReduced: number\r\n\terrors: string[]\r\n\tstrategy: string\r\n\tduration: number\r\n}\r\n\r\nexport interface OptimizationConfig {\r\n\tenabled: boolean\r\n\tstrategies: string[]\r\n\tpopularFileThreshold: number\r\n\tcompressionLevel: number\r\n\tcreateBackups: boolean\r\n\tmaxOptimizationTime: number\r\n}\r\n\r\nexport interface FileOptimization {\r\n\toriginalPath: string\r\n\toptimizedPath: string\r\n\toriginalSize: number\r\n\toptimizedSize: number\r\n\tcompressionRatio: number\r\n\tstrategy: string\r\n}\r\n\r\n@Injectable()\r\nexport class StorageOptimizationService implements OnModuleInit {\r\n\tprivate readonly _logger = new Logger(StorageOptimizationService.name)\r\n\tprivate readonly storageDirectory: string\r\n\tprivate readonly config: OptimizationConfig\r\n\tprivate readonly strategies = new Map<string, OptimizationStrategy>()\r\n\tprivate optimizationHistory = new Map<string, FileOptimization>()\r\n\tprivate isOptimizationRunning = false\r\n\r\n\tconstructor(\r\n\t\tprivate readonly _configService: ConfigService,\r\n\t\tprivate readonly storageMonitoring: StorageMonitoringService,\r\n\t) {\r\n\t\tthis.storageDirectory = this._configService.getOptional('cache.file.directory', './storage')\r\n\t\tthis.config = {\r\n\t\t\tenabled: this._configService.getOptional('storage.optimization.enabled', true),\r\n\t\t\tstrategies: this._configService.getOptional('storage.optimization.strategies', ['compression', 'deduplication']),\r\n\t\t\tpopularFileThreshold: this._configService.getOptional('storage.optimization.popularThreshold', 10),\r\n\t\t\tcompressionLevel: this._configService.getOptional('storage.optimization.compressionLevel', 6),\r\n\t\t\tcreateBackups: this._configService.getOptional('storage.optimization.createBackups', false),\r\n\t\t\tmaxOptimizationTime: this._configService.getOptional('storage.optimization.maxTime', 600000),\r\n\t\t}\r\n\r\n\t\tthis.initializeStrategies()\r\n\t}\r\n\r\n\tasync onModuleInit(): Promise<void> {\r\n\t\tif (this.config.enabled) {\r\n\t\t\tthis._logger.log(`Storage optimization enabled with strategies: ${this.config.strategies.join(', ')}`)\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._logger.log('Storage optimization disabled')\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Optimize frequently accessed files\r\n\t */\r\n\tasync optimizeFrequentlyAccessedFiles(): Promise<OptimizationResult> {\r\n\t\tif (this.isOptimizationRunning) {\r\n\t\t\tthrow new Error('Optimization is already running')\r\n\t\t}\r\n\r\n\t\tconst startTime = Date.now()\r\n\t\tthis.isOptimizationRunning = true\r\n\r\n\t\ttry {\r\n\t\t\tCorrelatedLogger.log('Starting storage optimization for frequently accessed files', StorageOptimizationService.name)\r\n\r\n\t\t\tlet stats\r\n\t\t\ttry {\r\n\t\t\t\tstats = await this.storageMonitoring.getStorageStats()\r\n\t\t\t}\r\n\t\t\tcatch (error: unknown) {\r\n\t\t\t\treturn {\r\n\t\t\t\t\tfilesOptimized: 0,\r\n\t\t\t\t\tsizeReduced: 0,\r\n\t\t\t\t\terrors: [`Storage monitoring error: ${(error as Error).message}`],\r\n\t\t\t\t\tstrategy: 'none',\r\n\t\t\t\t\tduration: Date.now() - startTime,\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconst popularFiles = stats.accessPatterns.filter(\r\n\t\t\t\tpattern => pattern.accessCount >= this.config.popularFileThreshold,\r\n\t\t\t)\r\n\r\n\t\t\tif (popularFiles.length === 0) {\r\n\t\t\t\treturn {\r\n\t\t\t\t\tfilesOptimized: 0,\r\n\t\t\t\t\tsizeReduced: 0,\r\n\t\t\t\t\terrors: [],\r\n\t\t\t\t\tstrategy: 'none',\r\n\t\t\t\t\tduration: Date.now() - startTime,\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlet totalFilesOptimized = 0\r\n\t\t\tlet totalSizeReduced = 0\r\n\t\t\tconst allErrors: string[] = []\r\n\t\t\tconst appliedStrategies: string[] = []\r\n\r\n\t\t\tfor (const strategyName of this.config.strategies) {\r\n\t\t\t\tconst strategy = this.strategies.get(strategyName)\r\n\t\t\t\tif (!strategy) {\r\n\t\t\t\t\tallErrors.push(`Unknown strategy: ${strategyName}`)\r\n\t\t\t\t\tcontinue\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst result = await strategy.execute(popularFiles)\r\n\t\t\t\t\ttotalFilesOptimized += result.filesOptimized\r\n\t\t\t\t\ttotalSizeReduced += result.sizeReduced\r\n\t\t\t\t\tallErrors.push(...result.errors)\r\n\t\t\t\t\tappliedStrategies.push(strategyName)\r\n\r\n\t\t\t\t\tCorrelatedLogger.debug(\r\n\t\t\t\t\t\t`Strategy '${strategyName}': ${result.filesOptimized} files, ${this.formatBytes(result.sizeReduced)} saved`,\r\n\t\t\t\t\t\tStorageOptimizationService.name,\r\n\t\t\t\t\t)\r\n\t\t\t\t}\r\n\t\t\t\tcatch (error: unknown) {\r\n\t\t\t\t\tconst errorMsg = `Strategy '${strategyName}' failed: ${(error as Error).message}`\r\n\t\t\t\t\tallErrors.push(errorMsg)\r\n\t\t\t\t\tCorrelatedLogger.error(errorMsg, (error as Error).stack, StorageOptimizationService.name)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconst result: OptimizationResult = {\r\n\t\t\t\tfilesOptimized: totalFilesOptimized,\r\n\t\t\t\tsizeReduced: totalSizeReduced,\r\n\t\t\t\terrors: allErrors,\r\n\t\t\t\tstrategy: appliedStrategies.join(', '),\r\n\t\t\t\tduration: Date.now() - startTime,\r\n\t\t\t}\r\n\r\n\t\t\tCorrelatedLogger.log(\r\n\t\t\t\t`Optimization completed: ${totalFilesOptimized} files optimized, ${this.formatBytes(totalSizeReduced)} saved`,\r\n\t\t\t\tStorageOptimizationService.name,\r\n\t\t\t)\r\n\r\n\t\t\treturn result\r\n\t\t}\r\n\t\tfinally {\r\n\t\t\tthis.isOptimizationRunning = false\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Scheduled optimization\r\n\t */\r\n\t@Cron(CronExpression.EVERY_6_HOURS)\r\n\tasync scheduledOptimization(): Promise<void> {\r\n\t\tif (!this.config.enabled || this.isOptimizationRunning) {\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tawait this.optimizeFrequentlyAccessedFiles()\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(\r\n\t\t\t\t`Scheduled optimization failed: ${(error as Error).message}`,\r\n\t\t\t\t(error as Error).stack,\r\n\t\t\t\tStorageOptimizationService.name,\r\n\t\t\t)\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Get optimization statistics\r\n\t */\r\n\tgetOptimizationStats(): {\r\n\t\tenabled: boolean\r\n\t\tisRunning: boolean\r\n\t\ttotalOptimizations: number\r\n\t\ttotalSizeSaved: number\r\n\t\taverageCompressionRatio: number\r\n\t\tstrategies: string[]\r\n\t} {\r\n\t\tconst optimizations = Array.from(this.optimizationHistory.values())\r\n\t\tconst totalSizeSaved = optimizations.reduce((sum: any, opt: any) => sum + (opt.originalSize - opt.optimizedSize), 0)\r\n\t\tconst averageCompressionRatio = optimizations.length > 0\r\n\t\t\t? optimizations.reduce((sum: any, opt: any) => sum + opt.compressionRatio, 0) / optimizations.length\r\n\t\t\t: 0\r\n\r\n\t\treturn {\r\n\t\t\tenabled: this.config.enabled,\r\n\t\t\tisRunning: this.isOptimizationRunning,\r\n\t\t\ttotalOptimizations: optimizations.length,\r\n\t\t\ttotalSizeSaved,\r\n\t\t\taverageCompressionRatio,\r\n\t\t\tstrategies: this.config.strategies,\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Get optimization history for a specific file\r\n\t */\r\n\tgetFileOptimizationHistory(filename: string): FileOptimization | null {\r\n\t\treturn this.optimizationHistory.get(filename) || null\r\n\t}\r\n\r\n\tprivate initializeStrategies(): void {\r\n\t\tthis.strategies.set('compression', {\r\n\t\t\tname: 'Compression',\r\n\t\t\tdescription: 'Compress frequently accessed files using gzip',\r\n\t\t\texecute: async (files: AccessPattern[]) => {\r\n\t\t\t\tlet filesOptimized = 0\r\n\t\t\t\tlet sizeReduced = 0\r\n\t\t\t\tconst errors: string[] = []\r\n\r\n\t\t\t\tfor (const file of files) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst result = await this.compressFile(file)\r\n\t\t\t\t\t\tif (result) {\r\n\t\t\t\t\t\t\tfilesOptimized++\r\n\t\t\t\t\t\t\tsizeReduced += result.originalSize - result.optimizedSize\r\n\t\t\t\t\t\t\tthis.optimizationHistory.set(file.file, result)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcatch (error: unknown) {\r\n\t\t\t\t\t\terrors.push(`Compression failed for ${file.file}: ${(error as Error).message}`)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tfilesOptimized,\r\n\t\t\t\t\tsizeReduced,\r\n\t\t\t\t\terrors,\r\n\t\t\t\t\tstrategy: 'compression',\r\n\t\t\t\t\tduration: 0,\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t})\r\n\r\n\t\tthis.strategies.set('deduplication', {\r\n\t\t\tname: 'Deduplication',\r\n\t\t\tdescription: 'Remove duplicate files and create hard links',\r\n\t\t\texecute: async (files: AccessPattern[]) => {\r\n\t\t\t\tlet filesOptimized = 0\r\n\t\t\t\tlet sizeReduced = 0\r\n\t\t\t\tconst errors: string[] = []\r\n\r\n\t\t\t\tconst duplicates = await this.findDuplicateFiles(files)\r\n\r\n\t\t\t\tfor (const duplicateGroup of duplicates) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst result = await this.deduplicateFiles(duplicateGroup)\r\n\t\t\t\t\t\tfilesOptimized += result.filesProcessed\r\n\t\t\t\t\t\tsizeReduced += result.sizeReduced\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcatch (error: unknown) {\r\n\t\t\t\t\t\terrors.push(`Deduplication failed: ${(error as Error).message}`)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tfilesOptimized,\r\n\t\t\t\t\tsizeReduced,\r\n\t\t\t\t\terrors,\r\n\t\t\t\t\tstrategy: 'deduplication',\r\n\t\t\t\t\tduration: 0,\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t})\r\n\r\n\t\tthis.strategies.set('prefetch', {\r\n\t\t\tname: 'Prefetch',\r\n\t\t\tdescription: 'Move frequently accessed files to faster storage tier',\r\n\t\t\texecute: async (files: AccessPattern[]) => {\r\n\t\t\t\t// This would move files to SSD or memory-mapped storage\r\n\t\t\t\t// For now, we'll just mark them as optimized\r\n\t\t\t\treturn {\r\n\t\t\t\t\tfilesOptimized: files.length,\r\n\t\t\t\t\tsizeReduced: 0,\r\n\t\t\t\t\terrors: [],\r\n\t\t\t\t\tstrategy: 'prefetch',\r\n\t\t\t\t\tduration: 0,\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t})\r\n\t}\r\n\r\n\tprivate async compressFile(file: AccessPattern): Promise<FileOptimization | null> {\r\n\t\tconst filePath = join(this.storageDirectory, file.file)\r\n\t\tconst compressedPath = `${filePath}.gz`\r\n\r\n\t\tif (file.extension === '.gz' || file.size < 1024) {\r\n\t\t\treturn null\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconst zlib = await import('node:zlib')\r\n\t\t\tconst originalData = await fs.readFile(filePath)\r\n\t\t\tconst compressedData = await new Promise<Buffer>((resolve, reject) => {\r\n\t\t\t\tzlib.gzip(originalData, { level: this.config.compressionLevel }, (err, result) => {\r\n\t\t\t\t\tif (err)\r\n\t\t\t\t\t\treject(err)\r\n\t\t\t\t\telse resolve(result)\r\n\t\t\t\t})\r\n\t\t\t})\r\n\r\n\t\t\tconst compressionRatio = compressedData.length / originalData.length\r\n\t\t\tif (compressionRatio < 0.8) {\r\n\t\t\t\tif (this.config.createBackups) {\r\n\t\t\t\t\tawait fs.copyFile(filePath, `${filePath}.backup`)\r\n\t\t\t\t}\r\n\r\n\t\t\t\tawait fs.writeFile(compressedPath, compressedData)\r\n\t\t\t\tawait fs.unlink(filePath)\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\toriginalPath: filePath,\r\n\t\t\t\t\toptimizedPath: compressedPath,\r\n\t\t\t\t\toriginalSize: originalData.length,\r\n\t\t\t\t\toptimizedSize: compressedData.length,\r\n\t\t\t\t\tcompressionRatio,\r\n\t\t\t\t\tstrategy: 'compression',\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.warn(\r\n\t\t\t\t`Failed to compress ${file.file}: ${(error as Error).message}`,\r\n\t\t\t\tStorageOptimizationService.name,\r\n\t\t\t)\r\n\t\t\tthrow error\r\n\t\t}\r\n\r\n\t\treturn null\r\n\t}\r\n\r\n\tprivate async findDuplicateFiles(files: AccessPattern[]): Promise<AccessPattern[][]> {\r\n\t\tconst hashMap = new Map<string, AccessPattern[]>()\r\n\t\tconst crypto = await import('node:crypto')\r\n\r\n\t\tfor (const file of files) {\r\n\t\t\ttry {\r\n\t\t\t\tconst filePath = join(this.storageDirectory, file.file)\r\n\t\t\t\tconst data = await fs.readFile(filePath)\r\n\t\t\t\tconst hash = crypto.createHash('md5').update(data).digest('hex')\r\n\r\n\t\t\t\tif (!hashMap.has(hash)) {\r\n\t\t\t\t\thashMap.set(hash, [])\r\n\t\t\t\t}\r\n\t\t\t\thashMap.get(hash)!.push(file)\r\n\t\t\t}\r\n\t\t\tcatch (error: unknown) {\r\n\t\t\t\tCorrelatedLogger.warn(\r\n\t\t\t\t\t`Failed to hash ${file.file}: ${(error as Error).message}`,\r\n\t\t\t\t\tStorageOptimizationService.name,\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn Array.from(hashMap.values()).filter(group => group.length > 1)\r\n\t}\r\n\r\n\tprivate async deduplicateFiles(duplicateGroup: AccessPattern[]): Promise<{\r\n\t\tfilesProcessed: number\r\n\t\tsizeReduced: number\r\n\t}> {\r\n\t\tif (duplicateGroup.length < 2) {\r\n\t\t\treturn { filesProcessed: 0, sizeReduced: 0 }\r\n\t\t}\r\n\r\n\t\tconst sortedFiles = duplicateGroup.sort((a: any, b: any) => b.accessCount - a.accessCount)\r\n\t\tconst originalFile = sortedFiles[0]\r\n\t\tconst duplicates = sortedFiles.slice(1)\r\n\r\n\t\tlet filesProcessed = 0\r\n\t\tlet sizeReduced = 0\r\n\r\n\t\tfor (const duplicate of duplicates) {\r\n\t\t\ttry {\r\n\t\t\t\tconst originalPath = join(this.storageDirectory, originalFile.file)\r\n\t\t\t\tconst duplicatePath = join(this.storageDirectory, duplicate.file)\r\n\r\n\t\t\t\tawait fs.unlink(duplicatePath)\r\n\t\t\t\tawait fs.link(originalPath, duplicatePath)\r\n\r\n\t\t\t\tfilesProcessed++\r\n\t\t\t\tsizeReduced += duplicate.size\r\n\t\t\t}\r\n\t\t\tcatch (error: unknown) {\r\n\t\t\t\tCorrelatedLogger.warn(\r\n\t\t\t\t\t`Failed to deduplicate ${duplicate.file}: ${(error as Error).message}`,\r\n\t\t\t\t\tStorageOptimizationService.name,\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn { filesProcessed, sizeReduced }\r\n\t}\r\n\r\n\tprivate formatBytes(bytes: number): string {\r\n\t\tconst units = ['B', 'KB', 'MB', 'GB']\r\n\t\tlet size = bytes\r\n\t\tlet unitIndex = 0\r\n\r\n\t\twhile (size >= 1024 && unitIndex < units.length - 1) {\r\n\t\t\tsize /= 1024\r\n\t\t\tunitIndex++\r\n\t\t}\r\n\r\n\t\treturn `${size.toFixed(1)} ${units[unitIndex]}`\r\n\t}\r\n}\r\n"],"names":["promises","fs","join","ConfigService","CorrelatedLogger","Injectable","Logger","Cron","CronExpression","StorageMonitoringService","StorageOptimizationService","_configService","storageMonitoring","_logger","name","strategies","Map","optimizationHistory","isOptimizationRunning","storageDirectory","getOptional","config","enabled","popularFileThreshold","compressionLevel","createBackups","maxOptimizationTime","initializeStrategies","onModuleInit","log","optimizeFrequentlyAccessedFiles","Error","startTime","Date","now","stats","getStorageStats","error","filesOptimized","sizeReduced","errors","message","strategy","duration","popularFiles","accessPatterns","filter","pattern","accessCount","length","totalFilesOptimized","totalSizeReduced","allErrors","appliedStrategies","strategyName","get","push","result","execute","debug","formatBytes","errorMsg","stack","scheduledOptimization","getOptimizationStats","optimizations","Array","from","values","totalSizeSaved","reduce","sum","opt","originalSize","optimizedSize","averageCompressionRatio","compressionRatio","isRunning","totalOptimizations","getFileOptimizationHistory","filename","set","description","files","file","compressFile","duplicates","findDuplicateFiles","duplicateGroup","deduplicateFiles","filesProcessed","filePath","compressedPath","extension","size","zlib","originalData","readFile","compressedData","Promise","resolve","reject","gzip","level","err","copyFile","writeFile","unlink","originalPath","optimizedPath","warn","hashMap","crypto","data","hash","createHash","update","digest","has","group","sortedFiles","sort","a","b","originalFile","slice","duplicate","duplicatePath","link","bytes","units","unitIndex","toFixed","EVERY_6_HOURS"],"mappings":"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"}