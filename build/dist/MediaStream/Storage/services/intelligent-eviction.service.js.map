{"version":3,"sources":["../../../../../src/MediaStream/Storage/services/intelligent-eviction.service.ts"],"sourcesContent":["import type { AccessPattern } from './storage-monitoring.service'\r\nimport { promises as fs } from 'node:fs'\r\nimport { join } from 'node:path'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { CorrelatedLogger } from '@microservice/Correlation/utils/logger.util'\r\nimport { Injectable } from '@nestjs/common'\r\nimport { StorageMonitoringService } from './storage-monitoring.service'\r\n\r\nexport interface EvictionStrategy {\r\n\tname: string\r\n\tdescription: string\r\n\texecute: (candidates: AccessPattern[], targetSize: number) => Promise<AccessPattern[]>\r\n}\r\n\r\nexport interface EvictionResult {\r\n\tfilesEvicted: number\r\n\tsizeFreed: number\r\n\terrors: string[]\r\n\tstrategy: string\r\n\tduration: number\r\n}\r\n\r\nexport interface EvictionConfig {\r\n\tstrategy: 'lru' | 'lfu' | 'size-based' | 'age-based' | 'intelligent'\r\n\taggressiveness: 'conservative' | 'moderate' | 'aggressive'\r\n\tpreservePopular: boolean\r\n\tminAccessCount: number\r\n\tmaxFileAge: number\r\n}\r\n\r\n@Injectable()\r\nexport class IntelligentEvictionService {\r\n\tprivate readonly storageDirectory: string\r\n\tprivate readonly config: EvictionConfig\r\n\tprivate readonly strategies = new Map<string, EvictionStrategy>()\r\n\r\n\tconstructor(\r\n\t\tprivate readonly _configService: ConfigService,\r\n\t\tprivate readonly storageMonitoring: StorageMonitoringService,\r\n\t) {\r\n\t\tthis.storageDirectory = this._configService.getOptional('cache.file.directory', './storage')\r\n\t\tthis.config = {\r\n\t\t\tstrategy: this._configService.getOptional('storage.eviction.strategy', 'intelligent'),\r\n\t\t\taggressiveness: this._configService.getOptional('storage.eviction.aggressiveness', 'moderate'),\r\n\t\t\tpreservePopular: this._configService.getOptional('storage.eviction.preservePopular', true),\r\n\t\t\tminAccessCount: this._configService.getOptional('storage.eviction.minAccessCount', 5),\r\n\t\t\tmaxFileAge: this._configService.getOptional('storage.eviction.maxFileAge', 7),\r\n\t\t}\r\n\r\n\t\tthis.initializeStrategies()\r\n\t}\r\n\r\n\t/**\r\n\t * Perform intelligent cache eviction based on access patterns\r\n\t */\r\n\tasync performEviction(targetSize?: number): Promise<EvictionResult> {\r\n\t\tconst startTime = Date.now()\r\n\r\n\t\ttry {\r\n\t\t\tCorrelatedLogger.debug(\r\n\t\t\t\t`Starting intelligent eviction with strategy: ${this.config.strategy}`,\r\n\t\t\t\tIntelligentEvictionService.name,\r\n\t\t\t)\r\n\r\n\t\t\tawait this.storageMonitoring.getStorageStats()\r\n\t\t\tconst candidates = await this.storageMonitoring.getEvictionCandidates(targetSize)\r\n\r\n\t\t\tif (candidates.length === 0) {\r\n\t\t\t\treturn {\r\n\t\t\t\t\tfilesEvicted: 0,\r\n\t\t\t\t\tsizeFreed: 0,\r\n\t\t\t\t\terrors: [],\r\n\t\t\t\t\tstrategy: this.config.strategy,\r\n\t\t\t\t\tduration: Date.now() - startTime,\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconst strategy = this.strategies.get(this.config.strategy)\r\n\t\t\tif (!strategy) {\r\n\t\t\t\tthrow new Error(`Unknown eviction strategy: ${this.config.strategy}`)\r\n\t\t\t}\r\n\r\n\t\t\tconst finalCandidates = await strategy.execute(candidates, targetSize || 0)\r\n\r\n\t\t\tconst result = await this.evictFiles(finalCandidates)\r\n\t\t\tresult.strategy = this.config.strategy\r\n\t\t\tresult.duration = Date.now() - startTime\r\n\r\n\t\t\tCorrelatedLogger.log(\r\n\t\t\t\t`Eviction completed: ${result.filesEvicted} files, ${this.formatBytes(result.sizeFreed)} freed`,\r\n\t\t\t\tIntelligentEvictionService.name,\r\n\t\t\t)\r\n\r\n\t\t\treturn result\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(\r\n\t\t\t\t`Eviction failed: ${(error as Error).message}`,\r\n\t\t\t\t(error as Error).stack,\r\n\t\t\t\tIntelligentEvictionService.name,\r\n\t\t\t)\r\n\r\n\t\t\treturn {\r\n\t\t\t\tfilesEvicted: 0,\r\n\t\t\t\tsizeFreed: 0,\r\n\t\t\t\terrors: [(error as Error).message],\r\n\t\t\t\tstrategy: this.config.strategy,\r\n\t\t\t\tduration: Date.now() - startTime,\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Perform eviction based on storage thresholds\r\n\t */\r\n\tasync performThresholdBasedEviction(): Promise<EvictionResult> {\r\n\t\tconst thresholdCheck = await this.storageMonitoring.checkThresholds()\r\n\r\n\t\tif (thresholdCheck.status === 'healthy') {\r\n\t\t\treturn {\r\n\t\t\t\tfilesEvicted: 0,\r\n\t\t\t\tsizeFreed: 0,\r\n\t\t\t\terrors: [],\r\n\t\t\t\tstrategy: 'threshold-based',\r\n\t\t\t\tduration: 0,\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet targetReduction: number\r\n\r\n\t\tif (thresholdCheck.status === 'critical') {\r\n\t\t\ttargetReduction = Math.floor(thresholdCheck.stats.totalSize * 0.4)\r\n\t\t}\r\n\t\telse {\r\n\t\t\ttargetReduction = Math.floor(thresholdCheck.stats.totalSize * 0.2)\r\n\t\t}\r\n\r\n\t\treturn this.performEviction(targetReduction)\r\n\t}\r\n\r\n\t/**\r\n\t * Get eviction recommendations without executing\r\n\t */\r\n\tasync getEvictionRecommendations(targetSize?: number): Promise<{\r\n\t\tcandidates: AccessPattern[]\r\n\t\ttotalSize: number\r\n\t\tstrategy: string\r\n\t\treasoning: string[]\r\n\t}> {\r\n\t\tconst candidates = await this.storageMonitoring.getEvictionCandidates(targetSize)\r\n\t\tconst strategy = this.strategies.get(this.config.strategy)\r\n\r\n\t\tif (!strategy) {\r\n\t\t\tthrow new Error(`Unknown eviction strategy: ${this.config.strategy}`)\r\n\t\t}\r\n\r\n\t\tconst finalCandidates = await strategy.execute(candidates, targetSize || 0)\r\n\t\tconst totalSize = finalCandidates.reduce((sum: any, candidate: any) => sum + candidate.size, 0)\r\n\r\n\t\tconst reasoning = this.generateEvictionReasoning(finalCandidates)\r\n\r\n\t\treturn {\r\n\t\t\tcandidates: finalCandidates,\r\n\t\t\ttotalSize,\r\n\t\t\tstrategy: this.config.strategy,\r\n\t\t\treasoning,\r\n\t\t}\r\n\t}\r\n\r\n\tprivate initializeStrategies(): void {\r\n\t\tthis.strategies.set('lru', {\r\n\t\t\tname: 'LRU',\r\n\t\t\tdescription: 'Evict least recently used files',\r\n\t\t\texecute: async (candidates: AccessPattern[], targetSize: number) => {\r\n\t\t\t\treturn candidates\r\n\t\t\t\t\t.sort((a: any, b: any) => a.lastAccessed.getTime() - b.lastAccessed.getTime())\r\n\t\t\t\t\t.slice(0, this.calculateFileCount(candidates, targetSize))\r\n\t\t\t},\r\n\t\t})\r\n\r\n\t\tthis.strategies.set('lfu', {\r\n\t\t\tname: 'LFU',\r\n\t\t\tdescription: 'Evict least frequently used files',\r\n\t\t\texecute: async (candidates: AccessPattern[], targetSize: number) => {\r\n\t\t\t\treturn candidates\r\n\t\t\t\t\t.sort((a: any, b: any) => a.accessCount - b.accessCount)\r\n\t\t\t\t\t.slice(0, this.calculateFileCount(candidates, targetSize))\r\n\t\t\t},\r\n\t\t})\r\n\r\n\t\tthis.strategies.set('size-based', {\r\n\t\t\tname: 'Size-based',\r\n\t\t\tdescription: 'Evict largest files first',\r\n\t\t\texecute: async (candidates: AccessPattern[], targetSize: number) => {\r\n\t\t\t\treturn candidates\r\n\t\t\t\t\t.sort((a: any, b: any) => b.size - a.size)\r\n\t\t\t\t\t.slice(0, this.calculateFileCount(candidates, targetSize))\r\n\t\t\t},\r\n\t\t})\r\n\r\n\t\tthis.strategies.set('age-based', {\r\n\t\t\tname: 'Age-based',\r\n\t\t\tdescription: 'Evict oldest files first',\r\n\t\t\texecute: async (candidates: AccessPattern[], targetSize: number) => {\r\n\t\t\t\tconst maxAge = this.config.maxFileAge * 24 * 60 * 60 * 1000\r\n\t\t\t\tconst cutoffDate = new Date(Date.now() - maxAge)\r\n\r\n\t\t\t\treturn candidates\r\n\t\t\t\t\t.filter(candidate => candidate.lastAccessed < cutoffDate)\r\n\t\t\t\t\t.sort((a: any, b: any) => a.lastAccessed.getTime() - b.lastAccessed.getTime())\r\n\t\t\t\t\t.slice(0, this.calculateFileCount(candidates, targetSize))\r\n\t\t\t},\r\n\t\t})\r\n\r\n\t\tthis.strategies.set('intelligent', {\r\n\t\t\tname: 'Intelligent',\r\n\t\t\tdescription: 'Combines access patterns, size, and age for optimal eviction',\r\n\t\t\texecute: async (candidates: AccessPattern[], targetSize: number) => {\r\n\t\t\t\tlet filtered = candidates\r\n\t\t\t\tif (this.config.preservePopular) {\r\n\t\t\t\t\tfiltered = candidates.filter(candidate =>\r\n\t\t\t\t\t\tcandidate.accessCount < this.config.minAccessCount,\r\n\t\t\t\t\t)\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst aggressivenessMultiplier = this.getAggressivenessMultiplier()\r\n\t\t\t\tconst adjustedTargetSize = targetSize * aggressivenessMultiplier\r\n\r\n\t\t\t\treturn filtered.slice(0, this.calculateFileCount(filtered, adjustedTargetSize))\r\n\t\t\t},\r\n\t\t})\r\n\t}\r\n\r\n\tprivate async evictFiles(candidates: AccessPattern[]): Promise<EvictionResult> {\r\n\t\tlet filesEvicted = 0\r\n\t\tlet sizeFreed = 0\r\n\t\tconst errors: string[] = []\r\n\r\n\t\tfor (const candidate of candidates) {\r\n\t\t\ttry {\r\n\t\t\t\tconst filePath = join(this.storageDirectory, candidate.file)\r\n\t\t\t\tawait fs.unlink(filePath)\r\n\r\n\t\t\t\tfilesEvicted++\r\n\t\t\t\tsizeFreed += candidate.size\r\n\r\n\t\t\t\tCorrelatedLogger.debug(\r\n\t\t\t\t\t`Evicted file: ${candidate.file} (${this.formatBytes(candidate.size)})`,\r\n\t\t\t\t\tIntelligentEvictionService.name,\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t\tcatch (error: unknown) {\r\n\t\t\t\tconst errorMsg = `Failed to evict ${candidate.file}: ${(error as Error).message}`\r\n\t\t\t\terrors.push(errorMsg)\r\n\t\t\t\tCorrelatedLogger.warn(errorMsg, IntelligentEvictionService.name)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tfilesEvicted,\r\n\t\t\tsizeFreed,\r\n\t\t\terrors,\r\n\t\t\tstrategy: '',\r\n\t\t\tduration: 0,\r\n\t\t}\r\n\t}\r\n\r\n\tprivate calculateFileCount(candidates: AccessPattern[], targetSize: number): number {\r\n\t\tif (targetSize <= 0)\r\n\t\t\treturn candidates.length\r\n\r\n\t\tlet currentSize = 0\r\n\t\tlet count = 0\r\n\r\n\t\tfor (const candidate of candidates) {\r\n\t\t\tcurrentSize += candidate.size\r\n\t\t\tcount++\r\n\r\n\t\t\tif (currentSize >= targetSize) {\r\n\t\t\t\tbreak\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn count\r\n\t}\r\n\r\n\tprivate getAggressivenessMultiplier(): number {\r\n\t\tswitch (this.config.aggressiveness) {\r\n\t\t\tcase 'conservative':\r\n\t\t\t\treturn 0.8\r\n\t\t\tcase 'moderate':\r\n\t\t\t\treturn 1.0\r\n\t\t\tcase 'aggressive':\r\n\t\t\t\treturn 1.5\r\n\t\t\tdefault:\r\n\t\t\t\treturn 1.0\r\n\t\t}\r\n\t}\r\n\r\n\tprivate generateEvictionReasoning(candidates: AccessPattern[]): string[] {\r\n\t\tconst reasoning: string[] = []\r\n\r\n\t\tif (candidates.length === 0) {\r\n\t\t\treasoning.push('No files selected for eviction')\r\n\t\t\treturn reasoning\r\n\t\t}\r\n\r\n\t\tconst totalSize = candidates.reduce((sum: any, c: any) => sum + c.size, 0)\r\n\t\tconst avgAccessCount = candidates.reduce((sum: any, c: any) => sum + c.accessCount, 0) / candidates.length\r\n\t\tconst oldestAccess = Math.min(...candidates.map(c => c.lastAccessed.getTime()))\r\n\t\tconst daysSinceOldest = (Date.now() - oldestAccess) / (1000 * 60 * 60 * 24)\r\n\r\n\t\treasoning.push(`Selected ${candidates.length} files totaling ${this.formatBytes(totalSize)}`)\r\n\t\treasoning.push(`Average access count: ${avgAccessCount.toFixed(1)}`)\r\n\t\treasoning.push(`Oldest file last accessed ${daysSinceOldest.toFixed(1)} days ago`)\r\n\r\n\t\tif (this.config.preservePopular) {\r\n\t\t\treasoning.push(`Popular files (>${this.config.minAccessCount} accesses) preserved`)\r\n\t\t}\r\n\r\n\t\treasoning.push(`Strategy: ${this.config.strategy} (${this.config.aggressiveness})`)\r\n\r\n\t\treturn reasoning\r\n\t}\r\n\r\n\tprivate formatBytes(bytes: number): string {\r\n\t\tconst units = ['B', 'KB', 'MB', 'GB']\r\n\t\tlet size = bytes\r\n\t\tlet unitIndex = 0\r\n\r\n\t\twhile (size >= 1024 && unitIndex < units.length - 1) {\r\n\t\t\tsize /= 1024\r\n\t\t\tunitIndex++\r\n\t\t}\r\n\r\n\t\treturn `${size.toFixed(1)} ${units[unitIndex]}`\r\n\t}\r\n}\r\n"],"names":["promises","fs","join","ConfigService","CorrelatedLogger","Injectable","StorageMonitoringService","IntelligentEvictionService","performEviction","targetSize","startTime","Date","now","debug","config","strategy","name","storageMonitoring","getStorageStats","candidates","getEvictionCandidates","length","filesEvicted","sizeFreed","errors","duration","strategies","get","Error","finalCandidates","execute","result","evictFiles","log","formatBytes","error","message","stack","performThresholdBasedEviction","thresholdCheck","checkThresholds","status","targetReduction","Math","floor","stats","totalSize","getEvictionRecommendations","reduce","sum","candidate","size","reasoning","generateEvictionReasoning","initializeStrategies","set","description","sort","a","b","lastAccessed","getTime","slice","calculateFileCount","accessCount","maxAge","maxFileAge","cutoffDate","filter","filtered","preservePopular","minAccessCount","aggressivenessMultiplier","getAggressivenessMultiplier","adjustedTargetSize","filePath","storageDirectory","file","unlink","errorMsg","push","warn","currentSize","count","aggressiveness","c","avgAccessCount","oldestAccess","min","map","daysSinceOldest","toFixed","bytes","units","unitIndex","_configService","Map","getOptional"],"mappings":"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"}