{"version":3,"sources":["../../../../../src/MediaStream/Validation/services/input-sanitization.service.ts"],"sourcesContent":["import type { ISanitizer } from '../interfaces/validator.interface'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { Injectable, Logger } from '@nestjs/common'\r\n\r\n@Injectable()\r\nexport class InputSanitizationService implements ISanitizer<any> {\r\n\tprivate readonly _logger = new Logger(InputSanitizationService.name)\r\n\tprivate allowedDomains: string[] | null = null as any\r\n\r\n\tconstructor(private readonly _configService: ConfigService) {\r\n\t}\r\n\r\n\tprivate getAllowedDomains(): string[] {\r\n\t\tif (this.allowedDomains === null) {\r\n\t\t\tthis.allowedDomains = this._configService.getOptional<string[]>('validation.allowedDomains', [\r\n\t\t\t\t'localhost',\r\n\t\t\t\t'127.0.0.1',\r\n\t\t\t\t'backend-service',\r\n\t\t\t\t'webside.gr',\r\n\t\t\t\t'assets.webside.gr',\r\n\t\t\t\t'api.webside.gr',\r\n\t\t\t\t'static.webside.gr',\r\n\t\t\t\t'frontend-nuxt-service',\r\n\t\t\t\t'media-stream-service',\r\n\t\t\t])\r\n\t\t}\r\n\t\treturn this.allowedDomains\r\n\t}\r\n\r\n\tasync sanitize(input: any): Promise<any> {\r\n\t\tif (input === null || input === undefined) {\r\n\t\t\treturn input\r\n\t\t}\r\n\r\n\t\tif (typeof input === 'string') {\r\n\t\t\treturn this.sanitizeString(input)\r\n\t\t}\r\n\r\n\t\tif (Array.isArray(input)) {\r\n\t\t\tconst sanitizedArray = []\r\n\t\t\tfor (let i = 0; i < input.length; i++) {\r\n\t\t\t\tsanitizedArray[i] = await this.sanitize(input[i])\r\n\t\t\t}\r\n\t\t\treturn sanitizedArray\r\n\t\t}\r\n\r\n\t\tif (typeof input === 'object') {\r\n\t\t\treturn this.sanitizeObject(input)\r\n\t\t}\r\n\r\n\t\treturn input\r\n\t}\r\n\r\n\tprivate sanitizeString(str: string): string {\r\n\t\tconst lowerStr = str.toLowerCase()\r\n\t\tconst dangerousProtocols = ['javascript:', 'data:', 'vbscript:', 'file:', 'ftp:', 'about:']\r\n\t\tfor (const protocol of dangerousProtocols) {\r\n\t\t\tif (lowerStr.startsWith(protocol)) {\r\n\t\t\t\treturn ''\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst emptyStringPatterns = [\r\n\t\t\t/^\\s*on\\w+\\s*=.*$/i,\r\n\t\t\t/^\\s*javascript\\s*:.*$/i,\r\n\t\t\t/^\\s*vbscript\\s*:.*$/i,\r\n\t\t\t/^\\s*data\\s*:.*$/i,\r\n\t\t]\r\n\r\n\t\tfor (const pattern of emptyStringPatterns) {\r\n\t\t\tif (pattern.test(str)) {\r\n\t\t\t\tthis._logger.warn(`Standalone dangerous pattern detected, returning empty string`)\r\n\t\t\t\treturn ''\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet sanitized = str\r\n\t\tlet previousLength = 0\r\n\t\tlet iterations = 0\r\n\t\tconst maxIterations = 10\r\n\r\n\t\twhile (sanitized.length !== previousLength && iterations < maxIterations) {\r\n\t\t\tpreviousLength = sanitized.length\r\n\t\t\titerations++\r\n\r\n\t\t\tsanitized = this.performSanitizationPass(sanitized)\r\n\t\t}\r\n\r\n\t\tsanitized = sanitized.trim()\r\n\r\n\t\tconst maxLength = 2048\r\n\t\tif (sanitized.length > maxLength) {\r\n\t\t\tsanitized = sanitized.substring(0, maxLength)\r\n\t\t\tthis._logger.warn(`String truncated to ${maxLength} characters for security`)\r\n\t\t}\r\n\r\n\t\treturn sanitized\r\n\t}\r\n\r\n\tprivate performSanitizationPass(input: string): string {\r\n\t\tlet result = input\r\n\t\tresult = this.removeHtmlTags(result)\r\n\t\tresult = this.removeEventHandlers(result)\r\n\t\tresult = this.removeStyleAttributes(result)\r\n\t\tresult = this.removeDangerousProtocols(result)\r\n\t\tresult = this.removeDangerousJavaScript(result)\r\n\t\tresult = this.removeHtmlEntities(result)\r\n\t\treturn result\r\n\t}\r\n\r\n\tprivate async sanitizeObject(obj: any): Promise<any> {\r\n\t\tconst sanitized: any = {}\r\n\r\n\t\tfor (const [key, value] of Object.entries(obj)) {\r\n\t\t\tconst sanitizedKey = this.sanitizeString(String(key))\r\n\r\n\t\t\tsanitized[sanitizedKey] = await this.sanitize(value)\r\n\t\t}\r\n\r\n\t\treturn sanitized\r\n\t}\r\n\r\n\tvalidateUrl(url: string): boolean {\r\n\t\ttry {\r\n\t\t\tconst lowerUrl = url.toLowerCase().trim()\r\n\t\t\tconst dangerousProtocols = ['javascript:', 'data:', 'vbscript:', 'file:', 'ftp:', 'about:']\r\n\t\t\tfor (const protocol of dangerousProtocols) {\r\n\t\t\t\tif (lowerUrl.startsWith(protocol)) {\r\n\t\t\t\t\tthis._logger.warn(`Dangerous protocol detected: ${protocol}`)\r\n\t\t\t\t\treturn false\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconst urlObj = new URL(url)\r\n\r\n\t\t\tif (!['http:', 'https:'].includes(urlObj.protocol)) {\r\n\t\t\t\tthis._logger.warn(`Invalid protocol: ${urlObj.protocol}`)\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\r\n\t\t\tif (!urlObj.hostname || urlObj.hostname.length === 0) {\r\n\t\t\t\tthis._logger.warn('Empty hostname detected')\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\r\n\t\t\tconst allowedDomains = this.getAllowedDomains()\r\n\t\t\tconst isAllowed = allowedDomains.some(domain =>\r\n\t\t\t\turlObj.hostname === domain || urlObj.hostname.endsWith(`.${domain}`),\r\n\t\t\t)\r\n\r\n\t\t\tif (!isAllowed) {\r\n\t\t\t\tthis._logger.warn(`URL blocked - not in whitelist: ${urlObj.hostname}`)\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\r\n\t\t\treturn true\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis._logger.warn(`Invalid URL format: ${url}, error: ${error}`)\r\n\t\t\treturn false\r\n\t\t}\r\n\t}\r\n\r\n\tvalidateFileSize(sizeBytes: number, format?: string): boolean {\r\n\t\tconst maxSizes = this._configService.getOptional('validation.maxFileSizes', {\r\n\t\t\tdefault: 10 * 1024 * 1024,\r\n\t\t\tjpeg: 5 * 1024 * 1024,\r\n\t\t\tjpg: 5 * 1024 * 1024,\r\n\t\t\tpng: 8 * 1024 * 1024,\r\n\t\t\twebp: 3 * 1024 * 1024,\r\n\t\t\tgif: 2 * 1024 * 1024,\r\n\t\t\tsvg: 1024 * 1024,\r\n\t\t})\r\n\r\n\t\tconst maxSize = format ? (maxSizes as any)[format.toLowerCase()] || maxSizes.default : maxSizes.default\r\n\t\treturn sizeBytes > 0 && sizeBytes <= maxSize\r\n\t}\r\n\r\n\tvalidateImageDimensions(width: number, height: number): boolean {\r\n\t\tconst maxWidth = 8192\r\n\t\tconst maxHeight = 8192\r\n\t\tconst maxPixels = 7680 * 4320\r\n\r\n\t\tif (width <= 0 || height <= 0)\r\n\t\t\treturn false\r\n\t\tif (width > maxWidth || height > maxHeight)\r\n\t\t\treturn false\r\n\t\tif ((width * height) > maxPixels)\r\n\t\t\treturn false\r\n\r\n\t\treturn true\r\n\t}\r\n\r\n\tprivate removeHtmlTags(input: string): string {\r\n\t\tconst result: string[] = []\r\n\t\tlet insideTag = false\r\n\t\tlet i = 0\r\n\r\n\t\twhile (i < input.length) {\r\n\t\t\tconst char = input[i]\r\n\r\n\t\t\tif (char === '<') {\r\n\t\t\t\tinsideTag = true\r\n\t\t\t\ti++\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\r\n\t\t\tif (char === '>') {\r\n\t\t\t\tinsideTag = false\r\n\t\t\t\ti++\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\r\n\t\t\tif (!insideTag) {\r\n\t\t\t\tresult.push(char)\r\n\t\t\t}\r\n\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\treturn result.join('')\r\n\t}\r\n\r\n\tprivate removeEventHandlers(input: string): string {\r\n\t\tconst result: string[] = []\r\n\t\tlet i = 0\r\n\r\n\t\twhile (i < input.length) {\r\n\t\t\tif (i <= input.length - 2\r\n\t\t\t\t&& input.substring(i, i + 2).toLowerCase() === 'on'\r\n\t\t\t\t&& this.isWordBoundary(input, i)) {\r\n\t\t\t\ti = this.skipEventHandler(input, i)\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\r\n\t\t\tresult.push(input[i])\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\treturn result.join('')\r\n\t}\r\n\r\n\tprivate removeStyleAttributes(input: string): string {\r\n\t\tconst result: string[] = []\r\n\t\tlet i = 0\r\n\r\n\t\twhile (i < input.length) {\r\n\t\t\tif (i <= input.length - 5\r\n\t\t\t\t&& input.substring(i, i + 5).toLowerCase() === 'style'\r\n\t\t\t\t&& this.isWordBoundary(input, i)) {\r\n\t\t\t\ti = this.skipStyleAttribute(input, i)\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\r\n\t\t\tresult.push(input[i])\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\treturn result.join('')\r\n\t}\r\n\r\n\tprivate removeDangerousProtocols(input: string): string {\r\n\t\tlet result = input\r\n\t\tlet previousResult = ''\r\n\r\n\t\twhile (result !== previousResult) {\r\n\t\t\tpreviousResult = result\r\n\r\n\t\t\tresult = result.replace(/(?:javascript|vbscript|data|file|ftp|about)\\s*:\\S*/gi, '')\r\n\r\n\t\t\tresult = result.replace(/(?:javascript|vbscript|data|file|ftp|about)\\s*:/gi, '')\r\n\r\n\t\t\tresult = result.replace(/\\b(?:javascript|vbscript|data|file|ftp|about)\\b/gi, '')\r\n\t\t}\r\n\r\n\t\treturn result\r\n\t}\r\n\r\n\tprivate removeDangerousJavaScript(input: string): string {\r\n\t\tlet result = input\r\n\t\tlet previousResult = ''\r\n\r\n\t\twhile (result !== previousResult) {\r\n\t\t\tpreviousResult = result\r\n\t\t\tresult = result.replace(/(?:expression|eval)\\s*\\([^)]*\\)/gi, '')\r\n\t\t\tresult = result.replace(/(?:expression|eval)\\s*\\(/gi, '')\r\n\t\t\tresult = result.replace(/\\b(?:expression|eval)\\b/gi, '')\r\n\t\t}\r\n\r\n\t\treturn result\r\n\t}\r\n\r\n\tprivate removeHtmlEntities(input: string): string {\r\n\t\tconst result: string[] = []\r\n\t\tlet i = 0\r\n\r\n\t\twhile (i < input.length) {\r\n\t\t\tif (input[i] === '&') {\r\n\t\t\t\ti = this.skipHtmlEntity(input, i)\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\r\n\t\t\tresult.push(input[i])\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\treturn result.join('')\r\n\t}\r\n\r\n\tprivate isWordBoundary(input: string, index: number): boolean {\r\n\t\tif (index === 0)\r\n\t\t\treturn true\r\n\t\tconst prevChar = input[index - 1]\r\n\t\treturn !(/\\w/.test(prevChar))\r\n\t}\r\n\r\n\tprivate skipEventHandler(input: string, startIndex: number): number {\r\n\t\tlet i = startIndex\r\n\r\n\t\twhile (i < input.length && /\\w/.test(input[i])) {\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\twhile (i < input.length && /\\s/.test(input[i])) {\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\tif (i < input.length && input[i] === '=') {\r\n\t\t\ti++\r\n\r\n\t\t\twhile (i < input.length && /\\s/.test(input[i])) {\r\n\t\t\t\ti++\r\n\t\t\t}\r\n\r\n\t\t\tif (i < input.length && (input[i] === '\"' || input[i] === '\\'')) {\r\n\t\t\t\tconst quote = input[i]\r\n\t\t\t\ti++\r\n\t\t\t\twhile (i < input.length && input[i] !== quote) {\r\n\t\t\t\t\ti++\r\n\t\t\t\t}\r\n\t\t\t\tif (i < input.length)\r\n\t\t\t\t\ti++\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\twhile (i < input.length && !/\\s/.test(input[i]) && input[i] !== '>' && input[i] !== '<') {\r\n\t\t\t\t\ti++\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn i\r\n\t}\r\n\r\n\tprivate skipStyleAttribute(input: string, startIndex: number): number {\r\n\t\tlet i = startIndex + 5\r\n\r\n\t\twhile (i < input.length && /\\s/.test(input[i])) {\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\tif (i < input.length && input[i] === '=') {\r\n\t\t\ti++\r\n\r\n\t\t\twhile (i < input.length && /\\s/.test(input[i])) {\r\n\t\t\t\ti++\r\n\t\t\t}\r\n\r\n\t\t\tif (i < input.length && (input[i] === '\"' || input[i] === '\\'')) {\r\n\t\t\t\tconst quote = input[i]\r\n\t\t\t\ti++\r\n\t\t\t\twhile (i < input.length && input[i] !== quote) {\r\n\t\t\t\t\ti++\r\n\t\t\t\t}\r\n\t\t\t\tif (i < input.length)\r\n\t\t\t\t\ti++\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\twhile (i < input.length && !/\\s/.test(input[i]) && input[i] !== '>' && input[i] !== '<') {\r\n\t\t\t\t\ti++\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn i\r\n\t}\r\n\r\n\tprivate skipHtmlEntity(input: string, startIndex: number): number {\r\n\t\tlet i = startIndex + 1\r\n\r\n\t\twhile (i < input.length && input[i] !== ';' && /[#\\w]/.test(input[i])) {\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\tif (i < input.length && input[i] === ';') {\r\n\t\t\ti++\r\n\t\t}\r\n\r\n\t\treturn i\r\n\t}\r\n}\r\n"],"names":["ConfigService","Injectable","Logger","InputSanitizationService","getAllowedDomains","allowedDomains","_configService","getOptional","sanitize","input","undefined","sanitizeString","Array","isArray","sanitizedArray","i","length","sanitizeObject","str","lowerStr","toLowerCase","dangerousProtocols","protocol","startsWith","emptyStringPatterns","pattern","test","_logger","warn","sanitized","previousLength","iterations","maxIterations","performSanitizationPass","trim","maxLength","substring","result","removeHtmlTags","removeEventHandlers","removeStyleAttributes","removeDangerousProtocols","removeDangerousJavaScript","removeHtmlEntities","obj","key","value","Object","entries","sanitizedKey","String","validateUrl","url","lowerUrl","urlObj","URL","includes","hostname","isAllowed","some","domain","endsWith","error","validateFileSize","sizeBytes","format","maxSizes","default","jpeg","jpg","png","webp","gif","svg","maxSize","validateImageDimensions","width","height","maxWidth","maxHeight","maxPixels","insideTag","char","push","join","isWordBoundary","skipEventHandler","skipStyleAttribute","previousResult","replace","skipHtmlEntity","index","prevChar","startIndex","quote","name"],"mappings":"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"}