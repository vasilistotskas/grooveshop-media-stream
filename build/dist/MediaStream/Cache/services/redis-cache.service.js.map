{"version":3,"sources":["../../../../../src/MediaStream/Cache/services/redis-cache.service.ts"],"sourcesContent":["import type { OnModuleDestroy, OnModuleInit } from '@nestjs/common'\r\nimport type { CacheStats, ICacheManager } from '../interfaces/cache-manager.interface'\r\nimport { Buffer } from 'node:buffer'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { CorrelatedLogger } from '@microservice/Correlation/utils/logger.util'\r\nimport { MetricsService } from '@microservice/Metrics/services/metrics.service'\r\nimport { Injectable } from '@nestjs/common'\r\nimport Redis from 'ioredis'\r\n\r\n@Injectable()\r\nexport class RedisCacheService implements ICacheManager, OnModuleInit, OnModuleDestroy {\r\n\tprivate redis!: Redis\r\n\tprivate isConnected = false\r\n\tprivate stats = {\r\n\t\thits: 0,\r\n\t\tmisses: 0,\r\n\t\toperations: 0,\r\n\t\terrors: 0,\r\n\t}\r\n\r\n\tconstructor(\r\n\t\tprivate readonly _configService: ConfigService,\r\n\t\tprivate readonly metricsService: MetricsService,\r\n\t) { }\r\n\r\n\tasync onModuleInit(): Promise<void> {\r\n\t\tawait this.initializeRedis()\r\n\t}\r\n\r\n\tasync onModuleDestroy(): Promise<void> {\r\n\t\tif (this.redis) {\r\n\t\t\tawait this.redis.quit()\r\n\t\t\tCorrelatedLogger.log('Redis connection closed', RedisCacheService.name)\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async initializeRedis(): Promise<void> {\r\n\t\ttry {\r\n\t\t\tconst config = this._configService.get('cache.redis')\r\n\r\n\t\t\tthis.redis = new Redis({\r\n\t\t\t\thost: config.host,\r\n\t\t\t\tport: config.port,\r\n\t\t\t\tpassword: config.password,\r\n\t\t\t\tdb: config.db,\r\n\t\t\t\tmaxRetriesPerRequest: config.maxRetries,\r\n\t\t\t\tenableReadyCheck: true,\r\n\t\t\t\tlazyConnect: true,\r\n\t\t\t\tkeepAlive: 30000,\r\n\t\t\t\tconnectTimeout: 10000,\r\n\t\t\t\tcommandTimeout: 5000,\r\n\t\t\t})\r\n\r\n\t\t\tthis.redis.on('connect', () => {\r\n\t\t\t\tCorrelatedLogger.log('Redis connecting...', RedisCacheService.name)\r\n\t\t\t})\r\n\r\n\t\t\tthis.redis.on('ready', () => {\r\n\t\t\t\tthis.isConnected = true\r\n\t\t\t\tCorrelatedLogger.log('Redis connection ready', RedisCacheService.name)\r\n\t\t\t\tthis.metricsService.updateActiveConnections('redis', 1)\r\n\t\t\t})\r\n\r\n\t\t\tthis.redis.on('error', (error: unknown) => {\r\n\t\t\t\tthis.isConnected = false\r\n\t\t\t\tthis.stats.errors++\r\n\t\t\t\tCorrelatedLogger.error(`Redis connection error: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\t\tthis.metricsService.updateActiveConnections('redis', 0)\r\n\t\t\t})\r\n\r\n\t\t\tthis.redis.on('close', () => {\r\n\t\t\t\tthis.isConnected = false\r\n\t\t\t\tCorrelatedLogger.warn('Redis connection closed', RedisCacheService.name)\r\n\t\t\t\tthis.metricsService.updateActiveConnections('redis', 0)\r\n\t\t\t})\r\n\r\n\t\t\tthis.redis.on('reconnecting', () => {\r\n\t\t\t\tCorrelatedLogger.log('Redis reconnecting...', RedisCacheService.name)\r\n\t\t\t})\r\n\r\n\t\t\tawait this.redis.connect()\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.isConnected = false\r\n\t\t\tCorrelatedLogger.error(`Failed to initialize Redis: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\tasync get<T>(key: string): Promise<T | null> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\tCorrelatedLogger.warn('Redis not connected, returning null', RedisCacheService.name)\r\n\t\t\tthis.stats.misses++\r\n\t\t\tthis.metricsService.recordCacheOperation('get', 'redis', 'miss')\r\n\t\t\treturn null\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tthis.stats.operations++\r\n\t\t\tconst value = await this.redis.get(key)\r\n\r\n\t\t\tif (value === null) {\r\n\t\t\t\tthis.stats.misses++\r\n\t\t\t\tthis.metricsService.recordCacheOperation('get', 'redis', 'miss')\r\n\t\t\t\tCorrelatedLogger.debug(`Redis cache MISS: ${key}`, RedisCacheService.name)\r\n\t\t\t\treturn null\r\n\t\t\t}\r\n\r\n\t\t\tthis.stats.hits++\r\n\t\t\tthis.metricsService.recordCacheOperation('get', 'redis', 'hit')\r\n\t\t\tCorrelatedLogger.debug(`Redis cache HIT: ${key}`, RedisCacheService.name)\r\n\r\n\t\t\treturn this.deserializeValue(value) as T\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.stats.errors++\r\n\t\t\tthis.stats.misses++\r\n\t\t\tthis.metricsService.recordCacheOperation('get', 'redis', 'error')\r\n\t\t\tCorrelatedLogger.error(`Redis cache GET error for key ${key}: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\treturn null\r\n\t\t}\r\n\t}\r\n\r\n\tasync set<T>(key: string, value: T, ttl?: number): Promise<void> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\tCorrelatedLogger.warn('Redis not connected, skipping SET operation', RedisCacheService.name)\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tthis.stats.operations++\r\n\t\t\tconst serializedValue = this.serializeValue(value)\r\n\t\t\tconst defaultTtl = this._configService.get('cache.redis.ttl')\r\n\t\t\tconst effectiveTtl = ttl !== undefined ? ttl : defaultTtl\r\n\r\n\t\t\tif (effectiveTtl > 0) {\r\n\t\t\t\tawait this.redis.setex(key, effectiveTtl, serializedValue)\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tawait this.redis.set(key, serializedValue)\r\n\t\t\t}\r\n\r\n\t\t\tthis.metricsService.recordCacheOperation('set', 'redis', 'success')\r\n\t\t\tCorrelatedLogger.debug(`Redis cache SET: ${key} (TTL: ${effectiveTtl}s)`, RedisCacheService.name)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.stats.errors++\r\n\t\t\tthis.metricsService.recordCacheOperation('set', 'redis', 'error')\r\n\t\t\tCorrelatedLogger.error(`Redis cache SET error for key ${key}: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t}\r\n\t}\r\n\r\n\tasync delete(key: string): Promise<void> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\tCorrelatedLogger.warn('Redis not connected, skipping DELETE operation', RedisCacheService.name)\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tthis.stats.operations++\r\n\t\t\tawait this.redis.del(key)\r\n\t\t\tthis.metricsService.recordCacheOperation('delete', 'redis', 'success')\r\n\t\t\tCorrelatedLogger.debug(`Redis cache DELETE: ${key}`, RedisCacheService.name)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.stats.errors++\r\n\t\t\tthis.metricsService.recordCacheOperation('delete', 'redis', 'error')\r\n\t\t\tCorrelatedLogger.error(`Redis cache DELETE error for key ${key}: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\tasync clear(): Promise<void> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\tCorrelatedLogger.warn('Redis not connected, skipping CLEAR operation', RedisCacheService.name)\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tthis.stats.operations++\r\n\t\t\tconst db = this._configService.get('cache.redis.db')\r\n\t\t\tawait this.redis.flushdb()\r\n\t\t\tthis.metricsService.recordCacheOperation('clear', 'redis', 'success')\r\n\t\t\tCorrelatedLogger.debug(`Redis cache CLEARED (DB: ${db})`, RedisCacheService.name)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.stats.errors++\r\n\t\t\tthis.metricsService.recordCacheOperation('clear', 'redis', 'error')\r\n\t\t\tCorrelatedLogger.error(`Redis cache CLEAR error: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\tasync has(key: string): Promise<boolean> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\treturn false\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tthis.stats.operations++\r\n\t\t\tconst exists = await this.redis.exists(key)\r\n\t\t\treturn exists === 1\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.stats.errors++\r\n\t\t\tCorrelatedLogger.error(`Redis cache HAS error for key ${key}: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\treturn false\r\n\t\t}\r\n\t}\r\n\r\n\tasync exists(key: string): Promise<boolean> {\r\n\t\treturn this.has(key)\r\n\t}\r\n\r\n\tasync keys(): Promise<string[]> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\treturn []\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tthis.stats.operations++\r\n\t\t\treturn await this.redis.keys('*')\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.stats.errors++\r\n\t\t\tCorrelatedLogger.error(`Redis cache KEYS error: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\treturn []\r\n\t\t}\r\n\t}\r\n\r\n\tasync flushAll(): Promise<void> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\tCorrelatedLogger.warn('Redis not connected, skipping FLUSH operation', RedisCacheService.name)\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tthis.stats.operations++\r\n\t\t\tawait this.redis.flushall()\r\n\t\t\tthis.metricsService.recordCacheOperation('flush', 'redis', 'success')\r\n\t\t\tCorrelatedLogger.debug('Redis cache FLUSHED ALL', RedisCacheService.name)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.stats.errors++\r\n\t\t\tthis.metricsService.recordCacheOperation('flush', 'redis', 'error')\r\n\t\t\tCorrelatedLogger.error(`Redis cache FLUSH error: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\tasync getStats(): Promise<CacheStats> {\r\n\t\ttry {\r\n\t\t\tconst hitRate = this.stats.hits + this.stats.misses > 0\r\n\t\t\t\t? this.stats.hits / (this.stats.hits + this.stats.misses)\r\n\t\t\t\t: 0\r\n\r\n\t\t\tthis.metricsService.updateCacheHitRatio('redis', hitRate)\r\n\r\n\t\t\tlet keys = 0\r\n\t\t\tlet memoryUsage = 0\r\n\r\n\t\t\tif (this.isConnected) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst info = await this.redis.info('keyspace')\r\n\t\t\t\t\tconst dbInfo = info.match(/db\\d+:keys=(\\d+)/)\r\n\t\t\t\t\tkeys = dbInfo ? Number.parseInt(dbInfo[1]) : 0\r\n\r\n\t\t\t\t\tconst memInfo = await this.redis.info('memory')\r\n\t\t\t\t\tconst memMatch = memInfo.match(/used_memory:(\\d+)/)\r\n\t\t\t\t\tmemoryUsage = memMatch ? Number.parseInt(memMatch[1]) : 0\r\n\t\t\t\t}\r\n\t\t\t\tcatch (error: unknown) {\r\n\t\t\t\t\tCorrelatedLogger.warn(`Failed to get Redis info: ${(error as Error).message}`, RedisCacheService.name)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn {\r\n\t\t\t\thits: this.stats.hits,\r\n\t\t\t\tmisses: this.stats.misses,\r\n\t\t\t\tkeys,\r\n\t\t\t\tksize: 0,\r\n\t\t\t\tvsize: memoryUsage,\r\n\t\t\t\thitRate,\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(`Redis cache STATS error: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\treturn {\r\n\t\t\t\thits: this.stats.hits,\r\n\t\t\t\tmisses: this.stats.misses,\r\n\t\t\t\tkeys: 0,\r\n\t\t\t\tksize: 0,\r\n\t\t\t\tvsize: 0,\r\n\t\t\t\thitRate: 0,\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tasync ping(): Promise<string> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\tthrow new Error('Redis not connected')\r\n\t\t}\r\n\t\treturn await this.redis.ping()\r\n\t}\r\n\r\n\tasync getTtl(key: string): Promise<number> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\treturn -1\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\treturn await this.redis.ttl(key)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(`Redis TTL error for key ${key}: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\treturn -1\r\n\t\t}\r\n\t}\r\n\r\n\tasync setTtl(key: string, ttl: number): Promise<boolean> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\treturn false\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconst result = await this.redis.expire(key, ttl)\r\n\t\t\treturn result === 1\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(`Redis EXPIRE error for key ${key}: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\treturn false\r\n\t\t}\r\n\t}\r\n\r\n\tgetConnectionStatus(): { connected: boolean, stats: { hits: number, misses: number, operations: number, errors: number } } {\r\n\t\treturn {\r\n\t\t\tconnected: this.isConnected,\r\n\t\t\tstats: { ...this.stats },\r\n\t\t}\r\n\t}\r\n\r\n\tasync getMemoryUsage(): Promise<{ used: number, peak: number, fragmentation: number }> {\r\n\t\tif (!this.isConnected) {\r\n\t\t\treturn { used: 0, peak: 0, fragmentation: 0 }\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconst info = await this.redis.info('memory')\r\n\t\t\tconst used = this.extractMemoryValue(info, 'used_memory')\r\n\t\t\tconst peak = this.extractMemoryValue(info, 'used_memory_peak')\r\n\t\t\tconst fragmentation = this.extractMemoryValue(info, 'mem_fragmentation_ratio')\r\n\r\n\t\t\treturn { used, peak, fragmentation }\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(`Redis memory info error: ${(error as Error).message}`, (error as Error).stack, RedisCacheService.name)\r\n\t\t\treturn { used: 0, peak: 0, fragmentation: 0 }\r\n\t\t}\r\n\t}\r\n\r\n\tprivate extractMemoryValue(info: string, key: string): number {\r\n\t\tconst match = info.match(new RegExp(`${key}:(\\\\d+(?:\\\\.\\\\d+)?)`))\r\n\t\treturn match ? Number.parseFloat(match[1]) : 0\r\n\t}\r\n\r\n\t/**\r\n\t * Serialize value for Redis storage, handling Buffers properly\r\n\t */\r\n\tprivate serializeValue<T>(value: T): string {\r\n\t\treturn JSON.stringify(value, (key, val) => {\r\n\t\t\tif (Buffer.isBuffer(val)) {\r\n\t\t\t\treturn {\r\n\t\t\t\t\ttype: 'Buffer',\r\n\t\t\t\t\tdata: val.toString('base64'),\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn val\r\n\t\t})\r\n\t}\r\n\r\n\t/**\r\n\t * Deserialize value from Redis storage, reconstructing Buffers properly\r\n\t */\r\n\tprivate deserializeValue<T>(value: string): T {\r\n\t\treturn JSON.parse(value, (key, val) => {\r\n\t\t\tif (val && typeof val === 'object' && val.type === 'Buffer' && typeof val.data === 'string') {\r\n\t\t\t\treturn Buffer.from(val.data, 'base64')\r\n\t\t\t}\r\n\t\t\treturn val\r\n\t\t})\r\n\t}\r\n}\r\n"],"names":["Buffer","ConfigService","CorrelatedLogger","MetricsService","Injectable","Redis","RedisCacheService","_configService","metricsService","isConnected","stats","hits","misses","operations","errors","onModuleInit","initializeRedis","onModuleDestroy","redis","quit","log","name","config","get","host","port","password","db","maxRetriesPerRequest","maxRetries","enableReadyCheck","lazyConnect","keepAlive","connectTimeout","commandTimeout","on","updateActiveConnections","error","message","stack","warn","connect","key","recordCacheOperation","value","debug","deserializeValue","set","ttl","serializedValue","serializeValue","defaultTtl","effectiveTtl","undefined","setex","delete","del","clear","flushdb","has","exists","keys","flushAll","flushall","getStats","hitRate","updateCacheHitRatio","memoryUsage","info","dbInfo","match","Number","parseInt","memInfo","memMatch","ksize","vsize","ping","Error","getTtl","setTtl","result","expire","getConnectionStatus","connected","getMemoryUsage","used","peak","fragmentation","extractMemoryValue","RegExp","parseFloat","JSON","stringify","val","isBuffer","type","data","toString","parse","from"],"mappings":"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"}