{"version":3,"sources":["../../../../../src/MediaStream/Cache/services/memory-cache.service.ts"],"sourcesContent":["import type { CacheStats, ICacheManager } from '../interfaces/cache-manager.interface'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { CorrelatedLogger } from '@microservice/Correlation/utils/logger.util'\r\nimport { MetricsService } from '@microservice/Metrics/services/metrics.service'\r\nimport { Injectable } from '@nestjs/common'\r\nimport NodeCache from 'node-cache'\r\n\r\n@Injectable()\r\nexport class MemoryCacheService implements ICacheManager {\r\n\tprotected readonly cache: NodeCache\r\n\r\n\tconstructor(\r\n\t\tprivate readonly _configService: ConfigService,\r\n\t\tprivate readonly metricsService: MetricsService,\r\n\t) {\r\n\t\tconst config = this._configService.get('cache.memory') || {}\r\n\r\n\t\tthis.cache = new NodeCache({\r\n\t\t\tstdTTL: config.defaultTtl || 3600,\r\n\t\t\tcheckperiod: config.checkPeriod || 600,\r\n\t\t\tuseClones: false,\r\n\t\t\tdeleteOnExpire: true,\r\n\t\t\tmaxKeys: config.maxKeys || 1000,\r\n\t\t})\r\n\r\n\t\tthis.cache.on('set', (key: string, _value: any) => {\r\n\t\t\tthis.metricsService.recordCacheOperation('set', 'memory', 'success')\r\n\t\t\tCorrelatedLogger.debug(`Memory cache SET: ${key}`, MemoryCacheService.name)\r\n\t\t})\r\n\r\n\t\tthis.cache.on('get', (key: string, value: any) => {\r\n\t\t\tif (value !== undefined) {\r\n\t\t\t\tthis.metricsService.recordCacheOperation('get', 'memory', 'hit')\r\n\t\t\t\tCorrelatedLogger.debug(`Memory cache HIT: ${key}`, MemoryCacheService.name)\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis.metricsService.recordCacheOperation('get', 'memory', 'miss')\r\n\t\t\t\tCorrelatedLogger.debug(`Memory cache MISS: ${key}`, MemoryCacheService.name)\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tthis.cache.on('del', (key: string, _value: any) => {\r\n\t\t\tthis.metricsService.recordCacheOperation('delete', 'memory', 'success')\r\n\t\t\tCorrelatedLogger.debug(`Memory cache DELETE: ${key}`, MemoryCacheService.name)\r\n\t\t})\r\n\r\n\t\tthis.cache.on('expired', (key: string, _value: any) => {\r\n\t\t\tthis.metricsService.recordCacheOperation('expire', 'memory', 'success')\r\n\t\t\tCorrelatedLogger.debug(`Memory cache EXPIRED: ${key}`, MemoryCacheService.name)\r\n\t\t})\r\n\r\n\t\tthis.cache.on('flush', () => {\r\n\t\t\tthis.metricsService.recordCacheOperation('flush', 'memory', 'success')\r\n\t\t\tCorrelatedLogger.debug('Memory cache FLUSHED', MemoryCacheService.name)\r\n\t\t})\r\n\t}\r\n\r\n\tasync get<T>(key: string): Promise<T | null> {\r\n\t\ttry {\r\n\t\t\tconst value = this.cache.get<T>(key)\r\n\t\t\treturn value !== undefined ? value : null\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.metricsService.recordCacheOperation('get', 'memory', 'error')\r\n\t\t\tCorrelatedLogger.error(`Memory cache GET error for key ${key}: ${(error as Error).message}`, (error as Error).stack, MemoryCacheService.name)\r\n\t\t\treturn null\r\n\t\t}\r\n\t}\r\n\r\n\tasync set<T>(key: string, value: T, ttl?: number): Promise<void> {\r\n\t\ttry {\r\n\t\t\tconst success = ttl !== undefined ? this.cache.set(key, value, ttl) : this.cache.set(key, value)\r\n\t\t\tif (!success) {\r\n\t\t\t\tthis.metricsService.recordCacheOperation('set', 'memory', 'error')\r\n\t\t\t\tCorrelatedLogger.warn(`Failed to set memory cache key: ${key}`, MemoryCacheService.name)\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.metricsService.recordCacheOperation('set', 'memory', 'error')\r\n\t\t\tCorrelatedLogger.error(`Memory cache SET error for key ${key}: ${(error as Error).message}`, (error as Error).stack, MemoryCacheService.name)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\tasync delete(key: string): Promise<void> {\r\n\t\ttry {\r\n\t\t\tthis.cache.del(key)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.metricsService.recordCacheOperation('delete', 'memory', 'error')\r\n\t\t\tCorrelatedLogger.error(`Memory cache DELETE error for key ${key}: ${(error as Error).message}`, (error as Error).stack, MemoryCacheService.name)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\tasync clear(): Promise<void> {\r\n\t\ttry {\r\n\t\t\tthis.cache.flushAll()\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.metricsService.recordCacheOperation('clear', 'memory', 'error')\r\n\t\t\tCorrelatedLogger.error(`Memory cache CLEAR error: ${(error as Error).message}`, (error as Error).stack, MemoryCacheService.name)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\tasync getStats(): Promise<CacheStats> {\r\n\t\ttry {\r\n\t\t\tconst stats = this.cache.getStats()\r\n\t\t\tconst hitRate = stats.hits + stats.misses > 0 ? stats.hits / (stats.hits + stats.misses) : 0\r\n\r\n\t\t\tthis.metricsService.updateCacheHitRatio('memory', hitRate)\r\n\r\n\t\t\treturn {\r\n\t\t\t\thits: stats.hits,\r\n\t\t\t\tmisses: stats.misses,\r\n\t\t\t\tkeys: stats.keys,\r\n\t\t\t\tksize: stats.ksize,\r\n\t\t\t\tvsize: stats.vsize,\r\n\t\t\t\thitRate,\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(`Memory cache STATS error: ${(error as Error).message}`, (error as Error).stack, MemoryCacheService.name)\r\n\t\t\treturn {\r\n\t\t\t\thits: 0,\r\n\t\t\t\tmisses: 0,\r\n\t\t\t\tkeys: 0,\r\n\t\t\t\tksize: 0,\r\n\t\t\t\tvsize: 0,\r\n\t\t\t\thitRate: 0,\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tasync has(key: string): Promise<boolean> {\r\n\t\ttry {\r\n\t\t\treturn this.cache.has(key)\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(`Memory cache HAS error for key ${key}: ${(error as Error).message}`, (error as Error).stack, MemoryCacheService.name)\r\n\t\t\treturn false\r\n\t\t}\r\n\t}\r\n\r\n\tasync exists(key: string): Promise<boolean> {\r\n\t\treturn this.has(key)\r\n\t}\r\n\r\n\tasync keys(): Promise<string[]> {\r\n\t\ttry {\r\n\t\t\treturn this.cache.keys()\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tCorrelatedLogger.error(`Memory cache KEYS error: ${(error as Error).message}`, (error as Error).stack, MemoryCacheService.name)\r\n\t\t\treturn []\r\n\t\t}\r\n\t}\r\n\r\n\tasync flushAll(): Promise<void> {\r\n\t\ttry {\r\n\t\t\tthis.cache.flushAll()\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tthis.metricsService.recordCacheOperation('flush', 'memory', 'error')\r\n\t\t\tCorrelatedLogger.error(`Memory cache FLUSH error: ${(error as Error).message}`, (error as Error).stack, MemoryCacheService.name)\r\n\t\t\tthrow error\r\n\t\t}\r\n\t}\r\n\r\n\tgetTtl(key: string): number {\r\n\t\treturn this.cache.getTtl(key) ?? 0\r\n\t}\r\n\r\n\tsetTtl(key: string, ttl: number): boolean {\r\n\t\treturn this.cache.ttl(key, ttl)\r\n\t}\r\n\r\n\tgetMemoryUsage(): { used: number, total: number } {\r\n\t\tconst stats = this.cache.getStats()\r\n\t\treturn {\r\n\t\t\tused: stats.vsize + stats.ksize,\r\n\t\t\ttotal: this._configService.get('cache.memory.maxSize') || 100 * 1024 * 1024,\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["ConfigService","CorrelatedLogger","MetricsService","Injectable","NodeCache","MemoryCacheService","get","key","value","cache","undefined","error","metricsService","recordCacheOperation","message","stack","name","set","ttl","success","warn","delete","del","clear","flushAll","getStats","stats","hitRate","hits","misses","updateCacheHitRatio","keys","ksize","vsize","has","exists","getTtl","setTtl","getMemoryUsage","used","total","_configService","config","stdTTL","defaultTtl","checkperiod","checkPeriod","useClones","deleteOnExpire","maxKeys","on","_value","debug"],"mappings":"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"}