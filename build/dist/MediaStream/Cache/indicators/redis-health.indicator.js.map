{"version":3,"sources":["../../../../../src/MediaStream/Cache/indicators/redis-health.indicator.ts"],"sourcesContent":["import type { HealthIndicatorResult } from '@nestjs/terminus'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { CorrelatedLogger } from '@microservice/Correlation/utils/logger.util'\r\nimport { BaseHealthIndicator } from '@microservice/Health/base/base-health-indicator'\r\nimport { Injectable } from '@nestjs/common'\r\nimport { RedisCacheService } from '../services/redis-cache.service'\r\n\r\n@Injectable()\r\nexport class RedisHealthIndicator extends BaseHealthIndicator {\r\n\tconstructor(\r\n\t\tprivate readonly redisCacheService: RedisCacheService,\r\n\t\tprivate readonly _configService: ConfigService,\r\n\t) {\r\n\t\tsuper('redis')\r\n\t}\r\n\r\n\tprotected async performHealthCheck(): Promise<HealthIndicatorResult> {\r\n\t\tconst startTime = Date.now()\r\n\r\n\t\ttry {\r\n\t\t\tconst pingResult = await this.redisCacheService.ping()\r\n\t\t\tif (pingResult !== 'PONG') {\r\n\t\t\t\tthrow new Error(`Redis ping failed: ${pingResult}`)\r\n\t\t\t}\r\n\r\n\t\t\tconst testKey = 'health-check-redis-test'\r\n\t\t\tconst testValue = { timestamp: Date.now(), test: true }\r\n\r\n\t\t\tawait this.redisCacheService.set(testKey, testValue, 60)\r\n\r\n\t\t\tconst retrievedValue = await this.redisCacheService.get<{ timestamp: number, test: boolean }>(testKey)\r\n\t\t\tif (!retrievedValue || retrievedValue.timestamp !== testValue.timestamp) {\r\n\t\t\t\tthrow new Error('Redis GET operation failed')\r\n\t\t\t}\r\n\r\n\t\t\tconst ttl = await this.redisCacheService.getTtl(testKey)\r\n\t\t\tif (ttl <= 0 || ttl > 60) {\r\n\t\t\t\tthrow new Error(`Redis TTL operation failed: ${ttl}`)\r\n\t\t\t}\r\n\r\n\t\t\tawait this.redisCacheService.delete(testKey)\r\n\r\n\t\t\tconst deletedValue = await this.redisCacheService.get(testKey)\r\n\t\t\tif (deletedValue !== null) {\r\n\t\t\t\tthrow new Error('Redis DELETE operation failed')\r\n\t\t\t}\r\n\r\n\t\t\tconst stats = await this.redisCacheService.getStats()\r\n\t\t\tconst memoryUsage = await this.redisCacheService.getMemoryUsage()\r\n\t\t\tconst connectionStatus = this.redisCacheService.getConnectionStatus()\r\n\r\n\t\t\tconst responseTime = Date.now() - startTime\r\n\t\t\tconst isHealthy = connectionStatus.connected && responseTime <= 200\r\n\r\n\t\t\tconst result: HealthIndicatorResult = {\r\n\t\t\t\t[this.key]: {\r\n\t\t\t\t\tstatus: isHealthy ? 'up' : 'down',\r\n\t\t\t\t\tresponseTime: `${responseTime}ms`,\r\n\t\t\t\t\tconnection: {\r\n\t\t\t\t\t\tconnected: connectionStatus.connected,\r\n\t\t\t\t\t\thost: this._configService.get('cache.redis.host'),\r\n\t\t\t\t\t\tport: this._configService.get('cache.redis.port'),\r\n\t\t\t\t\t\tdb: this._configService.get('cache.redis.db'),\r\n\t\t\t\t\t},\r\n\t\t\t\t\tstatistics: {\r\n\t\t\t\t\t\thits: stats.hits,\r\n\t\t\t\t\t\tmisses: stats.misses,\r\n\t\t\t\t\t\thitRate: Math.round(stats.hitRate * 10000) / 100,\r\n\t\t\t\t\t\tkeys: stats.keys,\r\n\t\t\t\t\t\toperations: connectionStatus.stats.operations,\r\n\t\t\t\t\t\terrors: connectionStatus.stats.errors,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tmemory: {\r\n\t\t\t\t\t\tused: memoryUsage.used,\r\n\t\t\t\t\t\tpeak: memoryUsage.peak,\r\n\t\t\t\t\t\tfragmentation: memoryUsage.fragmentation,\r\n\t\t\t\t\t\tusedMB: Math.round(memoryUsage.used / 1024 / 1024 * 100) / 100,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tthresholds: {\r\n\t\t\t\t\t\tresponseTime: '200ms',\r\n\t\t\t\t\t\thitRate: '70%',\r\n\t\t\t\t\t\tmemoryFragmentation: '1.5',\r\n\t\t\t\t\t},\r\n\t\t\t\t\twarnings: this.generateWarnings(stats, memoryUsage, responseTime, connectionStatus.stats.errors),\r\n\t\t\t\t},\r\n\t\t\t}\r\n\r\n\t\t\tif (isHealthy) {\r\n\t\t\t\tCorrelatedLogger.debug(`Redis health check passed in ${responseTime}ms`, RedisHealthIndicator.name)\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tCorrelatedLogger.warn(`Redis health check failed: response time ${responseTime}ms, connected ${connectionStatus.connected}`, RedisHealthIndicator.name)\r\n\t\t\t}\r\n\r\n\t\t\treturn result\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\tconst responseTime = Date.now() - startTime\r\n\t\t\tCorrelatedLogger.error(`Redis health check failed: ${(error as Error).message}`, (error as Error).stack, RedisHealthIndicator.name)\r\n\r\n\t\t\treturn {\r\n\t\t\t\t[this.key]: {\r\n\t\t\t\t\tstatus: 'down',\r\n\t\t\t\t\terror: (error as Error).message,\r\n\t\t\t\t\tresponseTime: `${responseTime}ms`,\r\n\t\t\t\t\tconnection: {\r\n\t\t\t\t\t\tconnected: false,\r\n\t\t\t\t\t\thost: this._configService.get('cache.redis.host'),\r\n\t\t\t\t\t\tport: this._configService.get('cache.redis.port'),\r\n\t\t\t\t\t\tdb: this._configService.get('cache.redis.db'),\r\n\t\t\t\t\t},\r\n\t\t\t\t\tlastCheck: new Date().toISOString(),\r\n\t\t\t\t},\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprivate generateWarnings(stats: any, memoryUsage: any, responseTime: number, errors: number = 0): string[] {\r\n\t\tconst warnings: string[] = []\r\n\r\n\t\tif (responseTime > 100) {\r\n\t\t\twarnings.push(`Response time (${responseTime}ms) is slower than optimal (100ms)`)\r\n\t\t}\r\n\r\n\t\tif (stats.hitRate < 0.7) {\r\n\t\t\twarnings.push(`Cache hit rate (${Math.round(stats.hitRate * 100)}%) is below optimal (70%)`)\r\n\t\t}\r\n\r\n\t\tif (memoryUsage.fragmentation > 1.5) {\r\n\t\t\twarnings.push(`Memory fragmentation (${memoryUsage.fragmentation}) is high (>1.5)`)\r\n\t\t}\r\n\r\n\t\tif (errors > 0) {\r\n\t\t\twarnings.push(`Redis has recorded ${errors} errors`)\r\n\t\t}\r\n\r\n\t\tconst memoryUsageMB = memoryUsage.used / 1024 / 1024\r\n\t\tif (memoryUsageMB > 100) {\r\n\t\t\twarnings.push(`Memory usage (${Math.round(memoryUsageMB)}MB) is high`)\r\n\t\t}\r\n\r\n\t\treturn warnings\r\n\t}\r\n\r\n\tasync getDetailedStatus(): Promise<any> {\r\n\t\ttry {\r\n\t\t\tconst stats = await this.redisCacheService.getStats()\r\n\t\t\tconst memoryUsage = await this.redisCacheService.getMemoryUsage()\r\n\t\t\tconst connectionStatus = this.redisCacheService.getConnectionStatus()\r\n\t\t\tconst keys = await this.redisCacheService.keys()\r\n\r\n\t\t\treturn {\r\n\t\t\t\ttype: 'redis-cache',\r\n\t\t\t\tstatus: connectionStatus.connected ? 'operational' : 'disconnected',\r\n\t\t\t\tconnection: {\r\n\t\t\t\t\tconnected: connectionStatus.connected,\r\n\t\t\t\t\thost: this._configService.get('cache.redis.host'),\r\n\t\t\t\t\tport: this._configService.get('cache.redis.port'),\r\n\t\t\t\t\tdb: this._configService.get('cache.redis.db'),\r\n\t\t\t\t},\r\n\t\t\t\tstatistics: {\r\n\t\t\t\t\t...stats,\r\n\t\t\t\t\toperations: connectionStatus.stats.operations,\r\n\t\t\t\t\terrors: connectionStatus.stats.errors,\r\n\t\t\t\t},\r\n\t\t\t\tmemory: {\r\n\t\t\t\t\t...memoryUsage,\r\n\t\t\t\t\tusedMB: Math.round(memoryUsage.used / 1024 / 1024 * 100) / 100,\r\n\t\t\t\t\tpeakMB: Math.round(memoryUsage.peak / 1024 / 1024 * 100) / 100,\r\n\t\t\t\t},\r\n\t\t\t\tconfiguration: {\r\n\t\t\t\t\thost: this._configService.get('cache.redis.host'),\r\n\t\t\t\t\tport: this._configService.get('cache.redis.port'),\r\n\t\t\t\t\tdb: this._configService.get('cache.redis.db'),\r\n\t\t\t\t\tttl: this._configService.get('cache.redis.ttl'),\r\n\t\t\t\t\tmaxRetries: this._configService.get('cache.redis.maxRetries'),\r\n\t\t\t\t},\r\n\t\t\t\trecentKeys: keys.slice(0, 10),\r\n\t\t\t\tlastUpdated: new Date().toISOString(),\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error: unknown) {\r\n\t\t\treturn {\r\n\t\t\t\ttype: 'redis-cache',\r\n\t\t\t\tstatus: 'error',\r\n\t\t\t\terror: (error as Error).message,\r\n\t\t\t\tlastUpdated: new Date().toISOString(),\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprotected getDescription(): string {\r\n\t\treturn 'Redis cache health indicator that tests connection and basic operations'\r\n\t}\r\n}\r\n"],"names":["ConfigService","CorrelatedLogger","BaseHealthIndicator","Injectable","RedisCacheService","RedisHealthIndicator","redisCacheService","_configService","performHealthCheck","startTime","Date","now","pingResult","ping","Error","testKey","testValue","timestamp","test","set","retrievedValue","get","ttl","getTtl","delete","deletedValue","stats","getStats","memoryUsage","getMemoryUsage","connectionStatus","getConnectionStatus","responseTime","isHealthy","connected","result","key","status","connection","host","port","db","statistics","hits","misses","hitRate","Math","round","keys","operations","errors","memory","used","peak","fragmentation","usedMB","thresholds","memoryFragmentation","warnings","generateWarnings","debug","name","warn","error","message","stack","lastCheck","toISOString","push","memoryUsageMB","getDetailedStatus","type","peakMB","configuration","maxRetries","recentKeys","slice","lastUpdated","getDescription"],"mappings":"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"}