{"version":3,"sources":["../../../../../src/MediaStream/Cache/layers/file-cache.layer.ts"],"sourcesContent":["import type { CacheLayer, CacheLayerStats } from '../interfaces/cache-layer.interface'\nimport { promises as fs } from 'node:fs'\nimport { join } from 'node:path'\nimport { ConfigService } from '@microservice/Config/config.service'\nimport { CorrelatedLogger } from '@microservice/Correlation/utils/logger.util'\nimport { Injectable } from '@nestjs/common'\n\ninterface FileCacheEntry<T> {\n\tvalue: T\n\ttimestamp: number\n\tttl?: number\n}\n\n@Injectable()\nexport class FileCacheLayer implements CacheLayer {\n\tprivate readonly layerName = 'file'\n\tprivate readonly priority = 3\n\tprivate readonly cacheDirectory: string\n\tprivate stats = {\n\t\thits: 0,\n\t\tmisses: 0,\n\t\terrors: 0,\n\t}\n\n\tconstructor(private readonly _configService: ConfigService) {\n\t\tthis.cacheDirectory = this._configService.get('cache.file.directory')\n\t\tthis.ensureCacheDirectory()\n\t}\n\n\tasync get<T>(key: string): Promise<T | null> {\n\t\ttry {\n\t\t\tconst filePath = this.getFilePath(key)\n\t\t\tconst data = await fs.readFile(filePath, 'utf8')\n\t\t\tconst entry: FileCacheEntry<T> = JSON.parse(data)\n\n\t\t\tif (entry.ttl && Date.now() - entry.timestamp > entry.ttl * 1000) {\n\t\t\t\tawait this.delete(key)\n\t\t\t\tthis.stats.misses++\n\t\t\t\treturn null\n\t\t\t}\n\n\t\t\tthis.stats.hits++\n\t\t\treturn entry.value\n\t\t}\n\t\tcatch {\n\t\t\tthis.stats.misses++\n\t\t\treturn null\n\t\t}\n\t}\n\n\tasync set<T>(key: string, value: T, ttl?: number): Promise<void> {\n\t\ttry {\n\t\t\tconst filePath = this.getFilePath(key)\n\t\t\tconst entry: FileCacheEntry<T> = {\n\t\t\t\tvalue,\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t\tttl,\n\t\t\t}\n\n\t\t\tawait fs.writeFile(filePath, JSON.stringify(entry), 'utf8')\n\t\t\tCorrelatedLogger.debug(`File cache SET: ${key}`, FileCacheLayer.name)\n\t\t}\n\t\tcatch (error: unknown) {\n\t\t\tthis.stats.errors++\n\t\t\tCorrelatedLogger.error(\n\t\t\t\t`File cache SET failed: ${(error as Error).message}`,\n\t\t\t\t(error as Error).stack,\n\t\t\t\tFileCacheLayer.name,\n\t\t\t)\n\t\t}\n\t}\n\n\tasync delete(key: string): Promise<void> {\n\t\ttry {\n\t\t\tconst filePath = this.getFilePath(key)\n\t\t\tawait fs.unlink(filePath)\n\t\t\tCorrelatedLogger.debug(`File cache DELETE: ${key}`, FileCacheLayer.name)\n\t\t}\n\t\tcatch (error: unknown) {\n\t\t\tif ((error as any).code !== 'ENOENT') {\n\t\t\t\tthis.stats.errors++\n\t\t\t\tCorrelatedLogger.error(\n\t\t\t\t\t`File cache DELETE failed: ${(error as Error).message}`,\n\t\t\t\t\t(error as Error).stack,\n\t\t\t\t\tFileCacheLayer.name,\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t}\n\n\tasync exists(key: string): Promise<boolean> {\n\t\ttry {\n\t\t\tconst filePath = this.getFilePath(key)\n\t\t\tawait fs.access(filePath)\n\t\t\treturn true\n\t\t}\n\t\tcatch {\n\t\t\treturn false\n\t\t}\n\t}\n\n\tasync clear(): Promise<void> {\n\t\ttry {\n\t\t\tconst files = await fs.readdir(this.cacheDirectory)\n\t\t\tawait Promise.all(\n\t\t\t\tfiles.map(file => fs.unlink(join(this.cacheDirectory, file)).catch(() => {})),\n\t\t\t)\n\t\t\tCorrelatedLogger.debug('File cache CLEARED', FileCacheLayer.name)\n\t\t}\n\t\tcatch (error: unknown) {\n\t\t\tthis.stats.errors++\n\t\t\tCorrelatedLogger.error(\n\t\t\t\t`File cache CLEAR failed: ${(error as Error).message}`,\n\t\t\t\t(error as Error).stack,\n\t\t\t\tFileCacheLayer.name,\n\t\t\t)\n\t\t}\n\t}\n\n\tasync getStats(): Promise<CacheLayerStats> {\n\t\ttry {\n\t\t\tconst files = await fs.readdir(this.cacheDirectory)\n\t\t\tconst totalRequests = this.stats.hits + this.stats.misses\n\t\t\treturn {\n\t\t\t\thits: this.stats.hits,\n\t\t\t\tmisses: this.stats.misses,\n\t\t\t\tkeys: files.length,\n\t\t\t\thitRate: totalRequests > 0 ? this.stats.hits / totalRequests : 0,\n\t\t\t\terrors: this.stats.errors,\n\t\t\t}\n\t\t}\n\t\tcatch {\n\t\t\treturn {\n\t\t\t\thits: this.stats.hits,\n\t\t\t\tmisses: this.stats.misses,\n\t\t\t\tkeys: 0,\n\t\t\t\thitRate: 0,\n\t\t\t\terrors: this.stats.errors + 1,\n\t\t\t}\n\t\t}\n\t}\n\n\tgetLayerName(): string {\n\t\treturn this.layerName\n\t}\n\n\tgetPriority(): number {\n\t\treturn this.priority\n\t}\n\n\tprivate getFilePath(key: string): string {\n\t\tconst sanitizedKey = key.replace(/[^\\w\\-.:]/g, '_')\n\t\treturn join(this.cacheDirectory, `${sanitizedKey}.json`)\n\t}\n\n\tprivate async ensureCacheDirectory(): Promise<void> {\n\t\ttry {\n\t\t\tawait fs.mkdir(this.cacheDirectory, { recursive: true })\n\t\t}\n\t\tcatch (error: unknown) {\n\t\t\tCorrelatedLogger.error(\n\t\t\t\t`Failed to create cache directory: ${(error as Error).message}`,\n\t\t\t\t(error as Error).stack,\n\t\t\t\tFileCacheLayer.name,\n\t\t\t)\n\t\t}\n\t}\n}\n"],"names":["promises","fs","join","ConfigService","CorrelatedLogger","Injectable","FileCacheLayer","get","key","filePath","getFilePath","data","readFile","entry","JSON","parse","ttl","Date","now","timestamp","delete","stats","misses","hits","value","set","writeFile","stringify","debug","name","error","errors","message","stack","unlink","code","exists","access","clear","files","readdir","cacheDirectory","Promise","all","map","file","catch","getStats","totalRequests","keys","length","hitRate","getLayerName","layerName","getPriority","priority","sanitizedKey","replace","ensureCacheDirectory","mkdir","recursive","_configService"],"mappings":"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"}