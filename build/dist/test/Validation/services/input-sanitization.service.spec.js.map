{"version":3,"sources":["../../../../../src/test/Validation/services/input-sanitization.service.spec.ts"],"sourcesContent":["import type { MockedObject } from 'vitest'\r\nimport { ConfigService } from '@microservice/Config/config.service'\r\nimport { InputSanitizationService } from '@microservice/Validation/services/input-sanitization.service'\r\nimport { Test, TestingModule } from '@nestjs/testing'\nimport { beforeEach, describe, expect, it, vi } from 'vitest'\n\r\ndescribe('inputSanitizationService', () => {\r\n\tlet service: InputSanitizationService\r\n\tlet configService: MockedObject<ConfigService>\r\n\r\n\tbeforeEach(async () => {\r\n\t\tconst mockConfigService = {\r\n\t\t\tgetOptional: vi.fn(),\r\n\t\t}\r\n\r\n\t\tconst module: TestingModule = await Test.createTestingModule({\r\n\t\t\tproviders: [\r\n\t\t\t\tInputSanitizationService,\r\n\t\t\t\t{ provide: ConfigService, useValue: mockConfigService },\r\n\t\t\t],\r\n\t\t}).compile()\r\n\r\n\t\tservice = module.get<InputSanitizationService>(InputSanitizationService)\r\n\t\tconfigService = module.get(ConfigService)\r\n\r\n\t\t// Setup default config responses\r\n\t\tconfigService.getOptional.mockImplementation((key, defaultValue) => {\r\n\t\t\tconst configs: Record<string, any> = {\r\n\t\t\t\t'validation.allowedDomains': ['localhost', '127.0.0.1', 'example.com', 'test.com', 'grooveshop.com'],\r\n\t\t\t\t'validation.maxFileSizes': {\r\n\t\t\t\t\tdefault: 10 * 1024 * 1024,\r\n\t\t\t\t\tjpeg: 5 * 1024 * 1024,\r\n\t\t\t\t\tpng: 8 * 1024 * 1024,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\t\t\treturn configs[key] || defaultValue\r\n\t\t})\r\n\t})\r\n\r\n\tit('should be defined', () => {\r\n\t\texpect(service).toBeDefined()\r\n\t})\r\n\r\n\tdescribe('sanitize', () => {\r\n\t\tit('should sanitize malicious script tags', async () => {\r\n\t\t\tconst input = '<script>alert(\"xss\")</script>Hello World'\r\n\t\t\tconst result = await service.sanitize(input)\r\n\t\t\texpect(result).toBe('alert(\"xss\")Hello World')\r\n\t\t})\r\n\r\n\t\tit('should remove javascript protocols', async () => {\r\n\t\t\tconst input = 'javascript:alert(\"xss\")'\r\n\t\t\tconst result = await service.sanitize(input)\r\n\t\t\texpect(result).toBe('')\r\n\t\t})\r\n\r\n\t\tit('should remove event handlers', async () => {\r\n\t\t\tconst input = 'onclick=\"alert(1)\" onload=\"evil()\"'\r\n\t\t\tconst result = await service.sanitize(input)\r\n\t\t\texpect(result).toBe('')\r\n\t\t})\r\n\r\n\t\tit('should handle null and undefined inputs', async () => {\r\n\t\t\texpect(await service.sanitize(null)).toBeNull()\r\n\t\t\texpect(await service.sanitize(undefined)).toBeUndefined()\r\n\t\t})\r\n\r\n\t\tit('should sanitize objects recursively', async () => {\r\n\t\t\tconst input = {\r\n\t\t\t\tname: '<script>alert(\"xss\")</script>John',\r\n\t\t\t\turl: 'javascript:alert(\"evil\")',\r\n\t\t\t\tnested: {\r\n\t\t\t\t\tvalue: 'onclick=\"bad()\"test',\r\n\t\t\t\t},\r\n\t\t\t}\r\n\r\n\t\t\tconst result = await service.sanitize(input)\r\n\t\t\texpect(result.name).toBe('alert(\"xss\")John') // Script tags removed, content preserved\r\n\t\t\texpect(result.url).toBe('') // Dangerous protocol removed completely\r\n\t\t\t// Enhanced sanitization removes entire strings containing dangerous patterns for security\r\n\t\t\texpect(result.nested.value).toBe('')\r\n\t\t})\r\n\r\n\t\tit('should sanitize arrays', async () => {\r\n\t\t\tconst input = ['<script>evil</script>good', 'javascript:bad', 'normal']\r\n\t\t\tconst result = await service.sanitize(input)\r\n\t\t\texpect(result).toEqual(['evilgood', '', 'normal'])\r\n\t\t})\r\n\r\n\t\tit('should truncate excessively long strings', async () => {\r\n\t\t\tconst longString = 'a'.repeat(3000)\r\n\t\t\tconst result = await service.sanitize(longString)\r\n\t\t\texpect(result.length).toBeLessThanOrEqual(2048)\r\n\t\t})\r\n\t})\r\n\r\n\tdescribe('validateUrl', () => {\r\n\t\tit('should accept valid URLs from allowed domains', () => {\r\n\t\t\texpect(service.validateUrl('https://example.com/image.jpg')).toBe(true)\r\n\t\t\texpect(service.validateUrl('http://localhost:3000/test.png')).toBe(true)\r\n\t\t})\r\n\r\n\t\tit('should reject URLs from non-allowed domains', () => {\r\n\t\t\texpect(service.validateUrl('https://malicious.com/image.jpg')).toBe(false)\r\n\t\t\texpect(service.validateUrl('http://evil.org/test.png')).toBe(false)\r\n\t\t})\r\n\r\n\t\tit('should reject non-HTTP protocols', () => {\r\n\t\t\texpect(service.validateUrl('ftp://example.com/file.jpg')).toBe(false)\r\n\t\t\texpect(service.validateUrl('javascript:alert(1)')).toBe(false)\r\n\t\t\texpect(service.validateUrl('data:image/png;base64,abc')).toBe(false)\r\n\t\t})\r\n\r\n\t\tit('should handle invalid URL formats', () => {\r\n\t\t\texpect(service.validateUrl('not-a-url')).toBe(false)\r\n\t\t\texpect(service.validateUrl('')).toBe(false)\r\n\t\t\texpect(service.validateUrl('://invalid')).toBe(false)\r\n\t\t})\r\n\r\n\t\tit('should accept subdomains of allowed domains', () => {\r\n\t\t\texpect(service.validateUrl('https://cdn.example.com/image.jpg')).toBe(true)\r\n\t\t\texpect(service.validateUrl('https://api.test.com/resource')).toBe(true)\r\n\t\t})\r\n\t})\r\n\r\n\tdescribe('validateFileSize', () => {\r\n\t\tit('should accept files within size limits', () => {\r\n\t\t\texpect(service.validateFileSize(1024 * 1024)).toBe(true) // 1MB\r\n\t\t\texpect(service.validateFileSize(2 * 1024 * 1024, 'jpeg')).toBe(true) // 2MB JPEG\r\n\t\t})\r\n\r\n\t\tit('should reject files exceeding size limits', () => {\r\n\t\t\texpect(service.validateFileSize(20 * 1024 * 1024)).toBe(false) // 20MB\r\n\t\t\texpect(service.validateFileSize(10 * 1024 * 1024, 'jpeg')).toBe(false) // 10MB JPEG\r\n\t\t})\r\n\r\n\t\tit('should reject zero or negative sizes', () => {\r\n\t\t\texpect(service.validateFileSize(0)).toBe(false)\r\n\t\t\texpect(service.validateFileSize(-1000)).toBe(false)\r\n\t\t})\r\n\r\n\t\tit('should use format-specific limits', () => {\r\n\t\t\texpect(service.validateFileSize(6 * 1024 * 1024, 'jpeg')).toBe(false) // 6MB JPEG (limit 5MB)\r\n\t\t\texpect(service.validateFileSize(6 * 1024 * 1024, 'png')).toBe(true) // 6MB PNG (limit 8MB)\r\n\t\t})\r\n\t})\r\n\r\n\tdescribe('validateImageDimensions', () => {\r\n\t\tit('should accept valid dimensions', () => {\r\n\t\t\texpect(service.validateImageDimensions(1920, 1080)).toBe(true)\r\n\t\t\texpect(service.validateImageDimensions(800, 600)).toBe(true)\r\n\t\t})\r\n\r\n\t\tit('should reject dimensions exceeding limits', () => {\r\n\t\t\texpect(service.validateImageDimensions(10000, 10000)).toBe(false)\r\n\t\t\texpect(service.validateImageDimensions(8193, 100)).toBe(false)\r\n\t\t\texpect(service.validateImageDimensions(100, 8193)).toBe(false)\r\n\t\t})\r\n\r\n\t\tit('should reject zero or negative dimensions', () => {\r\n\t\t\texpect(service.validateImageDimensions(0, 100)).toBe(false)\r\n\t\t\texpect(service.validateImageDimensions(100, 0)).toBe(false)\r\n\t\t\texpect(service.validateImageDimensions(-100, 100)).toBe(false)\r\n\t\t})\r\n\r\n\t\tit('should enforce total pixel limit', () => {\r\n\t\t\t// 8K limit: 7680 * 4320 = 33,177,600 pixels\r\n\t\t\texpect(service.validateImageDimensions(7680, 4320)).toBe(true)\r\n\t\t\texpect(service.validateImageDimensions(8000, 4500)).toBe(false) // Exceeds pixel limit\r\n\t\t})\r\n\t})\r\n})\r\n"],"names":["ConfigService","InputSanitizationService","Test","beforeEach","describe","expect","it","vi","service","configService","mockConfigService","getOptional","fn","module","createTestingModule","providers","provide","useValue","compile","get","mockImplementation","key","defaultValue","configs","default","jpeg","png","toBeDefined","input","result","sanitize","toBe","toBeNull","undefined","toBeUndefined","name","url","nested","value","toEqual","longString","repeat","length","toBeLessThanOrEqual","validateUrl","validateFileSize","validateImageDimensions"],"mappings":"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"}