{"version":3,"sources":["../../../../../src/test/Config/dto/app-config.dto.spec.ts"],"sourcesContent":["import { AppConfigDto } from '@microservice/Config/dto/app-config.dto'\r\nimport { plainToClass } from 'class-transformer'\r\nimport { validate } from 'class-validator'\r\nimport { describe, expect, it } from 'vitest'\r\nimport 'reflect-metadata'\n\r\ndescribe('appConfigDto', () => {\r\n\tdescribe('validation', () => {\r\n\t\tit('should validate with default values', async () => {\r\n\t\t\tconst dto = new AppConfigDto()\r\n\t\t\tconst errors = await validate(dto)\r\n\t\t\texpect(errors).toHaveLength(0)\r\n\t\t})\r\n\r\n\t\tit('should validate with valid configuration', async () => {\r\n\t\t\tconst validConfig = {\r\n\t\t\t\tserver: {\r\n\t\t\t\t\tport: 3003,\r\n\t\t\t\t\thost: '0.0.0.0',\r\n\t\t\t\t\tcors: {\r\n\t\t\t\t\t\torigin: '*',\r\n\t\t\t\t\t\tmethods: 'GET',\r\n\t\t\t\t\t\tmaxAge: 86400,\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tcache: {\r\n\t\t\t\t\tmemory: {\r\n\t\t\t\t\t\tmaxSize: 104857600,\r\n\t\t\t\t\t\tttl: 3600,\r\n\t\t\t\t\t\tcheckPeriod: 600,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tredis: {\r\n\t\t\t\t\t\thost: 'localhost',\r\n\t\t\t\t\t\tport: 6379,\r\n\t\t\t\t\t\tdb: 0,\r\n\t\t\t\t\t\tttl: 7200,\r\n\t\t\t\t\t\tmaxRetries: 3,\r\n\t\t\t\t\t\tretryDelayOnFailover: 100,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfile: {\r\n\t\t\t\t\t\tdirectory: './storage',\r\n\t\t\t\t\t\tmaxSize: 1073741824,\r\n\t\t\t\t\t\tcleanupInterval: 3600,\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tprocessing: {\r\n\t\t\t\t\tmaxConcurrent: 10,\r\n\t\t\t\t\ttimeout: 30000,\r\n\t\t\t\t\tretries: 3,\r\n\t\t\t\t\tmaxFileSize: 10485760,\r\n\t\t\t\t\tallowedFormats: ['jpg', 'jpeg', 'png', 'webp'],\r\n\t\t\t\t},\r\n\t\t\t\tmonitoring: {\r\n\t\t\t\t\tenabled: true,\r\n\t\t\t\t\tmetricsPort: 9090,\r\n\t\t\t\t\thealthPath: '/health',\r\n\t\t\t\t\tmetricsPath: '/metrics',\r\n\t\t\t\t},\r\n\t\t\t\texternalServices: {\r\n\t\t\t\t\tdjangoUrl: 'http://localhost:8000',\r\n\t\t\t\t\tnuxtUrl: 'http://localhost:3000',\r\n\t\t\t\t\trequestTimeout: 30000,\r\n\t\t\t\t\tmaxRetries: 3,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\r\n\t\t\tconst dto = plainToClass(AppConfigDto, validConfig)\r\n\t\t\tconst errors = await validate(dto)\r\n\t\t\texpect(errors).toHaveLength(0)\r\n\t\t})\r\n\r\n\t\tit('should fail validation with invalid server port', async () => {\r\n\t\t\tconst invalidConfig = {\r\n\t\t\t\tserver: {\r\n\t\t\t\t\tport: -1,\r\n\t\t\t\t\thost: '0.0.0.0',\r\n\t\t\t\t},\r\n\t\t\t}\r\n\r\n\t\t\tconst dto = plainToClass(AppConfigDto, invalidConfig)\r\n\t\t\tconst errors = await validate(dto)\r\n\t\t\texpect(errors.length).toBeGreaterThan(0)\r\n\r\n\t\t\tconst serverError = errors.find(error => error.property === 'server')\r\n\t\t\texpect(serverError).toBeDefined()\r\n\t\t})\r\n\r\n\t\tit('should fail validation with invalid cache configuration', async () => {\r\n\t\t\tconst invalidConfig = {\r\n\t\t\t\tcache: {\r\n\t\t\t\t\tmemory: {\r\n\t\t\t\t\t\tmaxSize: -1,\r\n\t\t\t\t\t\tttl: 0,\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t}\r\n\r\n\t\t\tconst dto = plainToClass(AppConfigDto, invalidConfig)\r\n\t\t\tconst errors = await validate(dto)\r\n\t\t\texpect(errors.length).toBeGreaterThan(0)\r\n\t\t})\r\n\r\n\t\tit('should fail validation with invalid external service URLs', async () => {\r\n\t\t\tconst invalidConfig = {\r\n\t\t\t\texternalServices: {\r\n\t\t\t\t\tdjangoUrl: 'invalid://url with spaces',\r\n\t\t\t\t\tnuxtUrl: 'not a url at all',\r\n\t\t\t\t\trequestTimeout: 30000,\r\n\t\t\t\t\tmaxRetries: 3,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\r\n\t\t\tconst dto = plainToClass(AppConfigDto, invalidConfig, {\r\n\t\t\t\tenableImplicitConversion: true,\r\n\t\t\t\texcludeExtraneousValues: false,\r\n\t\t\t})\r\n\t\t\tconst errors = await validate(dto, {\r\n\t\t\t\twhitelist: false,\r\n\t\t\t\tforbidNonWhitelisted: false,\r\n\t\t\t})\r\n\t\t\texpect(errors.length).toBeGreaterThan(0)\r\n\r\n\t\t\tconst externalServicesError = errors.find(error => error.property === 'externalServices')\r\n\t\t\texpect(externalServicesError).toBeDefined()\r\n\t\t\texpect(externalServicesError?.children).toBeDefined()\r\n\t\t\texpect(externalServicesError?.children?.length).toBeGreaterThan(0)\r\n\t\t})\r\n\t})\r\n\r\n\tdescribe('transformation', () => {\r\n\t\tit('should transform string values to appropriate types', async () => {\r\n\t\t\tconst stringConfig = {\r\n\t\t\t\tserver: {\r\n\t\t\t\t\tport: '3003',\r\n\t\t\t\t\tcors: {\r\n\t\t\t\t\t\tmaxAge: '86400',\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tcache: {\r\n\t\t\t\t\tmemory: {\r\n\t\t\t\t\t\tmaxSize: '104857600',\r\n\t\t\t\t\t\tttl: '3600',\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tmonitoring: {\r\n\t\t\t\t\tenabled: 'true',\r\n\t\t\t\t\tmetricsPort: '9090',\r\n\t\t\t\t},\r\n\t\t\t}\r\n\r\n\t\t\tconst dto = plainToClass(AppConfigDto, stringConfig, {\r\n\t\t\t\tenableImplicitConversion: true,\r\n\t\t\t})\r\n\r\n\t\t\texpect(typeof dto.server.port).toBe('number')\r\n\t\t\texpect(dto.server.port).toBe(3003)\r\n\t\t\texpect(typeof dto.server.cors.maxAge).toBe('number')\r\n\t\t\texpect(dto.server.cors.maxAge).toBe(86400)\r\n\t\t\texpect(typeof dto.cache.memory.maxSize).toBe('number')\r\n\t\t\texpect(dto.cache.memory.maxSize).toBe(104857600)\r\n\t\t\texpect(typeof dto.monitoring.enabled).toBe('boolean')\r\n\t\t\texpect(dto.monitoring.enabled).toBe(true)\r\n\t\t})\r\n\r\n\t\tit('should handle comma-separated allowed formats', async () => {\r\n\t\t\tconst configWithFormats = {\r\n\t\t\t\tprocessing: {\r\n\t\t\t\t\tallowedFormats: 'jpg,jpeg,png,webp,gif',\r\n\t\t\t\t},\r\n\t\t\t}\r\n\r\n\t\t\tconst dto = plainToClass(AppConfigDto, configWithFormats, {\r\n\t\t\t\tenableImplicitConversion: true,\r\n\t\t\t})\r\n\r\n\t\t\texpect(Array.isArray(dto.processing.allowedFormats)).toBe(true)\r\n\t\t\texpect(dto.processing.allowedFormats).toEqual(['jpg', 'jpeg', 'png', 'webp', 'gif'])\r\n\t\t})\r\n\t})\r\n})\r\n"],"names":["AppConfigDto","plainToClass","validate","describe","expect","it","dto","errors","toHaveLength","validConfig","server","port","host","cors","origin","methods","maxAge","cache","memory","maxSize","ttl","checkPeriod","redis","db","maxRetries","retryDelayOnFailover","file","directory","cleanupInterval","processing","maxConcurrent","timeout","retries","maxFileSize","allowedFormats","monitoring","enabled","metricsPort","healthPath","metricsPath","externalServices","djangoUrl","nuxtUrl","requestTimeout","invalidConfig","length","toBeGreaterThan","serverError","find","error","property","toBeDefined","enableImplicitConversion","excludeExtraneousValues","whitelist","forbidNonWhitelisted","externalServicesError","children","stringConfig","toBe","configWithFormats","Array","isArray","toEqual"],"mappings":"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"}