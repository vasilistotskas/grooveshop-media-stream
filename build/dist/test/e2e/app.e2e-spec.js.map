{"version":3,"sources":["../../../../src/test/e2e/app.e2e-spec.ts"],"sourcesContent":["import type { INestApplication } from '@nestjs/common'\r\nimport * as process from 'node:process'\r\nimport MediaStreamModule from '@microservice/media-stream.module'\r\nimport { Test, TestingModule } from '@nestjs/testing'\r\nimport request from 'supertest'\r\nimport { afterAll, beforeAll, describe, expect, it } from 'vitest'\r\n\r\ndescribe('MediaStreamModule (e2e)', () => {\r\n\tlet app: INestApplication\r\n\tlet moduleFixture: TestingModule\r\n\r\n\tbeforeAll(async () => {\r\n\t\t// Disable scheduled tasks in e2e tests\r\n\t\tprocess.env.DISABLE_CRON = 'true'\r\n\r\n\t\tmoduleFixture = await Test.createTestingModule({\r\n\t\t\timports: [MediaStreamModule],\r\n\t\t}).compile()\r\n\r\n\t\tapp = moduleFixture.createNestApplication()\r\n\t\tawait app.init()\r\n\t})\r\n\r\n\tafterAll(async () => {\r\n\t\t// Close the application first\r\n\t\ttry {\r\n\t\t\tif (app) {\r\n\t\t\t\tawait app.close()\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error) {\r\n\t\t\t// Ignore \"Connection is closed\" errors - they're expected in cleanup\r\n\t\t\tif (!(error instanceof Error) || !error.message.includes('Connection is closed')) {\r\n\t\t\t\tconsole.error('Error closing app:', error)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Close the module fixture\r\n\t\ttry {\r\n\t\t\tif (moduleFixture) {\r\n\t\t\t\tawait moduleFixture.close()\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (error) {\r\n\t\t\t// Ignore \"Connection is closed\" errors - they're expected in cleanup\r\n\t\t\tif (!(error instanceof Error) || !error.message.includes('Connection is closed')) {\r\n\t\t\t\tconsole.error('Error closing module:', error)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Give extra time for all async operations to complete\r\n\t\t// This includes Redis disconnection, Bull queue cleanup, and scheduled tasks\r\n\t\tawait new Promise(resolve => setTimeout(resolve, 1000))\r\n\t})\r\n\r\n\t// eslint-disable-next-line test/expect-expect\r\n\tit('/metrics (GET)', () => {\n\t\treturn request(app.getHttpServer())\r\n\r\n\t\t\t.get('/metrics')\r\n\r\n\t\t\t.expect(200)\r\n\r\n\t\t\t.expect('Content-Type', /text\\/plain/)\n\t})\r\n\r\n\tit('/metrics/health (GET)', () => {\n\t\treturn request(app.getHttpServer())\r\n\r\n\t\t\t.get('/metrics/health')\r\n\r\n\t\t\t.expect(200)\r\n\r\n\t\t\t.expect((res) => {\n\t\t\t\texpect(res.body).toHaveProperty('status')\r\n\r\n\t\t\t\texpect(res.body).toHaveProperty('timestamp')\r\n\r\n\t\t\t\texpect(res.body).toHaveProperty('service')\n\t\t\t})\n\t})\r\n\r\n\tit('/health/live (GET)', () => {\n\t\treturn request(app.getHttpServer())\r\n\r\n\t\t\t.get('/health/live')\r\n\r\n\t\t\t.expect(200)\r\n\r\n\t\t\t.expect((res) => {\n\t\t\t\texpect(res.body).toHaveProperty('status', 'alive')\r\n\r\n\t\t\t\texpect(res.body).toHaveProperty('uptime')\n\t\t\t})\n\t})\n})\r\n"],"names":["process","MediaStreamModule","Test","request","afterAll","beforeAll","describe","expect","it","app","moduleFixture","env","DISABLE_CRON","createTestingModule","imports","compile","createNestApplication","init","close","error","Error","message","includes","console","Promise","resolve","setTimeout","getHttpServer","get","res","body","toHaveProperty"],"mappings":"AACA,YAAYA,aAAa,eAAc;AACvC,OAAOC,uBAAuB,2CAAmC;AACjE,SAASC,IAAI,QAAuB,kBAAiB;AACrD,OAAOC,aAAa,YAAW;AAC/B,SAASC,QAAQ,EAAEC,SAAS,EAAEC,QAAQ,EAAEC,MAAM,EAAEC,EAAE,QAAQ,SAAQ;AAElEF,SAAS,2BAA2B;IACnC,IAAIG;IACJ,IAAIC;IAEJL,UAAU;QACT,uCAAuC;QACvCL,QAAQW,GAAG,CAACC,YAAY,GAAG;QAE3BF,gBAAgB,MAAMR,KAAKW,mBAAmB,CAAC;YAC9CC,SAAS;gBAACb;aAAkB;QAC7B,GAAGc,OAAO;QAEVN,MAAMC,cAAcM,qBAAqB;QACzC,MAAMP,IAAIQ,IAAI;IACf;IAEAb,SAAS;QACR,8BAA8B;QAC9B,IAAI;YACH,IAAIK,KAAK;gBACR,MAAMA,IAAIS,KAAK;YAChB;QACD,EACA,OAAOC,OAAO;YACb,qEAAqE;YACrE,IAAI,CAAEA,CAAAA,iBAAiBC,KAAI,KAAM,CAACD,MAAME,OAAO,CAACC,QAAQ,CAAC,yBAAyB;gBACjFC,QAAQJ,KAAK,CAAC,sBAAsBA;YACrC;QACD;QAEA,2BAA2B;QAC3B,IAAI;YACH,IAAIT,eAAe;gBAClB,MAAMA,cAAcQ,KAAK;YAC1B;QACD,EACA,OAAOC,OAAO;YACb,qEAAqE;YACrE,IAAI,CAAEA,CAAAA,iBAAiBC,KAAI,KAAM,CAACD,MAAME,OAAO,CAACC,QAAQ,CAAC,yBAAyB;gBACjFC,QAAQJ,KAAK,CAAC,yBAAyBA;YACxC;QACD;QAEA,uDAAuD;QACvD,6EAA6E;QAC7E,MAAM,IAAIK,QAAQC,CAAAA,UAAWC,WAAWD,SAAS;IAClD;IAEA,8CAA8C;IAC9CjB,GAAG,kBAAkB;QACpB,OAAOL,QAAQM,IAAIkB,aAAa,IAE9BC,GAAG,CAAC,YAEJrB,MAAM,CAAC,KAEPA,MAAM,CAAC,gBAAgB;IAC1B;IAEAC,GAAG,yBAAyB;QAC3B,OAAOL,QAAQM,IAAIkB,aAAa,IAE9BC,GAAG,CAAC,mBAEJrB,MAAM,CAAC,KAEPA,MAAM,CAAC,CAACsB;YACRtB,OAAOsB,IAAIC,IAAI,EAAEC,cAAc,CAAC;YAEhCxB,OAAOsB,IAAIC,IAAI,EAAEC,cAAc,CAAC;YAEhCxB,OAAOsB,IAAIC,IAAI,EAAEC,cAAc,CAAC;QACjC;IACF;IAEAvB,GAAG,sBAAsB;QACxB,OAAOL,QAAQM,IAAIkB,aAAa,IAE9BC,GAAG,CAAC,gBAEJrB,MAAM,CAAC,KAEPA,MAAM,CAAC,CAACsB;YACRtB,OAAOsB,IAAIC,IAAI,EAAEC,cAAc,CAAC,UAAU;YAE1CxB,OAAOsB,IAAIC,IAAI,EAAEC,cAAc,CAAC;QACjC;IACF;AACD"}